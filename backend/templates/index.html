<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#0b4a8f; --primary-2:#0f6ad8;
      --andamento:#ff9f1a; --finalizado:#1fb36a; --insucesso:#e23b3b;
      --warn:#fbbf24; --error:#ef4444; --ok:#10b981;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text); margin:0; display:flex; flex-direction:column; min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px;width:100%;flex:1}

    .app-header{background: linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); margin:0 0 12px 0}
    .app-title{margin:0; padding:20px 16px; text-align:center; font-size:26px; letter-spacing:.3px}

    .tabs{display:flex; gap:10px; justify-content:center; margin:12px 0 0}
    .tab{background:#fff; border:1px solid var(--border); color:#111827; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700; transition:transform .15s ease, box-shadow .2s ease}
    .tab:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.08) }
    .tab.active{ border-color: var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.12) }

    .legenda{display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin:16px 0 8px}
    .legenda-item{display:flex; align-items:center; gap:8px; font-weight:600; background:var(--card); padding:8px 12px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.06); border:1px solid var(--border)}
    .cor{width:16px;height:16px;border-radius:4px;display:inline-block}
    .cor.andamento{background:var(--andamento)} .cor.finalizado{background:var(--finalizado)} .cor.insucesso{background:var(--insucesso)}

    .form-container{background:var(--card); border:1px solid var(--border); padding:20px; margin:18px 0; border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .form-container h2{margin:0 0 12px; color:var(--primary)}
    .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .form-grid > .full{grid-column:1 / -1}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,button{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#111827; font-size:14px}
    button{background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer; letter-spacing:.2px}

    .badge-info{display:inline-block; background:#fff; border:1px dashed var(--border); color:#666; padding:8px 10px; border-radius:10px; font-size:13px; margin-top:8px}

    .table-card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.08); overflow:hidden}
    .grid{display:grid; grid-template-columns: 160px repeat(4, minmax(200px,1fr)); width:100%}
    .grid > div{border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:12px; min-height:72px; background:#fff}
    .header{background:#f8fafc; color:#0f172a; font-weight:800; text-transform:uppercase; text-align:center}

    .disparo{border-radius:12px; padding:12px; margin:8px 0; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.15); cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; animation:pop .2s ease-out both}
    .disparo:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(0,0,0,.22) }
    .status-andamento{ background:var(--andamento) } .status-finalizado{ background:var(--finalizado) } .status-insucesso{ background:var(--insucesso) }
    .badge{ font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.25); margin-bottom:6px; display:inline-block }
    .title{font-weight:800; font-size:14px; margin-bottom:4px} .meta{font-size:12px; opacity:.95}
    @keyframes pop{from{opacity:0; transform:translateY(4px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}

    .login-card{background:var(--card); border:1px solid var(--border); padding:20px; margin:18px auto; border-radius:14px; max-width:540px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .login-title{margin:0 0 12px; color:var(--primary); text-align:left; font-size:22px}
    .login-actions{display:flex; gap:10px; margin-top:12px}
    .btn-danger{background:#ef4444}

    .footer{width:100%; background:#fff; border-top:1px solid var(--border); color:#6b7280; font-size:13px; text-align:center; padding:14px 12px}

    /* Splash/Spinner */
    .splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:9999; transition:opacity .25s ease}
    .splash.hide{ opacity:0; pointer-events:none }
    .ring{ width:48px; height:48px; border:4px solid #e5e7eb; border-top-color:var(--primary-2); border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Toast center */
    .topbar{position:fixed; top:18px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:10000; pointer-events:none}
    .toast{pointer-events:auto; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; box-shadow:0 14px 32px rgba(0,0,0,.12); font-size:14px; display:flex; align-items:center; gap:10px; min-width:280px}
    .toast.warn{ border-color:#fde68a; background:#fffbeb } .toast.error{ border-color:#fecaca; background:#fff1f2 } .toast.ok{ border-color:#bbf7d0; background:#f0fdf4 }
    .toast button{background:transparent; color:#111; border:none; cursor:pointer; padding:0 4px; font-weight:700}

    /* Modal bonito */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.36); display:none; align-items:flex-start; justify-content:center; padding:32px 12px; z-index:9998}
    .modal-backdrop.show{display:flex}
    .modal-card{width:min(980px, 96%); background:#fff; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.25); border:1px solid var(--border); overflow:hidden}
    .modal-head{position:relative; background:linear-gradient(90deg,var(--primary),var(--primary-2)); padding:10px 16px 16px 16px; color:#fff; display:flex; align-items:center; gap:12px}
    .modal-title{font-weight:800; font-size:18px; flex:1}
    .close-btn{position:absolute; top:8px; right:8px; width:28px; height:28px; border-radius:999px; border:none; background:rgba(255,255,255,.2); color:#fff; cursor:pointer; font-weight:900}
    .close-btn:hover{background:rgba(255,255,255,.35)}
    .chips{display:flex; flex-wrap:wrap; gap:10px; padding:12px 16px}
    .chip{background:#eef2ff; border:1px solid #e5e7eb; color:#0f172a; border-radius:999px; padding:6px 10px; font-size:12px; font-weight:700}
    .chip.status.andamento{ background: #fff7ed; border-color:#ffedd5; color:#92400e}
    .chip.status.finalizado{ background: #ecfdf5; border-color:#d1fae5; color:#065f46}
    .chip.status.insucesso{ background: #fef2f2; border-color:#fee2e2; color:#991b1b}

    .modal-body{padding:0 16px 16px}
    .tpl-box{border:1px solid var(--border); border-radius:12px; padding:14px; min-height:140px; background:#fff; white-space:pre-wrap; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height:1.45}
    .modal-actions{display:flex; gap:12px; margin-top:12px}
    .btn-outline{background:#fff; color:#0f172a; border:1px solid var(--border)}
  </style>
</head>
<body>
  <div id="splash" class="splash"><div class="ring" aria-label="Carregando"></div></div>
  <div id="topbar" class="topbar" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <h1 class="app-title">Painel de Disparos</h1>
  </header>

  <div class="wrap">
    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="painel">Painel</button>
      <button class="tab" data-tab="login">Login</button>
    </nav>

    <!-- VIEW: PAINEL -->
    <section id="view-painel">
      <div class="legenda">
        <div class="legenda-item"><span class="cor andamento"></span> Em andamento</div>
        <div class="legenda-item"><span class="cor finalizado"></span> Finalizado</div>
        <div class="legenda-item"><span class="cor insucesso"></span> Insucesso</div>
      </div>

      <!-- Form (s√≥ logado) -->
      <div id="form-wrapper" class="form-container" style="display:none;">
        <h2>Novo Disparo</h2>
        <form id="formDisparo" class="form-grid">
          <div>
            <label for="tipo">Nome do Disparo</label>
            <input type="text" id="tipo" placeholder="Ex.: Disparo D0" required />
          </div>

          <div>
            <label for="template">Template (opcional)</label>
            <select id="template">
              <option value="">(sem template)</option>
              <option value="preventivo_d0">Preventivo D0</option>
              <option value="preventivo_d3_d10">Preventivo D3 e D10</option>
              <option value="vencidos_1">Vencidos 1</option>
              <option value="vencidos_2">Vencidos 2</option>
              <option value="vencidos_5">Vencidos 5</option>
            </select>
          </div>

          <div>
            <label for="tempo">Tempo M√©dio (min)</label>
            <input type="number" id="tempo" min="0" required />
          </div>

          <div>
            <label for="potes">Quantidade de Potes</label>
            <input type="number" id="potes" min="1" required />
          </div>

          <div>
            <label for="volume">Volume de Disparos</label>
            <input type="number" id="volume" min="0" value="0" />
          </div>

          <div>
            <label for="horario">Hor√°rio</label>
            <select id="horario" required>
              <option value="08:00">08:00</option>
              <option value="12:00">12:00</option>
              <option value="16:00">16:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>

          <div class="full">
            <button type="submit">Adicionar</button>
          </div>
        </form>
      </div>

      <!-- Aviso quando deslogado -->
      <div id="readOnlyHint" class="badge-info" style="display:none; text-align:center;">
        Voc√™ est√° em <strong>modo leitura</strong>. Fa√ßa login para adicionar/alterar disparos.
      </div>

      <!-- Tabela -->
      <div class="table-card" style="margin-top:14px;">
        <div class="grid" id="painel-grid">
          <div class="header">Hor√°rio</div>
          <div class="header">08:00</div>
          <div class="header">12:00</div>
          <div class="header">16:00</div>
          <div class="header">20:00</div>

          <div class="header">Disparos</div>
          <div id="col-08"></div>
          <div id="col-12"></div>
          <div id="col-16"></div>
          <div id="col-20"></div>
        </div>
      </div>
    </section>

    <!-- VIEW: LOGIN -->
    <section id="view-login" style="display:none;">
      <div class="login-card">
        <h2 class="login-title">Acessar</h2>
        <form id="loginForm">
          <label for="loginUser">Usu√°rio</label>
          <input type="text" id="loginUser" placeholder="usu√°rio" required value="" />
          <label for="loginPass" style="margin-top:10px;">Senha</label>
          <input type="password" id="loginPass" placeholder="senha" required value="" />
          <div class="login-actions">
            <button type="submit" id="btnLogin">Entrar</button>
            <button type="button" id="btnLogout" class="btn-danger">Sair</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <footer class="footer">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <!-- MODAL -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="m-title">Detalhes</div>
        <button class="close-btn" id="m-close" aria-label="Fechar">√ó</button>
      </div>
      <div class="chips">
        <span class="chip status" id="m-status">Status</span>
        <span class="chip">Hor√°rio: <b id="m-horario">--:--</b></span>
        <span class="chip">Potes: <b id="m-potes">0</b></span>
        <span class="chip">Volume: <b id="m-volume">0</b></span>
        <span class="chip">Tempo m√©dio: <b id="m-tempo">0</b> min</span>
        <span class="chip">Tempo restante: <b id="m-restante">0</b> min</span>
      </div>
      <div class="modal-body">
        <div style="font-weight:800; margin:6px 0 8px">Template: <span id="m-tpl-name">‚Äî</span></div>
        <div id="m-tpl-body" class="tpl-box">(Sem template associado a este disparo)</div>

        <div class="modal-actions">
          <button id="copyTpl" class="btn-outline">Copiar template</button>
          <button id="copyResumo" class="btn-outline">Copiar resumo</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========================== CONFIG ========================== */
const API_BASE = "";
const IS_FILE = location.protocol === "file:";
const FORCE_OFFLINE = (new URLSearchParams(location.search)).get("offline") === "1";
let OFFLINE_MODE = IS_FILE || FORCE_OFFLINE;

const BASE = (API_BASE || "").replace(/\/+$/,"");
const url = (p) => `${BASE}${p}`;

/* ====================== SPLASH & TOASTS ===================== */
const splash = document.getElementById("splash");
const hideSplashSoon = () => { splash?.classList.add("hide"); setTimeout(()=>{ try{splash.remove();}catch{} }, 300); };
const splashTimer = setTimeout(hideSplashSoon, 1200);
addEventListener("error", hideSplashSoon);
addEventListener("unhandledrejection", hideSplashSoon);

const topbar = document.getElementById("topbar");
const toasts = new Set();
function toast(msg, type="warn", ms=3200, key=null){
  if (key && toasts.has(key)) return;
  const div = document.createElement("div");
  div.className = `toast ${type}`;
  div.innerHTML = `<span>${msg}</span><button aria-label="fechar">√ó</button>`;
  const btn = div.querySelector("button");
  btn.onclick = ()=> { div.remove(); if (key) toasts.delete(key); };
  topbar.appendChild(div);
  if (key) toasts.add(key);
  setTimeout(()=>{ try{btn.click()}catch{} }, ms);
}

/* ============================ AUTH =========================== */
const AUTH_KEY = "painel_auth_ok";
let isAuthed = localStorage.getItem(AUTH_KEY) === "1";

function updateAuthUI(){
  const formWrap = document.getElementById("form-wrapper");
  const hint = document.getElementById("readOnlyHint");
  if(isAuthed){
    formWrap.style.display = "";
    hint.style.display = "none";
  }else{
    formWrap.style.display = "none";
    hint.style.display = "";
  }
}

/* ============================ TABS =========================== */
const tabs = document.querySelectorAll(".tab");
function switchTab(name){
  tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
  document.getElementById("view-painel").style.display = (name==="painel") ? "" : "none";
  document.getElementById("view-login").style.display  = (name==="login") ? "" : "none";
  if (name === "login") setTimeout(()=>document.getElementById("loginUser")?.focus(), 50);
}
tabs.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

/* ===================== Templates (keys = Airtable) ===================== */
const TEMPLATES = {
  preventivo_d0: {
    label: "Preventivo D0",
    body: `Ol√° $[nome]!üòä

Seu boleto vence Hoje! Para facilitar vamos encaminhar ele novamente por aqui. 
Clique no documento para ver seu consumo de energia e o c√≥digo de barras.(Caso j√° tenha pago √© s√≥ desconsiderar)

*Valor* R$: $[valor]
*Vencimento* : $[data_vencimento]

üìû Este √© nosso n√∫mero oficial de atendimento. Caso tenha alguma d√∫vida √© s√≥ entrar em contato por aqui, combinado? üëç 

Energia de TODOS: Faz bem para o seu bolso e para o planeta!üåé üíö`
  },
  preventivo_d3_d10: {
    label: "Preventivo D3 e D10",
    body: `Ol√° $[nome]!üòä 

Seu boleto vence em $[data_vencimento]! Para facilitar vamos encaminhar ele novamente por aqui. 
Clique no documento para ver seu consumo de energia e o c√≥digo de barras (Caso j√° tenha pago √© s√≥ desconsiderar). 

*Valor* R$ : $[valor]

üìû Este √© nosso n√∫mero oficial de atendimento. Caso tenha alguma d√∫vida √© s√≥ entrar em contato por aqui, combinado? üëç 

Energia de TODOS: A Energia que Retorna!üåé`
  },
  vencidos_1: {
    label: "Vencidos 1",
    body: `Ol√° $[nome]!üòä 

*ATEN√á√ÉO! Sua conta de energia venceu h√° $[dias_vencidos] dias atr√°s e n√£o identificamos seu pagamento* 

*Valor* R$ :$[valor]
*Vencimento* : $[data_vencimento]

*Aten√ß√£o*: n√£o deixe de pagar em dia suas faturas para evitar juros e continuar economizando! (Favor desconsiderar essa mensagem, caso j√° tenha pago). 

üëâ Caso n√£o tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo! 

Clique no documento para ver seu consumo de energia e o c√≥digo de barras. 

‚ùó Caso tenha d√∫vida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* üåéüíö`
  },
  vencidos_2: {
    label: "Vencidos 2",
    body: `Ol√° $[nome]!üòä 

*ATEN√á√ÉO! Sua conta de energia venceu h√°  $[dias_vencidos]  dias atr√°s e n√£o identificamos seu pagamento* 

Por conta disso poder√° haver a suspens√£o de energia solar. A boa not√≠cia √© que ainda h√° chances de regularizar antes que isso aconte√ßa.  (Favor desconsiderar essa mensagem, caso j√° tenha pago). 

*Valor* R$ :  $[valor]
*Vencimento* : $[data_vencimento]

üëâ Caso n√£o tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo! 

Clique no documento para ver seu consumo de energia e o c√≥digo de barras. 

‚ùó Caso tenha d√∫vida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* üåéüíö`
  },
  vencidos_5: {
    label: "Vencidos 5",
    body: `Ol√° $[nome]!üòä

‚ö† At√© o momento n√£o identificamos o pagamento do seu d√©bito com a Energia de TODOS. Ap√≥s v√°rias tentativas de contato e de negocia√ß√£o sem sucesso, encaminhamos o seu cadastro ao Servi√ßo de Prote√ß√£o ao Cr√©dito - SPC.

üëâ Quantidade de boletos sem pagamento:  $[quantidade_boletos]
üëâ Valor pendente: R$  $[valor]

Queremos escutar a sua proposta! üëâ Para conhecer nossas op√ß√µes de parcelamento, fale abaixo com nossos atendentes.

üìû Este √© nosso n√∫mero oficial de atendimento via WhatsApp. Se tiver alguma d√∫vida √© s√≥ entrar em contato por aqui, combinado? üëç

*Mais Sol, Energia e Economia para TODOS* üåéüíö`
  }
};
const tplLabel = key => (TEMPLATES[key]?.label || "‚Äî");
const tplBody  = key => (TEMPLATES[key]?.body  || "(Sem template associado a este disparo)");

/* ============================ UTILS ========================== */
function clsForStatus(status){
  const s = (status||"").toLowerCase();
  if (s.includes("final")) return "status-finalizado";
  if (s.includes("insu")) return "status-insucesso";
  return "status-andamento";
}
function uid(){ return "tmp_" + Math.random().toString(36).slice(2); }
function calcHash(records){
  try{
    return (records||[]).map(r => `${r.id}|${r.tipo}|${r.status}|${r.horario}|${r.tempo}|${r.potes}|${r.volume||0}|${r.template||""}`).join("¬ß");
  }catch{ return Math.random().toString(36); }
}
function fetchWithTimeout(resource, options = {}, timeout = 3000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  return fetch(resource, { ...options, signal: controller.signal }).finally(() => clearTimeout(id));
}

/* =========================== RENDER ========================== */
function clearColumns(){
  ["08","12","16","20"].forEach(h => {
    const el = document.getElementById("col-"+h);
    if (el) el.innerHTML = "";
  });
}

function openModalFor(rec){
  const modal = document.getElementById("modal");
  document.getElementById("m-title").textContent = rec.tipo || "Detalhes";
  const st = (rec.status || "Em andamento").toLowerCase();
  const stChip = document.getElementById("m-status");
  stChip.textContent = rec.status || "Em andamento";
  stChip.className = `chip status ${st.includes("final")?'finalizado':st.includes('insu')?'insucesso':'andamento'}`;

  document.getElementById("m-horario").textContent = rec.horario || "--:--";
  document.getElementById("m-potes").textContent   = rec.potes ?? 0;
  document.getElementById("m-volume").textContent  = rec.volume ?? 0;
  document.getElementById("m-tempo").textContent   = rec.tempo ?? 0;
  const restante = ((Number(rec.potes)||0) * (Number(rec.tempo)||0));
  document.getElementById("m-restante").textContent = restante;

  document.getElementById("m-tpl-name").textContent = tplLabel(rec.template);
  document.getElementById("m-tpl-body").textContent = tplBody(rec.template);

  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
}
document.getElementById("m-close").addEventListener("click", ()=> {
  const modal = document.getElementById("modal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
});
document.getElementById("modal").addEventListener("click", (e)=>{
  if (e.target.id === "modal") document.getElementById("m-close").click();
});

function cardTemplate(r){
  const div = document.createElement("div");
  div.className = `disparo ${clsForStatus(r.status)}`;
  div.dataset.id = r.id || uid();
  div.dataset.status = r.status || "Em andamento";
  div.dataset.horario = r["horario"] || "08:00";
  div.dataset.template = r.template || "";

  div.innerHTML = `
    <span class="badge">${r.status || "Em andamento"}</span>
    <div class="title">${r.tipo || ""}</div>
    <div class="meta">Tempo m√©dio: <strong>${r.tempo ?? 0} min</strong> ‚Ä¢ Potes: <strong>${r.potes ?? 0}</strong> ‚Ä¢ Vol: <strong>${r.volume ?? 0}</strong></div>
  `;

  div.addEventListener("click", () => openModalFor(r));
  return div;
}

function placeRecord(r){
  const hh = (r["horario"] || "08:00").split(":")[0];
  const col = document.getElementById("col-"+hh);
  if (col) col.appendChild(cardTemplate(r));
}

function renderSnapshot(records){
  clearColumns();
  (records||[]).forEach(r => placeRecord(r));
}

/* ============= Data (Cache + SSE + Polling Backoff) ========= */
const CACHE_KEY = "painel_snapshot_v2";
const CACHE_TTL_MS = 1000 * 60 * 60 * 6;
let lastNonEmpty = [];
let lastHash = "";
let sse = null;
let pollTimer = null;
let backoffMs = 5000;
let gotFirstPaint = false;

(function paintFromCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return;
    const {ts, data} = JSON.parse(raw);
    if (!data || (Date.now() - ts) > CACHE_TTL_MS) return;
    lastNonEmpty = data;
    lastHash = calcHash(data);
    renderSnapshot(data);
    clearTimeout(splashTimer);
    hideSplashSoon();
    gotFirstPaint = true;
  }catch{}
})();

function saveCache(records){
  try{
    const payload = { ts: Date.now(), data: records };
    (window.requestIdleCallback || setTimeout)(() =>
      localStorage.setItem(CACHE_KEY, JSON.stringify(payload)), 0
    );
  }catch{}
}

/* >>>>>>> ALTERADO: agora aceita allowEmpty para refletir dele√ß√µes <<<<<< */
function safeRender(records, {allowEmpty=false} = {}){
  const incomingHash = calcHash(records);
  if (incomingHash === lastHash) return;

  // antes bloqueava "empty" quando j√° t√≠nhamos dados ‚Äî isso impedia dele√ß√£o
  if (!allowEmpty && (records?.length || 0) === 0 && (lastNonEmpty?.length || 0) > 0) {
    return;
  }

  renderSnapshot(records);
  lastHash = incomingHash;
  // atualiza estado/cache mesmo que vazio (para limpar tela)
  lastNonEmpty = records || [];
  saveCache(lastNonEmpty);

  if (!gotFirstPaint){ gotFirstPaint = true; clearTimeout(splashTimer); hideSplashSoon(); }
}

async function loadInitial(){
  if (OFFLINE_MODE) return;
  try{
    const resp = await fetchWithTimeout(url("/api/disparos"), {cache:"no-store", credentials:"include"}, 3000);
    if (!resp.ok) throw new Error(resp.status);
    const data = await resp.json();
    // permite vazio (se tudo foi apagado)
    safeRender(data, {allowEmpty:true});
  }catch(e){
    // silencioso
  }
}

async function softRefresh(){
  if (OFFLINE_MODE) return;
  try{
    const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
    if (!resp.ok) return;
    const data = await resp.json();
    safeRender(data, {allowEmpty:true});
  }catch{}
}

function startPolling(){
  if (OFFLINE_MODE) return;
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
      if (resp.ok){
        const data = await resp.json();
        safeRender(data, {allowEmpty:true});
        backoffMs = Math.max(5000, Math.floor(backoffMs/2));
      }
    }catch{}
  }, backoffMs);
  backoffMs = Math.min(backoffMs * 2, 30000);
}

function startSSE(){
  if (OFFLINE_MODE) return;
  try{
    if (sse) sse.close();
    sse = new EventSource(url("/api/stream"));
    sse.onmessage = (evt) => {
      try{
        const payload = JSON.parse(evt.data);
        if (payload.type === "snapshot") {
          // permite vazio ‚Äî garante que dele√ß√µes reflitam imediatamente
          safeRender(payload.records || [], {allowEmpty:true});
        }
      }catch{}
    };
    sse.onerror = () => { startPolling(); };
  }catch{
    startPolling();
  }
}

/* ======================== FORM ADD ========================== */
const form = document.getElementById("formDisparo");
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const tipo  = document.getElementById("tipo").value.trim();
  const tempo = Number(document.getElementById("tempo").value);
  const potes = Number(document.getElementById("potes").value);
  const volume= Number(document.getElementById("volume").value || 0);
  const horario = document.getElementById("horario").value;
  const template = document.getElementById("template").value || "";

  if(!tipo) return;

  const optimisticRecord = { id: uid(), tipo, tempo, potes, volume, horario, status:"Em andamento", template };
  (lastNonEmpty = lastNonEmpty || []).push(optimisticRecord);
  safeRender(lastNonEmpty, {allowEmpty:true});

  if (OFFLINE_MODE) { e.target.reset(); return; }
  if(!isAuthed){
    toast("Voc√™ est√° em modo leitura. Fa√ßa login para adicionar.", "warn", 3500, "readonly-add");
    lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
    safeRender(lastNonEmpty, {allowEmpty:true});
    return;
  }

  try{
    const resp = await fetch(url("/api/disparos"), {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      credentials:"include",
      body:JSON.stringify(optimisticRecord)
    });
    if (!resp.ok){
      if (resp.status === 401){
        toast("Sess√£o expirada. Fa√ßa login novamente.", "warn", 4000, "sessao");
        isAuthed = false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
      }else{
        const t = await resp.text().catch(()=> "");
        toast("N√£o consegui salvar no servidor.", "error");
        console.warn("POST falhou:", resp.status, t);
      }
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      safeRender(lastNonEmpty, {allowEmpty:true});
    } else {
      e.target.reset();
      setTimeout(softRefresh, 400);
      toast("Disparo criado!", "ok", 2200);
    }
  }catch{
    toast("Falha de rede ao salvar.", "error");
    lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
    safeRender(lastNonEmpty, {allowEmpty:true});
  }
});

/* ====================== LOGIN / LOGOUT ====================== */
const loginForm = document.getElementById("loginForm");
const btnLogin  = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const u = (document.getElementById("loginUser").value || "").trim();
  const p = (document.getElementById("loginPass").value || "").trim();
  if (!u || !p){ return; }
  btnLogin.disabled = true;

  if (u !== "energia" || p !== "energia1") {
    toast("Usu√°rio ou senha inv√°lidos.", "error");
    btnLogin.disabled = false;
    return;
  }

  isAuthed = true; localStorage.setItem(AUTH_KEY, "1"); updateAuthUI(); switchTab("painel");

  try{
    const r = await fetch(url("/api/login"), {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify({ username:u, password:p })
    });
    if (!r.ok){
      toast("N√£o consegui criar sess√£o segura no servidor. Tente novamente mais tarde.", "warn");
    }else{
      setTimeout(softRefresh, 150);
    }
  }catch{
    toast("Rede inst√°vel ao criar sess√£o. Continuando em modo UI.", "warn");
  }finally{
    btnLogin.disabled = false;
  }
});

btnLogout.addEventListener("click", () => {
  isAuthed = false; localStorage.removeItem(AUTH_KEY);
  updateAuthUI(); switchTab("login");
  try{ fetch(url("/api/logout"), { method:"POST", credentials:"include" }); }catch{}
});

/* ================== COPIAR TEMPLATE/RESUMO ================== */
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(
    ()=> toast("Copiado para a √°rea de transfer√™ncia!", "ok", 1800),
    ()=> {
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy"); ta.remove();
      toast("Copiado!", "ok", 1800);
    }
  );
}
document.getElementById("copyTpl").addEventListener("click", ()=>{
  copyToClipboard(document.getElementById("m-tpl-body").textContent || "");
});
document.getElementById("copyResumo").addEventListener("click", ()=>{
  const tipo = document.getElementById("m-title").textContent.trim();
  const st   = document.getElementById("m-status").textContent.trim();
  const hor  = document.getElementById("m-horario").textContent.trim();
  const pt   = document.getElementById("m-potes").textContent.trim();
  const vol  = document.getElementById("m-volume").textContent.trim();
  const tm   = document.getElementById("m-tempo").textContent.trim();
  const rest = document.getElementById("m-restante").textContent.trim();
  const tplN = document.getElementById("m-tpl-name").textContent.trim();

  const resumo =
`Status: ${st}
Hor√°rio: ${hor} ‚Ä¢ Potes: ${pt} ‚Ä¢ Volume: ${vol}
Tempo m√©dio: ${tm} min ‚Ä¢ Tempo restante: ${rest} min
Template: ${tplN}
Disparo: ${tipo}`;
  copyToClipboard(resumo);
});

/* ========================== START =========================== */
(async () => {
  switchTab("painel");
  updateAuthUI();

  if (OFFLINE_MODE) { clearTimeout(splashTimer); hideSplashSoon(); return; }

  startSSE();
  loadInitial();
})();
</script>
</body>
</html>
