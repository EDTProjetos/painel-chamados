<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
  :root{
    --bg:#f4f6f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
    --primary:#0b4a8f; --primary-2:#0f6ad8;
    --accent-1:#0f6ad8; --accent-2:#10b981; --accent-3:#f97316;
    --andamento:#ff9f1a; --finalizado:#1fb36a; --insucesso:#e23b3b;
    --warn:#fbbf24; --error:#ef4444; --ok:#10b981;
  }
  html.dark {
      --bg: #0f172a;
      --card: #1f2937;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --border: #273249;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg); color: var(--text); margin:0; display:flex; flex-direction:column; min-height:100vh;
    position:relative; overflow-x:hidden;
    transition: background-color .3s, color .3s;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(1100px circle at 15% -10%, rgba(15,106,216,.18), transparent 60%),
      radial-gradient(820px circle at 90% 0%, rgba(16,185,129,.18), transparent 65%),
      linear-gradient(180deg, rgba(255,255,255,.92), rgba(244,246,249,.96));
    transition: opacity .3s ease;
  }
  html.dark body::before{
    background:
      radial-gradient(900px circle at 12% -10%, rgba(37,99,235,.25), transparent 58%),
      radial-gradient(800px circle at 85% 5%, rgba(16,185,129,.18), transparent 62%),
      linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.96));
  }
  body > *{position:relative; z-index:1;}
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px 56px;width:100%;flex:1}

  .app-header{margin:0;padding:24px 16px 0}
  .app-banner{
    display:flex; align-items:center; justify-content:space-between; gap:18px;
    background:var(--card); border:1px solid rgba(15,106,216,.18); border-radius:22px;
    box-shadow:0 24px 40px -24px rgba(15,106,216,.45);
    padding:24px 28px; position:relative; overflow:hidden;
  }
  .app-banner::after{
    content:""; position:absolute; inset:auto -70px -80px auto; width:220px; height:220px;
    background:radial-gradient(circle at center, rgba(15,106,216,.28) 0%, transparent 70%);
    opacity:.65; transform:rotate(-12deg);
  }
  html.dark .app-banner{border-color:rgba(37,99,235,.35); box-shadow:0 28px 55px -30px rgba(15,23,42,.9);}
  html.dark .app-banner::after{background:radial-gradient(circle at center, rgba(37,99,235,.35) 0%, transparent 70%);}
  .brand{display:flex; align-items:center; gap:16px;}
  .brand-icon{
    width:60px; height:60px; border-radius:20px; display:grid; place-items:center; color:#fff;
    background:linear-gradient(135deg,var(--primary),var(--primary-2));
    box-shadow:0 18px 32px -18px rgba(15,106,216,.6);
  }
  .brand-icon svg{width:30px; height:30px;}
  .app-title{margin:0; font-size:26px; letter-spacing:.3px; color:var(--text);}
  .app-subtitle{margin:4px 0 0; color:var(--muted); font-size:14px;}
  .header-actions{display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:flex-end;}
  .header-nav{display:flex; align-items:center; gap:8px;}
  .header-chip{
    background:rgba(15,106,216,.12); color:var(--primary);
    border-radius:999px; padding:8px 14px; font-weight:600; font-size:12px;
    border:1px solid rgba(15,106,216,.18);
    display:flex; align-items:center; gap:6px;
  }
  .header-chip svg{width:16px; height:16px;}
  html.dark .header-chip{background:rgba(37,99,235,.18); color:#bfdbfe; border-color:rgba(59,130,246,.35);}

  /* Theme Toggle */
  .theme-toggle-wrap { display:flex; justify-content:flex-end; padding-top: 12px; }
  .theme-toggle {
      background: rgba(226,232,240,.9);
      border: 1px solid var(--border);
      color: var(--text);
      width: 40px; height: 40px;
      border-radius: 999px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; padding: 0;
      transition: background .2s, transform .2s, border-color .2s;
  }
  .theme-toggle:hover { transform: scale(1.05); }
  .theme-toggle svg { width: 20px; height: 20px; }
  html.dark .theme-toggle { background: #374151; color: var(--text); }
  html.dark .theme-toggle:hover { background: #4b5563; }

  .tabs{display:flex; gap:12px; justify-content:center; margin:16px 0 0; flex-wrap:wrap}
  .tab{
    background:var(--card); border:1px solid var(--border); color:var(--text);
    padding:6px 14px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px; letter-spacing:.15px;
    display:inline-flex; align-items:center; gap:6px; line-height:1.2;
    transition:transform .15s ease, box-shadow .2s ease, background-color .2s, color .2s, border-color .2s;
  }
  .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 12px rgba(15,106,216,.15) }
  .tab.active{ border-color: var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.16); background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; }
  .tab svg{width:16px; height:16px;}

  .metrics{display:grid; grid-template-columns:repeat(auto-fit, minmax(210px,1fr)); gap:16px; margin:22px 0 14px;}
  .metric-card{
    background:var(--card); border:1px solid rgba(15,106,216,.12); border-radius:18px; padding:18px 20px;
    box-shadow:0 22px 38px -26px rgba(15,106,216,.55); position:relative; overflow:hidden;
    display:flex; flex-direction:column; gap:10px; min-height:140px;
  }
  .metric-card::after{
    content:""; position:absolute; inset:auto -40px -80px auto; width:160px; height:160px; border-radius:40%;
    background:radial-gradient(circle, rgba(15,106,216,.22) 0%, transparent 70%);
    opacity:.6; z-index:0;
  }
    .metric-card.content-success::after{background:radial-gradient(circle, rgba(16,185,129,.24) 0%, transparent 70%);}
    .metric-card.content-warn::after{background:radial-gradient(circle, rgba(249,115,22,.24) 0%, transparent 70%);}
    .metric-card.content-error::after{background:radial-gradient(circle, rgba(220,38,38,.24) 0%, transparent 70%);}
  html.dark .metric-card{border-color:rgba(59,130,246,.25); box-shadow:0 30px 55px -32px rgba(15,23,42,.9);}
  html.dark .metric-card::after{opacity:.35;}
  .metric-card.budget-card::after{
    background:radial-gradient(circle, rgba(124,58,237,.28) 0%, transparent 70%);
  }
  html.dark .metric-card.budget-card::after{opacity:.42;}
  .metric-card.budget-card .metric-value{
    font-size:clamp(26px,4.5vw,38px);
    word-break:break-word;
  }
  .metric-icon{width:42px; height:42px; border-radius:14px; display:grid; place-items:center; color:#fff; z-index:1;}
  .metric-icon svg{width:22px; height:22px;}
  .icon-total{background:linear-gradient(135deg,var(--primary),var(--primary-2));}
  .icon-progress{background:linear-gradient(135deg,#f59e0b,#f97316);}
  .icon-done{background:linear-gradient(135deg,#059669,#10b981);}
  .icon-error{background:linear-gradient(135deg,#dc2626,#ef4444);}
  .icon-budget{background:linear-gradient(135deg,#7c3aed,#6366f1); font-weight:700; font-size:18px;}
  .metric-label{font-size:12px; letter-spacing:.15em; text-transform:uppercase; color:var(--muted); z-index:1;}
  .metric-value{font-size:34px; font-weight:300; line-height:1; z-index:1;}
  .metric-foot{font-size:13px; color:var(--muted); margin-top:auto; z-index:1;}
  html.dark .metric-label, html.dark .metric-foot{color:#9ca3af;}

  .legenda{display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:12px 0 6px}
  .legenda-item{display:flex; align-items:center; gap:8px; font-weight:600; background:var(--card); padding:6px 10px; border-radius:12px; box-shadow:0 12px 28px -22px rgba(15,106,216,.65); border:1px solid var(--border); font-size:13px}
  html.dark .legenda-item{border-color:rgba(59,130,246,.25); box-shadow:0 14px 30px -24px rgba(15,23,42,.9);}
  .cor{width:12px;height:12px;border-radius:3px;display:inline-block}
  .cor.andamento{background:var(--andamento)} .cor.finalizado{background:var(--finalizado)} .cor.insucesso{background:var(--insucesso)}

  .form-container{background:var(--card); border:1px solid var(--border); padding:22px; margin:20px 0; border-radius:18px; box-shadow:0 25px 45px -30px rgba(15,106,216,.45); backdrop-filter:blur(4px)}
  html.dark .form-container{background:rgba(17,24,39,.92); border-color:rgba(59,130,246,.25);}
  .form-container h2{margin:0 0 12px; color:var(--primary); font-size:18px}
  html.dark .form-container h2{color:#93c5fd;}
  .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
  .form-grid > .full{grid-column:1 / -1}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
  input,select,button{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
    background:rgba(255,255,255,.88); color:var(--text); font-size:13px;
    transition:border-color .2s ease, box-shadow .2s ease, background-color .2s;
  }
  .tempo-group{
    display:flex; align-items:center; gap:6px; border:1px solid var(--border);
    border-radius:12px; padding:6px 10px; background:rgba(255,255,255,.88);
  }
  .tempo-group input{
    width:60px; border:none; padding:4px 6px; background:transparent; text-align:center; font-weight:600;
  }
  .tempo-group input[type="number"]::-webkit-outer-spin-button,
  .tempo-group input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .tempo-group input[type="number"]{ -moz-appearance: textfield; }
  .tempo-sep{font-size:12px; color:var(--muted); font-weight:600;}
  html.dark input, html.dark select {
    background: #1f2937;
    border-color: #374151;
    color:var(--text);
  }
  html.dark .tempo-group{background:#1f2937; border-color:#374151;}
  html.dark .tempo-group input{color:var(--text);}
  input:focus, select:focus{outline:none; border-color:var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.15); background:#fff;}
  .tempo-group:focus-within{border-color:var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.15);}
  .tempo-group input:focus{outline:none; box-shadow:none;}
  html.dark input:focus, html.dark select:focus{background:#111827;}
  button{background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer; letter-spacing:.2px; box-shadow:0 16px 28px -20px rgba(15,106,216,.6); transition:transform .2s ease, box-shadow .2s ease;}
  button:hover{transform:translateY(-1px); box-shadow:0 20px 36px -22px rgba(15,106,216,.6);}

  .badge-info{display:inline-block; background:rgba(15,106,216,.08); border:1px dashed rgba(15,106,216,.2); color:var(--muted); padding:6px 10px; border-radius:12px; font-size:12px; margin-top:6px}
  html.dark .badge-info{background:rgba(37,99,235,.18); border-color:rgba(59,130,246,.35); color:#bfdbfe;}

  .table-card{background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 26px 50px -32px rgba(15,106,216,.45); overflow:hidden; backdrop-filter:blur(4px)}
  html.dark .table-card{background:rgba(17,24,39,.95); border-color:rgba(59,130,246,.25);}
  .grid{display:grid; grid-template-columns: 140px repeat(4, minmax(180px,1fr)); width:100%; position:relative}
  .grid::after{
    content:""; position:absolute; inset:0; background:linear-gradient(135deg, rgba(15,106,216,.04), transparent 70%);
    pointer-events:none;
  }
  .grid > div{border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:12px; min-height:68px; background:rgba(255,255,255,.9); position:relative; z-index:1}
  html.dark .grid > div{background:rgba(15,23,42,.92); border-color:rgba(59,130,246,.25);}
  .header{background:rgba(15,106,216,.08); color:#0f172a; font-weight:800; text-transform:uppercase; text-align:center; font-size:12px}
  html.dark .header { background: rgba(37,99,235,.18); color: #d1d5db; }

  .disparo{border-radius:14px; padding:12px; margin:8px 0; color:#fff; box-shadow:0 10px 22px -12px rgba(0,0,0,.4); cursor:pointer;transition:transform .15s ease, box-shadow .2s ease; animation:pop .18s ease-out both; font-size:13px; position:relative;}
  .disparo:hover{ transform:translateY(-4px); box-shadow:0 20px 28px -18px rgba(0,0,0,.35) }
  .disparo[draggable="true"]{ cursor:grab; }
  .disparo.dragging{ opacity:.6; transform:scale(.98); box-shadow:0 16px 30px -16px rgba(0,0,0,.45); }
  .disparo[aria-busy="true"]{ filter:grayscale(.25); opacity:.75; cursor:wait }
  .status-andamento{ background:var(--andamento) } .status-finalizado{ background:var(--finalizado) } .status-insucesso{ background:var(--insucesso) }
  .status-row{display:flex; align-items:center; flex-wrap:wrap; gap:6px; margin-bottom:6px;}
  .badge{ font-size:10px; font-weight:800; padding:3px 6px; border-radius:999px; background:rgba(255,255,255,.25); display:inline-flex; align-items:center; gap:4px; }
  .tag-pill{font-size:10px; font-weight:700; padding:3px 8px; border-radius:999px; background:rgba(15,23,42,.28); color:#fff; text-transform:uppercase; letter-spacing:.3px; display:inline-flex; align-items:center; gap:4px; border:1px solid rgba(255,255,255,.25);}
  html.dark .tag-pill{background:rgba(255,255,255,.2); color:#e2e8f0; border-color:rgba(148,163,184,.35);}
  .type-pill{font-size:10px; font-weight:700; padding:3px 8px; border-radius:999px; background:rgba(14,165,233,.18); color:#0369a1; text-transform:uppercase; letter-spacing:.3px; display:inline-flex; align-items:center; gap:4px; border:1px solid rgba(14,165,233,.28);}
  html.dark .type-pill{background:rgba(14,165,233,.28); color:#0ea5e9; border-color:rgba(59,130,246,.35);}
  .title{font-weight:800; font-size:13px; margin-bottom:2px} .meta{font-size:11.5px; opacity:.95}
  @keyframes pop{from{opacity:0; transform:translateY(4px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}
  .card-delete{position:absolute; top:6px; right:6px; background:rgba(15,23,42,.4); border:none; color:#fff; width:20px; height:20px; border-radius:50%; display:grid; place-items:center; cursor:pointer; font-weight:700; font-size:12px; padding:0; transition:background .2s ease, transform .2s ease;}
  .card-delete:hover{background:rgba(15,23,42,.6); transform:scale(1.05);}
  html.dark .card-delete{background:rgba(15,23,42,.7);}
  html.dark .card-delete:hover{background:rgba(15,23,42,.9);}
  .grid > div.drop-target{outline:2px dashed rgba(15,106,216,.45); outline-offset:-6px;}
  html.dark .grid > div.drop-target{outline-color:rgba(147,197,253,.6);}

  .login-card{background:var(--card); border:1px solid var(--border); padding:20px; margin:18px auto; border-radius:18px; max-width:420px; box-shadow:0 18px 32px -24px rgba(15,106,216,.35)}
  html.dark .login-card{background:rgba(17,24,39,.92); border-color:rgba(59,130,246,.25); box-shadow:0 22px 40px -28px rgba(15,23,42,.9);}
  .login-title{margin:0 0 10px; color:var(--primary); text-align:center; font-size:18px}
  html.dark .login-title{color:#93c5fd;}
  .login-actions{display:flex; gap:8px; margin-top:8px}

  .footer{width:100%; background:rgba(255,255,255,.92); border-top:1px solid var(--border); color:var(--muted); font-size:12px; text-align:center; padding:14px}
  html.dark .footer{background:rgba(17,24,39,.95); border-color:rgba(59,130,246,.18); color:#94a3b8;}

  /* Splash/Spinner */
  .splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:9999; transition:opacity .25s ease, background-color .3s}
  .splash.hide{ opacity:0; pointer-events:none }
  .ring{ width:40px; height:40px; border:3px solid #e5e7eb; border-top-color:var(--primary-2); border-radius:50%; animation:spin 1s linear infinite }
  html.dark .ring { border-color: #374151; border-top-color: var(--primary-2); }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* ===== Toast (Suavizado) ===== */
  .topbar{position:fixed; top:16px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:8px; z-index:9999; pointer-events:none}
  .toast{
      pointer-events:auto; padding:10px 16px; border-radius:12px;
      border: 1px solid var(--border);
      background:var(--card);
      box-shadow:0 10px 25px -5px rgba(0,0,0,.1), 0 8px 10px -6px rgba(0,0,0,.1);
      font-size:14px; display:flex; align-items:center; gap:10px;
      animation: slideIn .3s ease-out both;
  }
  .toast-icon { width: 20px; height: 20px; }
  .toast.warn{ border-color:rgba(251, 191, 36, 0.5); background:#fffbeb; color:#92400e; }
  .toast.warn .toast-icon { color: #f59e0b; }
  .toast.error{ border-color:rgba(239, 68, 68, 0.5); background:#fef2f2; color:#991b1b; }
  .toast.error .toast-icon { color: #ef4444; }
  .toast.ok{ border-color:rgba(16, 185, 129, 0.5); background:#f0fdf4; color:#065f46; }
  .toast.ok .toast-icon { color: #10b981; }
  .toast button{background:transparent; color:inherit; border:none; cursor:pointer; padding:0 4px; font-weight:700; opacity:0.6; margin-left:auto;}
  .toast button:hover{ opacity:1; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
  html.dark .toast { background: #374151; border-color: #4b5563; color: var(--text); }
  html.dark .toast.warn { background: #422006; color: #fef3c7; border-color: #78350f; }
  html.dark .toast.error { background: #4c0519; color: #fee2e2; border-color: #881337; }
  html.dark .toast.ok { background: #064e3b; color: #d1fae5; border-color: #047857; }

  /* ===== Filtro por data (Aprimorado) ===== */
  .date-filters{
    display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:center;
    margin:18px 0 12px; background:rgba(255,255,255,.92); padding:12px 16px; border-radius:14px;
    box-shadow:0 16px 28px -26px rgba(15,106,216,.45); border:1px solid var(--border);
  }
  html.dark .date-filters{background:rgba(17,24,39,.9); border-color:rgba(59,130,246,.25); box-shadow:0 18px 30px -28px rgba(15,23,42,.9);}
  .date-filter-group{
    display:flex; align-items:center; gap:8px; background:#f8fafc;
    border:1px solid var(--border); border-radius:10px; padding:6px 10px;
  }
  html.dark .date-filter-group { background: #111827; border-color:#1f2937; }
  .date-filter-group .label{ color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.08em; }
  .date-filters input[type="date"]{
    background:transparent; border:none; color:var(--text); font-size:13px; padding:2px;
  }
  .date-filters input[type="date"]:focus{ outline:none; }
  .date-filters input[type="date"]::-webkit-calendar-picker-indicator{ cursor:pointer; opacity:0.6; }
  .date-filters input[type="date"]::-webkit-calendar-picker-indicator:hover{ opacity:1; }
  html.dark .date-filters input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1); }

  /* ===== Modal (Repaginado) ===== */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15, 23, 42, 0.6); z-index:10000; backdrop-filter: blur(4px);}
  .modal.show{display:flex}
  .modal-card{
    width:min(720px, calc(100% - 24px));
    background: var(--card);
    border-radius: 16px;
    box-shadow:0 25px 50px -12px rgba(0,0,0,.25); overflow:hidden;
    animation:pop .25s cubic-bezier(0.165, 0.84, 0.44, 1) both; position:relative;
    border: 1px solid var(--border);
  }
  html.dark .modal-card { background: #1f2937; }
  .modal-header{
    padding: 16px 20px;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    position:relative;
  }
  html.dark .modal-header { background: #111827; }
  .modal-title-wrapper { display: flex; align-items: center; gap: 12px; }
  .modal-title{margin:0; font-weight:800; font-size: 18px; color: var(--text); }
  .modal-sub{margin: 2px 0 0; font-size:12px; opacity:.75; color: var(--muted); }
  .modal-close{
    position:absolute; top: 12px; right: 12px; width:32px; height:32px;
    display:flex; align-items:center; justify-content:center;
    background: #f1f5f9; border:1px solid #e2e8f0;
    border-radius:999px; color:var(--muted); font-weight:900; cursor:pointer; line-height:1; font-size:16px;
    transition: background-color .2s, color .2s;
  }
  .modal-close:hover{ background-color: #e2e8f0; color: var(--text); }
  html.dark .modal-close { background: #374151; border-color: #4b5563; color: var(--muted); }
  html.dark .modal-close:hover { background: #4b5563; color: var(--text); }
  .modal-body{ padding: 20px; max-height: calc(90vh - 80px); overflow-y: auto;}

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding: 6px 12px; border-radius:999px; font-weight:700; font-size:12px;
    text-transform: uppercase; letter-spacing: .5px;
  }
  .pill.andamento{ background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
  .pill.finalizado{ background: #f0fdf4; color: #065f46; border: 1px solid #bbf7d0; }
  .pill.insucesso{ background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

  .info-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin: 16px 0; }
  .info-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
  html.dark .info-item { background: #111827; }
  .info-item b{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; }
  .info-item span { font-size: 16px; font-weight: 600; color: var(--text); }

  .template-box{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-top:16px }
  html.dark .template-box { background: #111827; }
  .modal-editor{margin-top:16px; background:rgba(148,163,184,.08); border:1px solid var(--border); padding:12px; border-radius:12px; display:flex; flex-direction:column; gap:8px;}
  html.dark .modal-editor{background:rgba(17,24,39,.75); border-color:rgba(59,130,246,.25);}
  .modal-editor label{font-size:12px; font-weight:700; color:var(--muted);}
  .modal-editor-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
  .modal-editor-row select{flex:1 1 180px; min-width:160px;}
  .modal-editor-row .btn{flex:0 0 auto;}
  .template-header { display:flex;align-items:center;justify-content:space-between;gap:8px; }
  .template-header b { font-size: 16px; }

  .btns{ display:flex; flex-wrap:wrap; gap:8px; }
  .template-actions{ margin-top:16px; justify-content:flex-end; }
  .btn{
    background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; border:none; border-radius:12px;
    padding:10px 16px; font-weight:700; cursor:pointer;
    box-shadow:0 12px 25px -18px rgba(15,106,216,.55);
    font-size:13px; transition: transform .15s, box-shadow .15s;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 16px 30px -18px rgba(15,106,216,.55); }
  .btn.ghost{ background:var(--card); color:var(--primary); border:1px solid var(--primary); box-shadow:none; }
  .btn.ghost:hover { background: #f0f9ff; }
  html.dark .btn.ghost { background: #1e293b; color: #60a5fa; border-color: #2563eb; }
  html.dark .btn.ghost:hover { background: #334155; }
  .btn.warn{ background:linear-gradient(90deg,#f97316,#fb923c); }
  .btn.success{ background:linear-gradient(90deg,#059669,#10b981); }

  #mText {
    white-space:pre-wrap; font-family:inherit; margin:16px 0 0;
    background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0;
    line-height: 1.6; color: #334155;
  }
  html.dark #mText { background: #1f2937; border-color: var(--border); color: var(--muted); }
  .template-vars { color:var(--muted); font-size:12px; margin-top:12px; background: #f1f5f9; padding: 8px; border-radius: 8px; }
  html.dark .template-vars { background: #374151; }

  @media (max-width: 1080px){
    .wrap{padding:0 20px 56px;}
    .app-banner{flex-direction:column; align-items:flex-start; gap:20px; padding:24px;}
    .header-actions{width:100%; justify-content:space-between;}
    .header-nav{flex-wrap:wrap;}
  }

  @media (max-width: 860px){
    .header-actions{flex-direction:column; align-items:flex-start; gap:14px;}
    .header-nav{width:100%; justify-content:flex-start; gap:10px;}
    .header-nav .tab{flex:1 1 120px; justify-content:center;}
    .header-chip{margin-top:0;}
    .metrics{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .theme-toggle-wrap{justify-content:flex-start;}
  }

  @media (max-width: 720px){
    body{font-size:15px;}
    .wrap{padding:0 16px 48px;}
    .app-banner{padding:20px; border-radius:20px;}
    .brand{width:100%; align-items:flex-start;}
    .brand-icon{width:52px; height:52px; border-radius:18px;}
    .brand-icon svg{width:26px; height:26px;}
    .app-title{font-size:22px;}
    .app-subtitle{font-size:13px;}
    .header-actions{gap:16px;}
    .header-nav{gap:12px;}
    .header-chip{width:100%; justify-content:center; font-size:12px; padding:9px 14px;}
    .theme-toggle-wrap{padding-top:16px; justify-content:center;}
    .tabs{margin-top:20px;}
    .metric-card{min-height:120px; padding:16px;}
    .metric-value{font-size:30px;}
    .legenda{justify-content:flex-start;}
    .date-filters{flex-direction:column; align-items:stretch; gap:10px;}
    .date-filter-group{width:100%; justify-content:space-between;}
    .form-container{padding:18px;}
    .form-grid{grid-template-columns:1fr;}
    .tempo-group{width:100%;}
    .login-actions{flex-direction:column;}
    .login-actions button{width:100%;}
    .table-card{padding:18px;}
    .grid{display:flex; flex-direction:column; gap:16px; position:relative;}
    .grid::after{display:none;}
    .grid > div{border:none; border-bottom:none; padding:0; background:transparent; min-height:auto;}
    .grid > .header{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0, 0, 0, 0);
      white-space:nowrap;
      border:0;
    }
    .grid [data-schedule-column]{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      min-height:0;
      box-shadow:0 18px 34px -28px rgba(15,106,216,.55);
    }
    html.dark .grid [data-schedule-column]{
      background:rgba(17,24,39,.95);
      border-color:rgba(59,130,246,.25);
      box-shadow:0 18px 36px -30px rgba(15,23,42,.8);
    }
    .grid [data-schedule-column]::before{
      content:attr(data-horario);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:10px;
    }
    .grid [data-schedule-column].drop-target{outline:2px dashed rgba(15,106,216,.45); outline-offset:-6px;}
    html.dark .grid [data-schedule-column].drop-target{outline-color:rgba(147,197,253,.6);}
    .disparo{margin:0 0 12px;}
    .disparo:last-child{margin-bottom:0;}
    .template-box{padding:16px;}
    .template-header{flex-direction:column; align-items:flex-start; gap:12px;}
    .btns{width:100%; gap:10px;}
    .template-box .btns{flex-wrap:wrap;}
    .template-box .template-actions{justify-content:flex-start; width:100%;}
    .template-box .btns .btn{flex:1 1 140px;}
    .modal-editor{padding:14px;}
    .modal-editor-row{flex-direction:column; align-items:stretch;}
    .modal-editor-row .btn{width:100%;}
    #mText{font-size:13px;}
    .info-list{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));}
    .modal-card{max-height:90vh;}
  }

  @media (max-width: 480px){
    .wrap{padding:0 12px 40px;}
    .brand-icon{width:46px; height:46px;}
    .brand-icon svg{width:22px; height:22px;}
    .app-title{font-size:20px;}
    .app-subtitle{font-size:12px;}
    .header-chip{font-size:11px; padding:8px 12px;}
    .metric-card{padding:14px;}
    .metric-label{font-size:11px;}
    .metric-value{font-size:26px;}
    .metric-foot{font-size:12px;}
    .form-container h2{font-size:16px;}
    label{font-size:11px;}
    input,select,button{font-size:13px;}
    .tempo-group input{width:48px;}
    .btn{width:100%; justify-content:center;}
    .template-box .btns .btn{flex:1 1 100%;}
    .modal-card{width:calc(100% - 16px);}
    .modal-header{padding:14px 16px;}
    .modal-body{padding:16px;}
    .topbar{width:calc(100% - 24px); left:50%; transform:translateX(-50%);}
  }
</style>

</head>
<body>
  <div id="splash" class="splash"><div class="ring" aria-label="Carregando"></div></div>
  <div id="topbar" class="topbar" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <div class="app-banner">
      <div class="brand">
        <span class="brand-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5h18M4.5 12h15M6 16.5h12" />
          </svg>
        </span>
        <div>
          <h1 class="app-title">Painel de Disparos</h1>
          <p class="app-subtitle">Monitoramento em tempo real dos disparos</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="header-nav" role="tablist" aria-label="Navegação principal">
          <button class="tab active" type="button" data-tab="painel">Painel</button>
          <button class="tab" type="button" data-tab="login">Login</button>
        </div>
        <span class="header-chip" id="currentTimeChip" aria-live="polite">—</span>
        <span class="header-chip">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span id="currentDateChip">—</span>
        </span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="theme-toggle-wrap">
      <button id="themeToggle" class="theme-toggle" title="Alternar tema"></button>
    </div>

    <section class="metrics" aria-live="polite" aria-label="Resumo do dia">
      <article class="metric-card">
        <span class="metric-icon icon-total" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5h15v15h-15z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9h6v6H9z" />
          </svg>
        </span>
        <span class="metric-label">Total de disparos</span>
        <strong class="metric-value" id="metricTotal">0</strong>
        <span class="metric-foot" id="metricsRangeLabel">Nenhum dia selecionado</span>
        <span class="metric-foot">Disparado no dia: <strong id="metricVolume">0</strong></span>
      </article>
      <article class="metric-card content-warn">
        <span class="metric-icon icon-progress" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5l7.5-7.5L18 13.5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12" />
          </svg>
        </span>
        <span class="metric-label">Em andamento</span>
        <strong class="metric-value" id="metricAndamento">0</strong>
        <span class="metric-foot">Disparos ativos</span>
      </article>
      <article class="metric-card content-success">
        <span class="metric-icon icon-done" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        </span>
        <span class="metric-label">Finalizados</span>
        <strong class="metric-value" id="metricFinalizado">0</strong>
        <span class="metric-foot">Disparos concluídos</span>
      </article>
      <article class="metric-card content-error">
        <span class="metric-icon icon-error" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.008v.008H12z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </span>
        <span class="metric-label">Insucessos</span>
        <strong class="metric-value" id="metricInsucesso">0</strong>
        <span class="metric-foot">Atenção necessária</span>
      </article>
      <article class="metric-card budget-card">
        <span class="metric-icon icon-budget" aria-hidden="true">$</span>
        <span class="metric-label">Orçamento total</span>
        <strong class="metric-value" id="metricBudgetHighlight">R$ 0,00</strong>
        <span class="metric-foot">Gasto mês: <strong id="metricBudgetMonth">R$ 0,00</strong></span>
        <span class="metric-foot">Gasto dia: <strong id="metricBudgetDay">R$ 0,00</strong></span>
      </article>
    </section>

    <div id="dateFilters" class="date-filters">
        <div class="date-filter-group">
            <span class="label">Data:</span>
            <input type="date" id="datePick" title="Escolher dia" />
        </div>
    </div>

    <section id="view-painel">
      <div class="legenda">
        <div class="legenda-item"><span class="cor andamento"></span> Em andamento</div>
        <div class="legenda-item"><span class="cor finalizado"></span> Finalizado</div>
        <div class="legenda-item"><span class="cor insucesso"></span> Insucesso</div>
      </div>

      <div id="form-wrapper" class="form-container" style="display:none;">
        <h2>Novo Disparo</h2>
        <form id="formDisparo" class="form-grid">
          <div>
            <label for="tipo">Nome do Disparo</label>
            <input type="text" id="tipo" placeholder="Ex.: Lote Preventivo" />
          </div>
          <div>
            <label for="template">Template</label>
            <select id="template">
              <option value="">(nenhum)</option>
              <option value="preventivo_d0">Preventivo D0</option>
              <option value="preventivo_d3_d10">Preventivo D3 e D10</option>
              <option value="vencidos_1">Vencidos 1</option>
              <option value="vencidos_2">Vencidos 2</option>
              <option value="vencidos_5">Vencidos 5</option>
            </select>
          </div>
          <div>
            <label for="tag">Tag do Disparo</label>
            <select id="tag">
              <option value="">(Sem tag)</option>
              <option value="Vendas">Vendas</option>
              <option value="Conciliação">Conciliação</option>
              <option value="SAC">SAC</option>
              <option value="Recup de Crédito">Recup de Crédito</option>
            </select>
          </div>
          <div>
            <label for="tipoDisparo">Tipo do Disparo</label>
            <select id="tipoDisparo">
              <option value="">(Sem tipo)</option>
              <option value="Marketing">Marketing</option>
              <option value="Marketing Lite">Marketing Lite</option>
              <option value="Utilidade">Utilidade</option>
              <option value="Autenticação">Autenticação</option>
            </select>
          </div>
          <div>
            <label for="volume">Volume (qtd disparos)</label>
            <input type="number" id="volume" min="0" placeholder="Ex.: 120"/>
          </div>
          <div>
            <label for="tempoHoras">Tempo Médio</label>
            <div class="tempo-group">
              <input type="number" id="tempoHoras" min="0" max="23" placeholder="0" aria-label="Horas" />
              <span class="tempo-sep">h</span>
              <input type="number" id="tempoMinutos" min="0" max="59" placeholder="00" aria-label="Minutos" />
              <span class="tempo-sep">min</span>
            </div>
          </div>
          <div>
            <label for="potes">Quantidade de Potes</label>
            <input type="number" id="potes" min="0" />
          </div>
          <div>
            <label for="horario">Horário</label>
            <select id="horario">
              <option value="08:00">08:00</option>
              <option value="12:00">12:00</option>
              <option value="16:00">16:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          <div class="full">
            <button type="submit">Adicionar</button>
          </div>
        </form>
      </div>

      <div id="readOnlyHint" class="badge-info" style="display:none; text-align:center;">
        Você está em <strong>modo leitura</strong>. Faça login para adicionar/alterar disparos.
      </div>

      <div class="table-card" style="margin-top:12px;">
        <div class="grid" id="painel-grid">
          <div class="header">Horário</div>
          <div class="header">08:00</div>
          <div class="header">12:00</div>
          <div class="header">16:00</div>
          <div class="header">20:00</div>

          <div class="header">Disparos</div>
          <div id="col-08" data-schedule-column data-horario="08:00"></div>
          <div id="col-12" data-schedule-column data-horario="12:00"></div>
          <div id="col-16" data-schedule-column data-horario="16:00"></div>
          <div id="col-20" data-schedule-column data-horario="20:00"></div>
        </div>
      </div>
    </section>

    <section id="view-login" style="display:none;">
      <div class="login-card">
        <h2 class="login-title">Acessar</h2>
        <form id="loginForm">
          <label for="loginUser">Usuário</label>
          <input type="text" id="loginUser" placeholder="usuário" required />
          <label for="loginPass" style="margin-top:8px;">Senha</label>
          <input type="password" id="loginPass" placeholder="senha" required />
          <div class="login-actions">
            <button type="submit" id="btnLogin">Entrar</button>
            <button type="button" id="btnLogout" style="display:none;background:#ef4444;">Sair</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title-wrapper">
          <div id="mStatusPill" class="pill"></div>
          <div>
            <h3 class="modal-title" id="mTitle">Detalhes do disparo</h3>
            <div class="modal-sub" id="mSub"></div>
          </div>
        </div>
        <button class="modal-close" id="mClose" title="Fechar">×</button>
      </div>
      <div class="modal-body">
          <div class="info-list">
              <div class="info-item"><b>Volume</b><span id="mVolume">—</span></div>
              <div class="info-item"><b>Potes</b><span id="mPotes">—</span></div>
              <div class="info-item"><b>Tempo total</b><span id="mTempo">—</span></div>
              <div class="info-item"><b>Tempo restante</b><span id="mRestante">—</span></div>
              <div class="info-item"><b>Horário</b><span id="mHora">—</span></div>
              <div class="info-item"><b>Template</b><span id="mTpl">—</span></div>
              <div class="info-item"><b>Tag</b><span id="mTag">—</span></div>
              <div class="info-item"><b>Tipo Disparo</b><span id="mTipoDisparo">—</span></div>
          </div>

          <div class="modal-editor" id="modalTagEditor" style="display:none;">
              <label for="mTagSelect">Atualizar tag do disparo</label>
              <div class="modal-editor-row">
                  <select id="mTagSelect">
                      <option value="">(Sem tag)</option>
                      <option value="Vendas">Vendas</option>
                      <option value="Conciliação">Conciliação</option>
                      <option value="SAC">SAC</option>
                      <option value="Recup de Crédito">Recup de Crédito</option>
                  </select>
                  <button class="btn ghost" type="button" id="mTagSave">Salvar tag</button>
              </div>
          </div>

          <div class="modal-editor" id="modalTipoEditor" style="display:none;">
              <label for="mTipoSelect">Atualizar tipo do disparo</label>
              <div class="modal-editor-row">
                  <select id="mTipoSelect">
                      <option value="">(Sem tipo)</option>
                      <option value="Marketing">Marketing</option>
                      <option value="Marketing Lite">Marketing Lite</option>
                      <option value="Utilidade">Utilidade</option>
                      <option value="Autenticação">Autenticação</option>
                  </select>
                  <button class="btn ghost" type="button" id="mTipoSave">Salvar tipo</button>
              </div>
          </div>

          <div class="template-box">
              <div class="template-header">
                  <b>Fraseologia</b>
                  <div class="btns">
                      <button class="btn success" id="mCopy">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                          Copiar
                      </button>
                      <button class="btn ghost" id="mRefresh">Atualizar</button>
                  </div>
              </div>
              <pre id="mText"></pre>
              <div class="template-vars">Variáveis: $[nome], $[valor], $[data_vencimento], $[dias_vencidos], $[quantidade_boletos]</div>
              <div class="btns template-actions">
                  <button class="btn warn" id="mCycle" style="display:none;">Alterar status</button>
              </div>
          </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <script>
  /* ========================= THEME TOGGLE ======================= */
  const themeToggleBtn = document.getElementById("themeToggle");
  const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a2.25 2.25 0 00-2.25 2.25 2.25 2.25 0 002.25 2.25 2.25 2.25 0 002.25-2.25A2.25 2.25 0 0012 12z" /></svg>`;
  const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`;
  const THEME_KEY = "painel_theme";

  function getStoredTheme(){
    try{ return localStorage.getItem(THEME_KEY); }
    catch{ return null; }
  }

  function setStoredTheme(value){
    try{ localStorage.setItem(THEME_KEY, value); }
    catch{}
  }

  function applyTheme(theme) {
      const isDark = theme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      if (themeToggleBtn){
        themeToggleBtn.innerHTML = isDark ? sunIcon : moonIcon;
      }
  }

  function detectPreferredTheme(){
      try{ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
      catch{ return 'light'; }
  }

  function toggleTheme() {
      const currentTheme = getStoredTheme() || detectPreferredTheme();
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setStoredTheme(newTheme);
      applyTheme(newTheme);
  }

  const savedTheme = getStoredTheme();
  applyTheme(savedTheme || detectPreferredTheme());

  if(themeToggleBtn) {
    themeToggleBtn.addEventListener("click", toggleTheme);
  }

  /* ====================== DASHBOARD METRICS ==================== */
  const formatInteger = (value) => {
    const n = Number(value || 0);
    if (Number.isNaN(n)) return "0";
    try { return n.toLocaleString("pt-BR"); }
    catch { return String(n); }
  };

  const formatCurrency = (value) => {
    const n = Number(value || 0);
    if (!Number.isFinite(n)) return "R$ 0,00";
    try { return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }
    catch { return `R$ ${n.toFixed(2)}`; }
  };

  const COST_PER_TIPO = {
    "Marketing": 0.62,
    "Marketing Lite": 0.54,
    "Utilidade": 0.09,
    "Autenticação": 0.09,
    "": 0,
  };
  const TIPO_DISPARO_OPTIONS = Object.keys(COST_PER_TIPO).filter(Boolean);

  let currentRange = "all";

  const metricEls = {
    total: document.getElementById("metricTotal"),
    andamento: document.getElementById("metricAndamento"),
    finalizado: document.getElementById("metricFinalizado"),
    insucesso: document.getElementById("metricInsucesso"),
    range: document.getElementById("metricsRangeLabel"),
    volume: document.getElementById("metricVolume"),
    budgetHighlight: document.getElementById("metricBudgetHighlight"),
    budgetMonth: document.getElementById("metricBudgetMonth"),
    budgetDay: document.getElementById("metricBudgetDay"),
  };
  const headerDateChip = document.getElementById("currentDateChip");
  const headerTimeChip = document.getElementById("currentTimeChip");

  const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : str;

  function formatRangeLabel(){
    const dp = document.getElementById("datePick");
    if (!dp || !dp.value) return "Todos os disparos";
    try{
      const formatted = new Date(`${dp.value}T00:00:00`).toLocaleDateString("pt-BR", {
        weekday: "long",
        day: "2-digit",
        month: "long"
      });
      return capitalize(formatted);
    }catch{
      return dp.value;
    }
  }

  function costForRecord(r){
    const volume = Number(r?.volume || 0) || 0;
    const tipo = (r?.tipoDisparo || "").trim();
    const unit = COST_PER_TIPO.hasOwnProperty(tipo) ? COST_PER_TIPO[tipo] : 0;
    return volume * unit;
  }

  function monthKeyFromRange(){
    if (currentRange && currentRange !== "all"){
      return currentRange.slice(0, 7);
    }
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  }

  function updateMetrics(filteredRecords = [], allRecords = []){
    const totals = { total: filteredRecords.length, andamento: 0, finalizado: 0, insucesso: 0, volume: 0 };
    filteredRecords.forEach(r => {
      const status = (r?.status || "").toLowerCase();
      if (status.includes("final")) totals.finalizado++;
      else if (status.includes("insu")) totals.insucesso++;
      else totals.andamento++;
      totals.volume += Number(r?.volume || 0) || 0;
    });

    let dayCost = 0;
    filteredRecords.forEach(r => { dayCost += costForRecord(r); });

    const monthKey = monthKeyFromRange();
    let monthCost = 0;
    const base = Array.isArray(allRecords) && allRecords.length ? allRecords : filteredRecords;
    base.forEach(r => {
      const recMonth = ((r?.data) || "").slice(0, 7);
      if (recMonth && monthKey){
        if (recMonth === monthKey) monthCost += costForRecord(r);
      } else if (!recMonth && (!currentRange || currentRange === "all")){
        monthCost += costForRecord(r);
      }
    });

    if (metricEls.total) metricEls.total.textContent = totals.total;
    if (metricEls.andamento) metricEls.andamento.textContent = totals.andamento;
    if (metricEls.finalizado) metricEls.finalizado.textContent = totals.finalizado;
    if (metricEls.insucesso) metricEls.insucesso.textContent = totals.insucesso;
    if (metricEls.volume) metricEls.volume.textContent = formatInteger(totals.volume);
    if (metricEls.range) metricEls.range.textContent = formatRangeLabel();
    if (metricEls.budgetHighlight) metricEls.budgetHighlight.textContent = formatCurrency(monthCost);
    if (metricEls.budgetMonth) metricEls.budgetMonth.textContent = formatCurrency(monthCost);
    if (metricEls.budgetDay) metricEls.budgetDay.textContent = formatCurrency(dayCost);
  }

  function updateHeaderClock(){
    const now = new Date();
    if (headerTimeChip){
      headerTimeChip.textContent = now.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }
    if (headerDateChip){
      const formatted = now.toLocaleDateString("pt-BR", { weekday: "long", day: "2-digit", month: "long" });
      headerDateChip.textContent = capitalize(formatted);
    }
  }

  updateHeaderClock();
  if (headerDateChip || headerTimeChip) setInterval(updateHeaderClock, 1000);
  updateMetrics([], []);

  /* ========================== CONFIG ========================== */
  const API_BASE = "";
  const IS_FILE = location.protocol === "file:";
  const FORCE_OFFLINE = (new URLSearchParams(location.search)).get("offline") === "1";
  let OFFLINE_MODE = IS_FILE || FORCE_OFFLINE;
  const BASE = (API_BASE || "").replace(/\/+$/,"");
  const url = (p) => `${BASE}${p}`;

  let lastNonEmpty = [];
  let lastHash = "";
  let sse = null, pollTimer = null, backoffMs = 5000, gotFirstPaint = false;
  const countdownEntries = new Map();
  const autoFinalizedIds = new Set();
  let countdownInterval = null;
  let dragState = null;
  const dropZones = [];
  const deletingIds = new Set();
  const TAG_OPTIONS = ["Vendas","Conciliação","SAC","Recup de Crédito"];

  /* ====================== SPLASH & TOASTS ===================== */
  const splash = document.getElementById("splash");
  const hideSplashSoon = () => { splash?.classList.add("hide"); setTimeout(()=>{ try{splash.remove();}catch{} }, 300); };
  const splashTimer = setTimeout(hideSplashSoon, 1200);
  window.addEventListener("error", hideSplashSoon);
  window.addEventListener("unhandledrejection", hideSplashSoon);

  const topbar = document.getElementById("topbar");
  const toasts = new Set();
  function toast(msg, type="ok", ms=2500, key=null){
      if (key && toasts.has(key)) return;
      const div = document.createElement("div");
      div.className = `toast ${type}`;

      const icons = {
          ok: `<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
          warn: `<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
          error: `<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`
      };

      div.innerHTML = `${icons[type] || ""}<span>${msg}</span><button aria-label="fechar">×</button>`;
      const btn = div.querySelector("button");
      const removeToast = ()=> {
          div.style.animation = "slideOut .3s ease-in forwards";
          div.addEventListener('animationend', () => {
              try{ div.remove(); } catch(e){}
              if (key) toasts.delete(key);
          }, { once: true });
      };

      btn.onclick = removeToast;
      topbar.appendChild(div);
      if (key) toasts.add(key);

      setTimeout(removeToast, ms);
  }

  /* ======================= BLIP ANALYTICS ===================== */
  const analyticsList = document.getElementById("blipEvents");
  const analyticsEmpty = document.getElementById("blipEmpty");
  const analyticsUpdated = document.getElementById("blipUpdated");
  const analyticsCount = document.getElementById("blipCount");
  const analyticsRefreshBtn = document.getElementById("blipRefresh");
  const analyticsEmptyDefault = analyticsEmpty ? analyticsEmpty.textContent : "";
  const ANALYTICS_OFFLINE_MSG = "Painel em modo offline. Dados do Blip indisponíveis.";
  const BLIP_POLL_INTERVAL = 15000;
  let blipPollTimer = null;
  let blipLoading = false;

  function formatBlipTimestamp(value){
    if (!value) return "—";
    try{
      return new Date(value).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "medium" });
    }catch{
      return value;
    }
  }

  function renderBlipEvents(events = []){
    if (analyticsCount) analyticsCount.textContent = String(events.length || 0);
    if (!analyticsList) return;
    analyticsList.innerHTML = "";
    if (!events.length){
      analyticsList.hidden = true;
      if (analyticsEmpty){
        if (analyticsEmpty.textContent !== ANALYTICS_OFFLINE_MSG && analyticsEmptyDefault){
          analyticsEmpty.textContent = analyticsEmptyDefault;
        }
        analyticsEmpty.hidden = false;
      }
      if (analyticsUpdated) analyticsUpdated.textContent = "—";
      return;
    }
    analyticsList.hidden = false;
    if (analyticsEmpty){
      analyticsEmpty.hidden = true;
    }
    events.forEach((evt, index) => {
      const li = document.createElement("li");
      li.className = "analytics-event";
      let pretty;
      const payload = evt?.payload;
      try{
        const normalized = (payload === null || typeof payload === "undefined") ? {} : payload;
        pretty = JSON.stringify(normalized, null, 2);
      }catch{
        pretty = String(payload ?? "");
      }
      const badgeLabel = (() => {
        const candidate = evt?.payload?.type || evt?.payload?.event || evt?.payload?.categoria || evt?.payload?.nome;
        if (candidate) return candidate;
        return `Evento ${index + 1}`;
      })();
      const received = formatBlipTimestamp(evt?.received_at);
      li.innerHTML = `
        <div class="analytics-event-header">
          <span class="analytics-event-badge">${escapeHtml(String(badgeLabel))}</span>
          <span>${escapeHtml(received)}</span>
        </div>
        <pre class="analytics-event-pre">${escapeHtml(pretty || "{}")}</pre>
      `;
      analyticsList.appendChild(li);
    });
    if (analyticsUpdated) analyticsUpdated.textContent = formatBlipTimestamp(events[0]?.received_at);
  }

  async function loadBlipEvents({ notifyOnError = false } = {}){
    if (!analyticsList){
      return;
    }
    if (blipLoading){
      return;
    }
    if (OFFLINE_MODE){
      renderBlipEvents([]);
      if (analyticsEmpty){
        analyticsEmpty.textContent = ANALYTICS_OFFLINE_MSG;
        analyticsEmpty.hidden = false;
      }
      if (analyticsUpdated) analyticsUpdated.textContent = "—";
      return;
    }
    if (analyticsEmpty && analyticsEmptyDefault){
      analyticsEmpty.textContent = analyticsEmptyDefault;
    }
    blipLoading = true;
    if (analyticsRefreshBtn){
      analyticsRefreshBtn.disabled = true;
      analyticsRefreshBtn.setAttribute("aria-busy", "true");
    }
    try{
      const resp = await fetchWithTimeout(url("/api/blip/events"), { cache: "no-store" }, 5000);
      if (!resp.ok){
        throw new Error(`status_${resp.status}`);
      }
      const data = await resp.json();
      renderBlipEvents(data?.events || []);
    }catch(err){
      console.error("Falha ao carregar eventos do Blip", err);
      if (notifyOnError){
        toast("Não consegui carregar os dados do Blip.", "warn", 3200, "blip-load");
      }
    }finally{
      if (analyticsRefreshBtn){
        analyticsRefreshBtn.disabled = false;
        analyticsRefreshBtn.removeAttribute("aria-busy");
      }
      blipLoading = false;
    }
  }

  function startBlipPolling(){
    if (blipPollTimer || OFFLINE_MODE || !analyticsList){
      return;
    }
    blipPollTimer = setInterval(() => loadBlipEvents(), BLIP_POLL_INTERVAL);
  }

  function stopBlipPolling(){
    if (blipPollTimer){
      clearInterval(blipPollTimer);
      blipPollTimer = null;
    }
  }

  if (analyticsRefreshBtn){
    analyticsRefreshBtn.addEventListener("click", () => loadBlipEvents({ notifyOnError: true }));
  }

  /* ============================ AUTH =========================== */
  const AUTH_KEY = "painel_auth_ok";
  let isAuthed = localStorage.getItem(AUTH_KEY) === "1";
  
  function updateAuthUI(){
    const formWrap = document.getElementById("form-wrapper");
    const hint = document.getElementById("readOnlyHint");
    const logoutBtn = document.getElementById("btnLogout");
    if(isAuthed){
      formWrap && (formWrap.style.display = "");
      hint && (hint.style.display = "none");
      logoutBtn && (logoutBtn.style.display = "");
    }else{
      formWrap && (formWrap.style.display = "none");
      hint && (hint.style.display = "");
      logoutBtn && (logoutBtn.style.display = "none");
    }
    if (modalTagEditor){
      if (isAuthed){
        modalTagEditor.style.display = "";
        if (mTagSelect) mTagSelect.disabled = false;
        if (mTagSave) mTagSave.disabled = false;
      }else{
        modalTagEditor.style.display = "none";
        if (mTagSelect) mTagSelect.disabled = true;
        if (mTagSave) mTagSave.disabled = true;
      }
    }
    if (modalTipoEditor){
      if (isAuthed){
        modalTipoEditor.style.display = "";
        if (mTipoSelect) mTipoSelect.disabled = false;
        if (mTipoSave) mTipoSave.disabled = false;
      }else{
        modalTipoEditor.style.display = "none";
        if (mTipoSelect) mTipoSelect.disabled = true;
        if (mTipoSave) mTipoSave.disabled = true;
      }
    }
    if (gotFirstPaint){
      renderSnapshot(lastNonEmpty);
    }
  }

  /* ============================ TABS =========================== */
  const tabs = document.querySelectorAll(".tab");
  function switchTab(name){
    tabs.forEach(t => {
      const isActive = t.dataset.tab === name;
      t.classList.toggle("active", isActive);
      t.setAttribute("aria-selected", isActive ? "true" : "false");
    });
    const painelView = document.getElementById("view-painel");
    if (painelView) painelView.style.display = (name === "painel") ? "" : "none";
    const loginView = document.getElementById("view-login");
    if (loginView) loginView.style.display = (name === "login") ? "" : "none";
    if (name === "login") setTimeout(()=>document.getElementById("loginUser")?.focus(), 50);
  }
  tabs.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

  /* ============================ UTILS ========================== */
  // ===== ALTERAÇÃO 1: Mudar chaves para corresponder ao Airtable =====
  const TEMPLATE_TEXTS = {
    "preventivo_d0": `Olá $[nome]!😊

Seu boleto vence Hoje! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o código de barras.(Caso já tenha pago é só desconsiderar)

*Valor* R$: $[valor]
*Vencimento* : $[data_vencimento]

📞 Este é nosso número oficial de atendimento. Caso tenha alguma dúvida é só entrar em contato por aqui, combinado? 👍

Energia de TODOS: Faz bem para o seu bolso e para o planeta!🌎 💚`,
    "preventivo_d3_d10": `Olá $[nome]!😊

Seu boleto vence em $[data_vencimento]! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o código de barras (Caso já tenha pago é só desconsiderar).

*Valor* R$ : $[valor]

📞 Este é nosso número oficial de atendimento. Caso tenha alguma dúvida é só entrar em contato por aqui, combinado? 👍

Energia de TODOS: A Energia que Retorna!🌎`,
    "vencidos_1": `Olá $[nome]!😊

*ATENÇÃO! Sua conta de energia venceu há $[dias_vencidos] dias atrás e não identificamos seu pagamento*

*Valor* R$ :$[valor]
*Vencimento* : $[data_vencimento]

*Atenção*: não deixe de pagar em dia suas faturas para evitar juros e continuar economizando! (Favor desconsiderar essa mensagem, caso já tenha pago).

👉 Caso não tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o código de barras.

❗ Caso tenha dúvida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* 🌎💚`,
    "vencidos_2": `Olá $[nome]!😊

*ATENÇÃO! Sua conta de energia venceu há  $[dias_vencidos]  dias atrás e não identificamos seu pagamento*

Por conta disso poderá haver a suspensão de energia solar. A boa notícia é que ainda há chances de regularizar antes que isso aconteça.  (Favor desconsiderar essa mensagem, caso já tenha pago).

*Valor* R$ :  $[valor]
*Vencimento* : $[data_vencimento]

👉 Caso não tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o código de barras.

❗ Caso tenha dúvida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* 🌎💚`,
    "vencidos_5": `Olá $[nome]!😊

⚠ Até o momento não identificamos o pagamento do seu débito com a Energia de TODOS. Após várias tentativas de contato e de negociação sem sucesso, encaminhamos o seu cadastro ao Serviço de Proteção ao Crédito - SPC.

👉 Quantidade de boletos sem pagamento:  $[quantidade_boletos]
👉 Valor pendente: R$  $[valor]

Queremos escutar a sua proposta! 👉 Para conhecer nossas opções de parcelamento, fale abaixo com nossos atendentes.

📞 Este é nosso número oficial de atendimento via WhatsApp. Se tiver alguma dúvida é só entrar em contato por aqui, combinado? 👍

*Mais Sol, Energia e Economia para TODOS* 🌎💚`
  };
  
  // ===== ALTERAÇÃO 2: Adicionar um mapa para nomes de exibição =====
  const TEMPLATE_DISPLAY_NAMES = {
      "preventivo_d0": "Preventivo D0",
      "preventivo_d3_d10": "Preventivo D3 e D10",
      "vencidos_1": "Vencidos 1",
      "vencidos_2": "Vencidos 2",
      "vencidos_5": "Vencidos 5"
  };

  function tplText(name){ return TEMPLATE_TEXTS[(name||"").trim()] || "(nenhum template associado)"; }

  function clsForStatus(status){
    switch((status||"").toLowerCase()){
      case "finalizado": return "finalizado";
      case "insucesso":  return "insucesso";
      default:           return "andamento";
    }
  }
  function nextStatus(current){
    const order = ["Em andamento","Finalizado","Insucesso"];
    const i = order.indexOf(current);
    return order[(i+1) % order.length];
  }
  function uid(){ return "tmp_" + Math.random().toString(36).slice(2); }
  function calcHash(records){
    try{
      return (records||[]).map(r => `${r.id}|${r.tipo}|${r.status}|${r.horario}|${r.tempo}|${r.potes}|${r.template||""}|${r.volume||""}|${r.tag||""}|${r.tipoDisparo||""}|${r.atualizadoEm||""}`).join("§");
    }catch{ return Math.random().toString(36); }
  }
  function fetchWithTimeout(resource, options = {}, timeout = 3000) {
    try{
      if (typeof AbortController === "undefined"){
        return fetch(resource, options);
      }
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal }).finally(() => clearTimeout(id));
    }catch{
      return fetch(resource, options);
    }
  }
  function fmtDateOnly(s){
    if(!s) return null;
    return s.split("T")[0];
  }

  function minutesToParts(totalMinutes){
    const mins = Math.max(0, Number(totalMinutes) || 0);
    return { hours: Math.floor(mins / 60), minutes: mins % 60 };
  }
  function formatTempoLabel(totalMinutes){
    const { hours, minutes } = minutesToParts(totalMinutes);
    const parts = [];
    if (hours) parts.push(`${hours}h`);
    if (minutes) parts.push(`${minutes}min`);
    if (!parts.length) parts.push("0min");
    return parts.join(" ");
  }
  function formatRemainingLabel(ms){
    if (ms === null) return "—";
    if (ms <= 0) return "Finalizado";
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const parts = [];
    if (hours) parts.push(`${hours}h`);
    parts.push(`${String(minutes).padStart(2, '0')}m`);
    parts.push(`${String(seconds).padStart(2, '0')}s`);
    return parts.join(' ');
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
  function isValidTag(value){
    return !value || TAG_OPTIONS.includes(value);
  }
  function isValidTipoDisparo(value){
    return !value || TIPO_DISPARO_OPTIONS.includes(value);
  }
  function remainingMsFromRecord(r){
    try{
      const mins = Number(r?.tempo || 0);
      const ts = r?.atualizadoEm ? Date.parse(r.atualizadoEm) : NaN;
      if (!mins || isNaN(ts)) return null;
      const end = ts + mins * 60000;
      return end - Date.now();
    }catch{
      return null;
    }
  }

  /* ================== FILTRO POR DATA ============ */
  function setRange(range){
    currentRange = range || "all";
    softRender(lastNonEmpty);
  }
  function inRange(rec){
    if (!rec || !rec.data) return true; 
    if (currentRange === 'all') return true;
    return rec.data === currentRange;
  }

  /* =========================== RENDER ========================== */
  function clearColumns(){
    ["08","12","16","20"].forEach(h => {
      const el = document.getElementById("col-"+h);
      if (el) el.innerHTML = "";
    });
  }

  function cardTemplate(r){
    const div = document.createElement("div");
    div.className = `disparo status-${clsForStatus(r.status)}`;
    div.dataset.id = r.id || uid();
    div.dataset.status = r.status || "Em andamento";
    div.dataset.horario = r["horario"] || "08:00";
    div.dataset.template = r.template || "";
    div.dataset.volume = r.volume || "";
    div.dataset.atualizadoEm = r.atualizadoEm || "";
    div.dataset.data = r.data || "";
    div.dataset.tempo = r.tempo ?? "";
    div.dataset.tag = r.tag || "";
    div.dataset.tipoDisparo = r.tipoDisparo || "";

    const remainingLabel = formatRemainingLabel(remainingMsFromRecord(r));
    const metaParts = [
      `Tempo: <strong>${formatTempoLabel(r.tempo)}</strong>`,
      `Restante: <strong data-restante>${remainingLabel}</strong>`
    ];
    if (r.potes !== undefined && r.potes !== null && r.potes !== "") {
      metaParts.push(`Potes: <strong>${r.potes}</strong>`);
    }
    if (r.volume) {
      metaParts.push(`Vol.: <strong>${r.volume}</strong>`);
    }
    if (r.tipoDisparo) {
      metaParts.push(`Tipo: <strong>${escapeHtml(r.tipoDisparo)}</strong>`);
    }
    const deleteMarkup = isAuthed ? `<button class="card-delete" type="button" data-role="delete" title="Excluir disparo">×</button>` : "";
    const statusLabel = escapeHtml(r.status || "Em andamento");
    const tagMarkup = r.tag ? `<span class="tag-pill" data-role="tag">${escapeHtml(r.tag)}</span>` : "";
    const tipoMarkup = r.tipoDisparo ? `<span class="type-pill" data-role="tipo">${escapeHtml(r.tipoDisparo)}</span>` : "";
    div.innerHTML = `
      ${deleteMarkup}
      <div class="status-row">
        <span class="badge" data-role="badge">${statusLabel}</span>
        ${tagMarkup}
        ${tipoMarkup}
      </div>
      <div class="title">${r.tipo || ""}</div>
      <div class="meta">${metaParts.join(' • ')}</div>
    `;

    let dragged = false;
    const markDragStart = () => { dragged = true; };
    const markDragEnd = () => { setTimeout(() => { dragged = false; }, 0); };

    div.addEventListener("click", () => {
      if (dragged){ dragged = false; return; }
      openModal(r);
    });
    setupCardInteractions(div, r, markDragStart, markDragEnd);

    if (isAuthed){
      const delBtn = div.querySelector('[data-role="delete"]');
      if (delBtn){
        delBtn.addEventListener('click', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          deleteRecord(r, div);
        });
      }
    }
    return div;
  }

  function setupCardInteractions(element, record, onDragStart, onDragEnd){
    if (!element) return;
    if (!isAuthed){
      element.removeAttribute('draggable');
      return;
    }
    element.setAttribute('draggable', 'true');
    element.addEventListener('dragstart', (event) => {
      if (!isAuthed){ event.preventDefault(); return; }
      dragState = { record, element, sourceHorario: record?.horario || element.dataset.horario || "" };
      element.classList.add('dragging');
      onDragStart && onDragStart();
      try{
        if (event.dataTransfer){
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', record?.id || element.dataset.id || '');
        }
      }catch{}
    });
    element.addEventListener('dragend', () => {
      element.classList.remove('dragging');
      dropZones.forEach(z => z.classList.remove('drop-target'));
      dragState = null;
      onDragEnd && onDragEnd();
    });
  }

  function handleDragEnter(event){
    if (!isAuthed || !dragState) return;
    event.preventDefault();
    event.currentTarget.classList.add('drop-target');
  }

  function handleDragOver(event){
    if (!isAuthed || !dragState) return;
    event.preventDefault();
    try{ event.dataTransfer.dropEffect = 'move'; }
    catch{}
  }

  function handleDragLeave(event){
    if (!isAuthed) return;
    const current = event.currentTarget;
    const related = event.relatedTarget;
    if (!current.contains(related)){
      current.classList.remove('drop-target');
    }
  }

  async function handleDrop(event){
    if (!isAuthed || !dragState) return;
    event.preventDefault();
    const zone = event.currentTarget;
    dropZones.forEach(z => z.classList.remove('drop-target'));
    const state = dragState;
    dragState = null;
    const record = state?.record;
    if (!record) return;
    const newHorario = zone?.dataset?.horario || "";
    if (!newHorario){
      softRender((lastNonEmpty || []).slice());
      return;
    }
    const previousHorario = record.horario || state.sourceHorario || "";
    if (previousHorario === newHorario){
      softRender((lastNonEmpty || []).slice());
      return;
    }

    record.horario = newHorario;
    softRender((lastNonEmpty || []).slice());
    toast(`Disparo movido para ${newHorario}`, "ok", 2200, `move-${record.id || record.tipo || newHorario}`);

    if (OFFLINE_MODE || !record.id || String(record.id).startsWith('tmp_')){
      if (OFFLINE_MODE){
        toast("Mudança registrada localmente (offline).", "warn", 2400, "move-offline");
      }
      return;
    }

    try{
      const resp = await fetch(url(`/api/disparos/${record.id}`), {
        method: "PATCH",
        headers: {"Content-Type":"application/json"},
        credentials: "include",
        body: JSON.stringify({ horario: newHorario })
      });
      if (resp.status === 401){
        isAuthed = false;
        localStorage.removeItem(AUTH_KEY);
        updateAuthUI();
        switchTab("login");
        toast("Sessão expirada ao mover disparo.", "warn", 2600, "move-auth");
        record.horario = previousHorario;
        setTimeout(() => softRender((lastNonEmpty || []).slice()), 120);
        return;
      }
      if (!resp.ok){
        throw new Error(`status_${resp.status}`);
      }
    }catch(err){
      console.error("Falha ao atualizar horário", err);
      toast("Não consegui salvar o novo horário.", "error", 2800, "move-error");
      record.horario = previousHorario;
      setTimeout(() => softRender((lastNonEmpty || []).slice()), 150);
    }
  }

  function initializeDragAndDrop(){
    document.querySelectorAll('[data-schedule-column]').forEach(col => {
      if (!dropZones.includes(col)){
        dropZones.push(col);
        col.addEventListener('dragenter', handleDragEnter);
        col.addEventListener('dragover', handleDragOver);
        col.addEventListener('dragleave', handleDragLeave);
        col.addEventListener('drop', handleDrop);
      }
    });
  }

  initializeDragAndDrop();

  async function deleteRecord(record, element){
    if (!isAuthed){ toast("Faça login para excluir.", "warn"); return; }
    if (!record){ return; }

    const id = record.id;
    if (id && deletingIds.has(id)) return;

    if (!id){
      lastNonEmpty = (lastNonEmpty || []).filter(r => r !== record);
      softRender((lastNonEmpty || []).slice());
      toast("Disparo removido localmente.", "warn", 2200, "delete-local");
      return;
    }

    if (!confirm("Deseja remover este disparo?")) return;

    deletingIds.add(id);
    element?.setAttribute('aria-busy', 'true');

    try{
      if (OFFLINE_MODE){
        lastNonEmpty = (lastNonEmpty || []).filter(r => `${r.id}` !== `${id}`);
        softRender((lastNonEmpty || []).slice());
        toast("Disparo removido (offline).", "warn", 2400, "delete-offline");
        return;
      }

      const resp = await fetch(url(`/api/disparos/${id}`), {
        method: "DELETE",
        credentials: "include"
      });

      if (resp.status === 401){
        isAuthed = false;
        localStorage.removeItem(AUTH_KEY);
        updateAuthUI();
        switchTab("login");
        toast("Sessão expirada.", "warn", 2400, "delete-auth");
        return;
      }

      if (!resp.ok){
        const errorText = await resp.text().catch(() => "");
        console.error("Falha ao excluir disparo:", errorText || resp.status);
        toast("Não consegui excluir o disparo.", "error", 2800, "delete-error");
        return;
      }

      lastNonEmpty = (lastNonEmpty || []).filter(r => `${r.id}` !== `${id}`);
      softRender((lastNonEmpty || []).slice());
      toast("Disparo excluído.", "ok", 2000, `delete-${id}`);
    }catch(err){
      console.error("Erro ao excluir disparo", err);
      toast("Falha de rede ao excluir.", "error", 2800, "delete-network");
    }finally{
      deletingIds.delete(id);
      element?.removeAttribute('aria-busy');
    }
  }

  function placeRecord(r){
    const hh = (r["horario"] || "08:00").split(":")[0];
    const col = document.getElementById("col-"+hh);
    if (col) {
      const card = cardTemplate(r);
      col.appendChild(card);
      registerCountdown(r, card);
    }
  }

  function renderSnapshot(records, filteredOverride = null){
    clearColumns();
    const filtered = filteredOverride ?? (records||[]).filter(inRange);
    if (filteredOverride === null){
      updateMetrics(filtered, records);
    }
    countdownEntries.clear();
    if (countdownEntries.size === 0 && countdownInterval){
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    filtered.forEach(r => placeRecord(r));
  }

  function updateCardAppearance(card, status){
    const cls = clsForStatus(status);
    card.className = `disparo status-${cls}`;
    card.dataset.status = status;
    const badge = card.querySelector('[data-role="badge"]');
    if (badge) badge.textContent = status;
  }

  function updateCardCountdown(card, remainingMs){
    const target = card.querySelector('[data-restante]');
    if (target) target.textContent = formatRemainingLabel(remainingMs);
  }

  function ensureCountdownRunner(){
    if (countdownInterval) return;
    countdownInterval = setInterval(()=>{
      countdownEntries.forEach((entry, id) => {
        const remaining = remainingMsFromRecord(entry.record);
        updateCardCountdown(entry.element, remaining);
        if (remaining !== null && remaining <= 0){
          countdownEntries.delete(id);
          updateCardAppearance(entry.element, "Finalizado");
          triggerAutoFinalize(id);
        }
      });
      if (countdownEntries.size === 0 && countdownInterval){
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }, 1000);
  }

  function registerCountdown(record, element){
    const id = String(record.id || element.dataset.id || "");
    const status = (record.status || "").toLowerCase();
    const remaining = remainingMsFromRecord(record);
    updateCardCountdown(element, remaining);
    if (!id){ return; }
    if (status.includes("andamento")){
      autoFinalizedIds.delete(id);
    }
    if (!record.tempo || !record.atualizadoEm || status.includes("final") || status.includes("insu")){
      countdownEntries.delete(id);
      return;
    }
    countdownEntries.set(id, { record: { id: record.id, tempo: record.tempo, atualizadoEm: record.atualizadoEm, status: record.status }, element });
    ensureCountdownRunner();
  }

  async function triggerAutoFinalize(id){
    if (!id || autoFinalizedIds.has(id)) return;
    autoFinalizedIds.add(id);
    const record = (lastNonEmpty || []).find(r => `${r.id}` === `${id}`);
    if (!record) return;
    const status = (record.status || "").toLowerCase();
    if (status.includes("final") || status.includes("insu")) return;

    record.status = "Finalizado";
    record.atualizadoEm = new Date().toISOString();
    toast("Disparo finalizado automaticamente.", "ok", 2200, `auto-finish-${id}`);

    const rerender = () => softRender((lastNonEmpty || []).slice());
    const isTempId = String(record.id || "").startsWith("tmp_");

    if (!OFFLINE_MODE && isAuthed && record.id && !isTempId){
      try{
        const resp = await fetch(url(`/api/disparos/${record.id}`), {
          method: "PATCH",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify({ status: "Finalizado" })
        });
        if (resp.status === 401){
          isAuthed = false;
          localStorage.removeItem(AUTH_KEY);
          updateAuthUI();
          switchTab("login");
          toast("Sessão expirada ao finalizar automaticamente.", "warn", 3200, "auto-expired");
        }
      }catch{
        /* silencioso */
      }finally{
        setTimeout(rerender, 60);
      }
    }else{
      setTimeout(rerender, 60);
    }
  }

  /* ===== Modal ===== */
  const modal = document.getElementById('modal');
  const mClose = document.getElementById('mClose');
  const mTitle = document.getElementById('mTitle');
  const mSub   = document.getElementById('mSub');
  const mPill  = document.getElementById('mStatusPill');
  const mVolume= document.getElementById('mVolume');
  const mPotes = document.getElementById('mPotes');
  const mTempo = document.getElementById('mTempo');
  const mRest  = document.getElementById('mRestante');
  const mHora  = document.getElementById('mHora');
  const mTpl   = document.getElementById('mTpl');
  const mTag   = document.getElementById('mTag');
  const mTipo  = document.getElementById('mTipoDisparo');
  const mText  = document.getElementById('mText');
  const mCopy  = document.getElementById('mCopy');
  const mRefresh = document.getElementById('mRefresh');
  const mCycle = document.getElementById('mCycle');
  const modalTagEditor = document.getElementById('modalTagEditor');
  const mTagSelect = document.getElementById('mTagSelect');
  const mTagSave = document.getElementById('mTagSave');
  const modalTipoEditor = document.getElementById('modalTipoEditor');
  const mTipoSelect = document.getElementById('mTipoSelect');
  const mTipoSave = document.getElementById('mTipoSave');

  let currentRecord = null;
  let modalTimer = null;

  function openModal(r){
    currentRecord = r;
    mTitle.textContent = r.tipo || "(sem nome)";
    const dstr = r.atualizadoEm ? `Atualizado: ${new Date(r.atualizadoEm).toLocaleString()}` : "";
    mSub.textContent = dstr;

    const c = clsForStatus(r.status);
    mPill.className = `pill ${c}`;
    mPill.textContent = r.status || "Em andamento";

    mVolume.textContent = r.volume ?? "—";
    mPotes.textContent  = r.potes ?? "—";
    mTempo.textContent  = formatTempoLabel(r.tempo);
    mHora.textContent   = r.horario || "—";
    
    const tplName = (r.template || "").trim();
    // ===== ALTERAÇÃO 3: Usar o mapa para exibir o nome correto =====
    mTpl.textContent = TEMPLATE_DISPLAY_NAMES[tplName] || tplName || "(nenhum)";
    mText.textContent = tplText(tplName);

    const tagValue = (r.tag || "").trim();
    if (mTag) mTag.textContent = tagValue || "—";
    if (mTagSelect){
      mTagSelect.value = isValidTag(tagValue) ? tagValue : "";
      mTagSelect.disabled = !isAuthed;
    }
    if (mTagSave){
      mTagSave.disabled = !isAuthed;
    }
    if (modalTagEditor){
      modalTagEditor.style.display = isAuthed ? "" : "none";
    }

    const tipoDisparoValue = (r.tipoDisparo || "").trim();
    if (mTipo) mTipo.textContent = tipoDisparoValue || "—";
    if (mTipoSelect){
      mTipoSelect.value = isValidTipoDisparo(tipoDisparoValue) ? tipoDisparoValue : "";
      mTipoSelect.disabled = !isAuthed;
    }
    if (mTipoSave){
      mTipoSave.disabled = !isAuthed;
    }
    if (modalTipoEditor){
      modalTipoEditor.style.display = isAuthed ? "" : "none";
    }

    mRest.textContent = calcRestante(r);
    if (modalTimer) clearInterval(modalTimer);
    modalTimer = setInterval(() => {
      if (!currentRecord) return;
      mRest.textContent = calcRestante(currentRecord);
    }, 1000);
    mCycle.style.display = isAuthed ? "" : "none";

    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    if (modalTimer) { clearInterval(modalTimer); modalTimer = null; }
    currentRecord = null;
  }
  mClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  function calcRestante(r){
    if (!r) return "—";
    const status = (r.status || "").toLowerCase();
    if (status.includes("final")) return "Finalizado";
    if (status.includes("insu")) return "—";
    const remaining = remainingMsFromRecord(r);
    if (remaining === null) return "—";
    return formatRemainingLabel(remaining);
  }

  mCopy.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(mText.textContent || "");
      toast("Texto copiado!", "ok", 1800, "copy-ok");
    }catch{
      toast("Não consegui copiar 😕", "error");
    }
  });
  mRefresh.addEventListener('click', ()=> {
    if (currentRecord) {
      mRest.textContent = calcRestante(currentRecord);
      toast("Atualizado.", "ok", 1100, "upd");
    }
  });
  mCycle.addEventListener('click', async ()=>{
    if (!currentRecord) return;
    if (!isAuthed){ toast("Faça login para alterar.", "warn"); return; }
    const next = nextStatus(currentRecord.status || "Em andamento");
    try{
      const res = await fetch(url(`/api/disparos/${currentRecord.id}`), {
        method:"PATCH", headers:{"Content-Type":"application/json"}, credentials:"include",
        body: JSON.stringify({ status: next })
      });
      if (res.ok){
        toast("Status atualizado", "ok", 1300, "upd-status");
        setTimeout(softRefresh, 250);
        closeModal();
      }else if(res.status===401){
        isAuthed=false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        toast("Sessão expirada.", "warn");
      }else{
        toast("Falha ao atualizar status.", "error");
      }
    }catch{ toast("Rede instável.", "error"); }
  });

  if (mTagSave){
    mTagSave.addEventListener('click', async ()=>{
      if (!currentRecord) return;
      if (!isAuthed){ toast("Faça login para alterar.", "warn"); return; }
      const newTag = (mTagSelect?.value || "").trim();
      if (!isValidTag(newTag)){
        toast("Selecione uma tag válida.", "warn", 2200, "tag-invalid");
        return;
      }

      const applyLocal = () => {
        if (mTag) mTag.textContent = newTag || "—";
        if (mTagSelect) mTagSelect.value = newTag;
        if (currentRecord) currentRecord.tag = newTag;
        if (Array.isArray(lastNonEmpty)){
          const idx = lastNonEmpty.findIndex(r => `${r.id}` === `${currentRecord.id}`);
          if (idx >= 0){
            lastNonEmpty[idx] = { ...lastNonEmpty[idx], tag: newTag };
            currentRecord = lastNonEmpty[idx];
          }
        }
        softRender((lastNonEmpty || []).slice());
      };

      if (OFFLINE_MODE || !currentRecord.id || String(currentRecord.id).startsWith('tmp_')){
        applyLocal();
        toast("Tag atualizada localmente.", "warn", 2400, `tag-offline-${currentRecord.id || currentRecord.tipo || ''}`);
        return;
      }

      try{
        const resp = await fetch(url(`/api/disparos/${currentRecord.id}`), {
          method:"PATCH",
          headers:{"Content-Type":"application/json"},
          credentials:"include",
          body: JSON.stringify({ tag: newTag })
        });
        if (resp.status === 401){
          isAuthed = false;
          localStorage.removeItem(AUTH_KEY);
          updateAuthUI();
          switchTab("login");
          toast("Sessão expirada.", "warn", 2600, "tag-auth");
          return;
        }
        if (!resp.ok){
          const msg = await resp.text().catch(() => "");
          console.error("Falha ao atualizar tag", msg || resp.status);
          toast("Não consegui atualizar a tag.", "error", 2600, "tag-error");
          return;
        }
        applyLocal();
        toast("Tag atualizada.", "ok", 2000, `tag-ok-${currentRecord.id}`);
        setTimeout(softRefresh, 300);
      }catch(err){
        console.error("Erro de rede ao atualizar tag", err);
        toast("Rede instável ao atualizar tag.", "error", 2600, "tag-network");
      }
    });
  }

  if (mTipoSave){
    mTipoSave.addEventListener('click', async () => {
      if (!currentRecord) return;
      if (!isAuthed){ toast("Faça login para alterar.", "warn"); return; }
      const newTipo = (mTipoSelect?.value || "").trim();
      if (!isValidTipoDisparo(newTipo)){
        toast("Selecione um tipo válido.", "warn", 2200, "tipo-invalid");
        return;
      }

      const applyLocal = () => {
        if (mTipo) mTipo.textContent = newTipo || "—";
        if (mTipoSelect) mTipoSelect.value = newTipo;
        if (currentRecord) currentRecord.tipoDisparo = newTipo;
        if (Array.isArray(lastNonEmpty)){
          const idx = lastNonEmpty.findIndex(r => `${r.id}` === `${currentRecord.id}`);
          if (idx >= 0){
            lastNonEmpty[idx] = { ...lastNonEmpty[idx], tipoDisparo: newTipo };
            currentRecord = lastNonEmpty[idx];
          }
        }
        softRender((lastNonEmpty || []).slice());
      };

      if (OFFLINE_MODE || !currentRecord.id || String(currentRecord.id).startsWith('tmp_')){
        applyLocal();
        toast("Tipo atualizado localmente.", "warn", 2400, `tipo-offline-${currentRecord.id || currentRecord.tipo || ''}`);
        return;
      }

      try{
        const resp = await fetch(url(`/api/disparos/${currentRecord.id}`), {
          method:"PATCH",
          headers:{"Content-Type":"application/json"},
          credentials:"include",
          body: JSON.stringify({ tipoDisparo: newTipo })
        });
        if (resp.status === 401){
          isAuthed = false;
          localStorage.removeItem(AUTH_KEY);
          updateAuthUI();
          switchTab("login");
          toast("Sessão expirada.", "warn", 2600, "tipo-auth");
          return;
        }
        if (!resp.ok){
          const msg = await resp.text().catch(() => "");
          console.error("Falha ao atualizar tipo", msg || resp.status);
          toast("Não consegui atualizar o tipo.", "error", 2600, "tipo-error");
          return;
        }
        applyLocal();
        toast("Tipo atualizado.", "ok", 2000, `tipo-ok-${currentRecord.id}`);
        setTimeout(softRefresh, 300);
      }catch(err){
        console.error("Erro de rede ao atualizar tipo", err);
        toast("Rede instável ao atualizar tipo.", "error", 2600, "tipo-network");
      }
    });
  }

  /* ============= Data (Cache + SSE + Polling Backoff) ========= */
  const CACHE_KEY = "painel_snapshot_v2";
  const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6h

  (function paintFromCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return;
      const {ts, data} = JSON.parse(raw);
      if (!data || (Date.now() - ts) > CACHE_TTL_MS) return;
      lastNonEmpty = data;
      lastHash = calcHash(data);
      renderSnapshot(data);
      clearTimeout(splashTimer);
      hideSplashSoon();
      gotFirstPaint = true;
    }catch{}
  })();

  function saveCache(records){
    try{
      const payload = { ts: Date.now(), data: records };
      (window.requestIdleCallback || setTimeout)(() =>
        localStorage.setItem(CACHE_KEY, JSON.stringify(payload)), 0
      );
    }catch{}
  }

  function softRender(records){
    const filtered = (records||[]).filter(inRange);
    updateMetrics(filtered, records);
    const incomingHash = calcHash(filtered);
    if (incomingHash === lastHash) return;
    renderSnapshot(records, filtered);
    lastHash = incomingHash;
    if ((records?.length || 0) > 0) { lastNonEmpty = records; saveCache(records); }
    if (!gotFirstPaint){ gotFirstPaint = true; clearTimeout(splashTimer); hideSplashSoon(); }
  }

  async function loadInitial(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetchWithTimeout(url("/api/disparos"), {cache:"no-store", credentials:"include"}, 3000);
      if (!resp.ok) throw new Error(resp.status);
      const data = await resp.json();
      softRender(data);
      if (!gotFirstPaint){
        gotFirstPaint = true;
        clearTimeout(splashTimer);
        hideSplashSoon();
      }
    }catch(e){
      console.error("Falha ao carregar disparos:", e);
      if (!gotFirstPaint){
        gotFirstPaint = true;
        clearTimeout(splashTimer);
        hideSplashSoon();
      }
    }
  }

  async function softRefresh(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
      if (!resp.ok) return;
      const data = await resp.json();
      softRender(data);
    }catch{}
  }

  function startPolling(){
    if (OFFLINE_MODE) return;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
        if (resp.ok){
          const data = await resp.json();
          softRender(data);
          backoffMs = Math.max(5000, Math.floor(backoffMs/2));
        }
      }catch{}
    }, backoffMs);
    backoffMs = Math.min(backoffMs * 2, 30000);
  }
  function stopPolling(){ if (pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

  function startSSE(){
    if (OFFLINE_MODE) return;
    try{
      if (sse) sse.close();
      sse = new EventSource(url("/api/stream"));
      sse.onmessage = (evt) => {
        try{
          const payload = JSON.parse(evt.data);
          if (payload.type === "snapshot") softRender(payload.records || []);
        }catch{}
      };
      sse.onerror = () => { startPolling(); };
    }catch{ startPolling(); }
  }
  function stopSSE(){ if (sse){ try{sse.close();}catch{} sse=null; } }

  /* ======================== FORM ADD ========================== */
  const form = document.getElementById("formDisparo");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = document.getElementById("datePick").value;
    if (!data) {
      toast("Por favor, selecione uma data no filtro.", "warn");
      return;
    }

    const tipo     = document.getElementById("tipo").value.trim();
    let tempoHoras = parseInt(document.getElementById("tempoHoras").value || "0", 10);
    let tempoMin   = parseInt(document.getElementById("tempoMinutos").value || "0", 10);
    tempoHoras = isNaN(tempoHoras) ? 0 : Math.max(0, tempoHoras);
    tempoMin   = isNaN(tempoMin) ? 0 : tempoMin;
    if (tempoMin < 0 || tempoMin > 59){ toast("Minutos devem estar entre 0 e 59.", "warn"); return; }
    const tempo    = (tempoHoras * 60) + tempoMin;
    const potes    = Number(document.getElementById("potes").value);
    const horario  = document.getElementById("horario").value;
    const template = document.getElementById("template").value;
    const tag      = document.getElementById("tag").value;
    const tipoDisparo = document.getElementById("tipoDisparo").value;
    const volume   = Number(document.getElementById("volume").value || 0);

    if(!tipo && !template){ toast("Preencha o nome do disparo ou escolha um template.", "warn"); return; }
    if(tempo <= 0){ toast("Informe um tempo médio válido.", "warn"); return; }
    if(!isValidTag(tag)){ toast("Selecione uma tag válida.", "warn"); return; }
    if(!isValidTipoDisparo(tipoDisparo)){ toast("Selecione um tipo válido.", "warn"); return; }

    const optimisticRecord = {
      id: uid(),
      tipo,
      tempo,
      potes,
      horario,
      status:"Em andamento",
      template,
      volume,
      tag,
      tipoDisparo,
      data: data,
      atualizadoEm: new Date().toISOString()
    };
    
    (lastNonEmpty = lastNonEmpty || []).push(optimisticRecord);
    softRender(lastNonEmpty);

    if (OFFLINE_MODE) { e.target.reset(); return; }
    if(!isAuthed){
      toast("Você está em modo leitura. Faça login para adicionar.", "warn", 3000, "readonly-add");
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      softRender(lastNonEmpty);
      return;
    }

    const payload = {
      tipo: optimisticRecord.tipo,
      tempo: optimisticRecord.tempo,
      potes: optimisticRecord.potes,
      horario: optimisticRecord.horario,
      status: optimisticRecord.status,
      template: optimisticRecord.template,
      volume: optimisticRecord.volume,
      tag: optimisticRecord.tag,
      tipoDisparo: optimisticRecord.tipoDisparo,
      data: optimisticRecord.data
    };

    try{
      const resp = await fetch(url("/api/disparos"), {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify(payload)
      });
      if (!resp.ok){
        if (resp.status === 401){
          toast("Sessão expirada. Faça login novamente.", "warn", 3200, "sessao");
          isAuthed = false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        } else {
          const errData = await resp.json();
          const errMsg = errData?.error?.message || "Não consegui salvar no servidor.";
          toast(errMsg, "error", 4000);
          console.error("Erro do servidor:", errData);
        }
        lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
        softRender(lastNonEmpty);
      } else {
        e.target.reset();
        toast("Disparo adicionado!", "ok");
        setTimeout(softRefresh, 300);
      }
    }catch(err){
      toast("Falha de rede ao salvar.", "error");
      console.error("Falha na requisição:", err);
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      softRender(lastNonEmpty);
    }
  });

  /* ====================== LOGIN / LOGOUT ====================== */
  const loginForm = document.getElementById("loginForm");
  const btnLogin  = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const u = (document.getElementById("loginUser").value || "").trim();
    const p = (document.getElementById("loginPass").value || "").trim();

    if (!u || !p){ return; }
    btnLogin.disabled = true;

    if (u !== "energia" || p !== "energia1") {
      toast("Usuário ou senha inválidos.", "error");
      btnLogin.disabled = false;
      return;
    }

    isAuthed = true; localStorage.setItem(AUTH_KEY, "1"); updateAuthUI(); switchTab("painel");

    try{
      const r = await fetch(url("/api/login"), {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({ username:u, password:p })
      });
      if (!r.ok){
        toast("Não consegui criar sessão segura no servidor.", "warn");
      }else{
        setTimeout(softRefresh, 150);
      }
    }catch{
      toast("Rede instável ao criar sessão.", "warn");
    }finally{
      btnLogin.disabled = false;
    }
  });

  btnLogout.addEventListener("click", () => {
    isAuthed = false; localStorage.removeItem(AUTH_KEY);
    updateAuthUI(); switchTab("login");
    stopSSE(); stopPolling();

    const u = document.getElementById("loginUser"), p = document.getElementById("loginPass");
    if (p) p.value = ""; if (u) { u.value = ""; u.focus(); }

    try{ fetch(url("/api/logout"), { method:"POST", credentials:"include" }); }catch{}
    setTimeout(()=>{ startSSE(); }, 300);
  });

  /* ======================= DATE FILTER UI ===================== */
  (() => {
    const dp = document.getElementById('datePick');
    if (!dp) return;
    
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayString = `${yyyy}-${mm}-${dd}`;
    
    dp.value = todayString;
    setRange(todayString);
    
    dp.addEventListener('change', () => {
      setRange(dp.value || "all");
    });
  })();

  /* ========================== START =========================== */
  (async () => {
    switchTab("painel");
    updateAuthUI();

    if (OFFLINE_MODE) { clearTimeout(splashTimer); hideSplashSoon(); return; }

    startSSE();
    loadInitial();
  })();
  </script>
</body>
</html>
