<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
  :root{
    --bg:#f4f6f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
    --primary:#0b4a8f; --primary-2:#0f6ad8;
    --accent-1:#0f6ad8; --accent-2:#10b981; --accent-3:#f97316;
    --andamento:#ff9f1a; --finalizado:#1fb36a; --insucesso:#e23b3b;
    --warn:#fbbf24; --error:#ef4444; --ok:#10b981;
  }
  html.dark {
      --bg: #0f172a;
      --card: #1f2937;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --border: #273249;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg); color: var(--text); margin:0; display:flex; flex-direction:column; min-height:100vh;
    position:relative; overflow-x:hidden;
    transition: background-color .3s, color .3s;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(1100px circle at 15% -10%, rgba(15,106,216,.18), transparent 60%),
      radial-gradient(820px circle at 90% 0%, rgba(16,185,129,.18), transparent 65%),
      linear-gradient(180deg, rgba(255,255,255,.92), rgba(244,246,249,.96));
    transition: opacity .3s ease;
  }
  html.dark body::before{
    background:
      radial-gradient(900px circle at 12% -10%, rgba(37,99,235,.25), transparent 58%),
      radial-gradient(800px circle at 85% 5%, rgba(16,185,129,.18), transparent 62%),
      linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.96));
  }
  body > *{position:relative; z-index:1;}
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px 56px;width:100%;flex:1}

  .app-header{margin:0;padding:24px 16px 0}
  .app-banner{
    display:flex; align-items:center; justify-content:space-between; gap:18px;
    background:var(--card); border:1px solid rgba(15,106,216,.18); border-radius:22px;
    box-shadow:0 24px 40px -24px rgba(15,106,216,.45);
    padding:24px 28px; position:relative; overflow:hidden;
  }
  .app-banner::after{
    content:""; position:absolute; inset:auto -70px -80px auto; width:220px; height:220px;
    background:radial-gradient(circle at center, rgba(15,106,216,.28) 0%, transparent 70%);
    opacity:.65; transform:rotate(-12deg);
  }
  html.dark .app-banner{border-color:rgba(37,99,235,.35); box-shadow:0 28px 55px -30px rgba(15,23,42,.9);}
  html.dark .app-banner::after{background:radial-gradient(circle at center, rgba(37,99,235,.35) 0%, transparent 70%);}
  .brand{display:flex; align-items:center; gap:16px;}
  .brand-icon{
    width:60px; height:60px; border-radius:20px; display:grid; place-items:center; color:#fff;
    background:linear-gradient(135deg,var(--primary),var(--primary-2));
    box-shadow:0 18px 32px -18px rgba(15,106,216,.6);
  }
  .brand-icon svg{width:30px; height:30px;}
  .app-title{margin:0; font-size:26px; letter-spacing:.3px; color:var(--text);}
  .app-subtitle{margin:4px 0 0; color:var(--muted); font-size:14px;}
  .header-actions{display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:flex-end;}
  .header-nav{display:flex; align-items:center; gap:8px;}
  .header-chip{
    background:rgba(15,106,216,.12); color:var(--primary);
    border-radius:999px; padding:8px 14px; font-weight:600; font-size:12px;
    border:1px solid rgba(15,106,216,.18);
    display:flex; align-items:center; gap:6px;
  }
  .header-chip svg{width:16px; height:16px;}
  .header-chip{
    background:rgba(15,106,216,.12); color:var(--primary);
    border-radius:999px; padding:8px 16px; font-weight:600; font-size:13px;
    border:1px solid rgba(15,106,216,.18);
    display:flex; align-items:center; gap:6px;
  }
  html.dark .header-chip{background:rgba(37,99,235,.18); color:#bfdbfe; border-color:rgba(59,130,246,.35);}

  /* Theme Toggle */
  .theme-toggle-wrap { display:flex; justify-content:flex-end; padding-top: 12px; }
  .theme-toggle {
      background: rgba(226,232,240,.9);
      border: 1px solid var(--border);
      color: var(--text);
      width: 40px; height: 40px;
      border-radius: 999px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; padding: 0;
      transition: background .2s, transform .2s, border-color .2s;
  }
  .theme-toggle:hover { transform: scale(1.05); }
  .theme-toggle svg { width: 20px; height: 20px; }
  html.dark .theme-toggle { background: #374151; color: var(--text); }
  html.dark .theme-toggle:hover { background: #4b5563; }

  .tabs{display:flex; gap:12px; justify-content:center; margin:16px 0 0; flex-wrap:wrap}
  .tab{
    background:var(--card); border:1px solid var(--border); color:var(--text);
    padding:6px 14px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px; letter-spacing:.15px;
    padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:700; font-size:13px; letter-spacing:.2px;
    transition:transform .15s ease, box-shadow .2s ease, background-color .2s, color .2s, border-color .2s;
  }
  .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 12px rgba(15,106,216,.15) }
  .tab.active{ border-color: var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.16); background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; }

  .metrics{display:grid; grid-template-columns:repeat(auto-fit, minmax(210px,1fr)); gap:16px; margin:22px 0 14px;}
  .metric-card{
    background:var(--card); border:1px solid rgba(15,106,216,.12); border-radius:18px; padding:18px 20px;
    box-shadow:0 22px 38px -26px rgba(15,106,216,.55); position:relative; overflow:hidden;
    display:flex; flex-direction:column; gap:10px; min-height:140px;
  }
  .metric-card::after{
    content:""; position:absolute; inset:auto -40px -80px auto; width:160px; height:160px; border-radius:40%;
    background:radial-gradient(circle, rgba(15,106,216,.22) 0%, transparent 70%);
    opacity:.6; z-index:0;
  }
    .metric-card.content-success::after{background:radial-gradient(circle, rgba(16,185,129,.24) 0%, transparent 70%);}
    .metric-card.content-warn::after{background:radial-gradient(circle, rgba(249,115,22,.24) 0%, transparent 70%);}
    .metric-card.content-error::after{background:radial-gradient(circle, rgba(220,38,38,.24) 0%, transparent 70%);}
  html.dark .metric-card{border-color:rgba(59,130,246,.25); box-shadow:0 30px 55px -32px rgba(15,23,42,.9);}
  html.dark .metric-card::after{opacity:.35;}
  .metric-icon{width:42px; height:42px; border-radius:14px; display:grid; place-items:center; color:#fff; z-index:1;}
  .metric-icon svg{width:22px; height:22px;}
  .icon-total{background:linear-gradient(135deg,var(--primary),var(--primary-2));}
  .icon-progress{background:linear-gradient(135deg,#f59e0b,#f97316);}
  .icon-done{background:linear-gradient(135deg,#059669,#10b981);}
  .icon-error{background:linear-gradient(135deg,#dc2626,#ef4444);}
  .metric-label{font-size:12px; letter-spacing:.15em; text-transform:uppercase; color:var(--muted); z-index:1;}
  .metric-value{font-size:34px; font-weight:800; line-height:1; z-index:1;}
  .metric-foot{font-size:13px; color:var(--muted); margin-top:auto; z-index:1;}
  html.dark .metric-label, html.dark .metric-foot{color:#9ca3af;}

  .legenda{display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:12px 0 6px}
  .legenda-item{display:flex; align-items:center; gap:8px; font-weight:600; background:var(--card); padding:6px 10px; border-radius:12px; box-shadow:0 12px 28px -22px rgba(15,106,216,.65); border:1px solid var(--border); font-size:13px}
  html.dark .legenda-item{border-color:rgba(59,130,246,.25); box-shadow:0 14px 30px -24px rgba(15,23,42,.9);}
  .cor{width:12px;height:12px;border-radius:3px;display:inline-block}
  .cor.andamento{background:var(--andamento)} .cor.finalizado{background:var(--finalizado)} .cor.insucesso{background:var(--insucesso)}

  .form-container{background:var(--card); border:1px solid var(--border); padding:22px; margin:20px 0; border-radius:18px; box-shadow:0 25px 45px -30px rgba(15,106,216,.45); backdrop-filter:blur(4px)}
  html.dark .form-container{background:rgba(17,24,39,.92); border-color:rgba(59,130,246,.25);}
  .form-container h2{margin:0 0 12px; color:var(--primary); font-size:18px}
  html.dark .form-container h2{color:#93c5fd;}
  .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
  .form-grid > .full{grid-column:1 / -1}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
  input,select,button{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
    background:rgba(255,255,255,.88); color:var(--text); font-size:13px;
    transition:border-color .2s ease, box-shadow .2s ease, background-color .2s;
  }
  .tempo-group{
    display:flex; align-items:center; gap:6px; border:1px solid var(--border);
    border-radius:12px; padding:6px 10px; background:rgba(255,255,255,.88);
  }
  .tempo-group input{
    width:60px; border:none; padding:4px 6px; background:transparent; text-align:center; font-weight:600;
  }
  .tempo-group input[type="number"]::-webkit-outer-spin-button,
  .tempo-group input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .tempo-group input[type="number"]{ -moz-appearance: textfield; }
  .tempo-sep{font-size:12px; color:var(--muted); font-weight:600;}
  html.dark input, html.dark select {
    background: #1f2937;
    border-color: #374151;
    color:var(--text);
  }
  html.dark .tempo-group{background:#1f2937; border-color:#374151;}
  html.dark .tempo-group input{color:var(--text);}
  input:focus, select:focus{outline:none; border-color:var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.15); background:#fff;}
  .tempo-group:focus-within{border-color:var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.15);}
  .tempo-group input:focus{outline:none; box-shadow:none;}
  input:focus, select:focus{outline:none; border-color:var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.15); background:#fff;}
  html.dark input:focus, html.dark select:focus{background:#111827;}
  button{background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer; letter-spacing:.2px; box-shadow:0 16px 28px -20px rgba(15,106,216,.6); transition:transform .2s ease, box-shadow .2s ease;}
  button:hover{transform:translateY(-1px); box-shadow:0 20px 36px -22px rgba(15,106,216,.6);}

  .badge-info{display:inline-block; background:rgba(15,106,216,.08); border:1px dashed rgba(15,106,216,.2); color:var(--muted); padding:6px 10px; border-radius:12px; font-size:12px; margin-top:6px}
  html.dark .badge-info{background:rgba(37,99,235,.18); border-color:rgba(59,130,246,.35); color:#bfdbfe;}

  .table-card{background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 26px 50px -32px rgba(15,106,216,.45); overflow:hidden; backdrop-filter:blur(4px)}
  html.dark .table-card{background:rgba(17,24,39,.95); border-color:rgba(59,130,246,.25);}
  .grid{display:grid; grid-template-columns: 140px repeat(4, minmax(180px,1fr)); width:100%; position:relative}
  .grid::after{
    content:""; position:absolute; inset:0; background:linear-gradient(135deg, rgba(15,106,216,.04), transparent 70%);
    pointer-events:none;
  }
  .grid > div{border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:12px; min-height:68px; background:rgba(255,255,255,.9); position:relative; z-index:1}
  html.dark .grid > div{background:rgba(15,23,42,.92); border-color:rgba(59,130,246,.25);}
  .header{background:rgba(15,106,216,.08); color:#0f172a; font-weight:800; text-transform:uppercase; text-align:center; font-size:12px}
  html.dark .header { background: rgba(37,99,235,.18); color: #d1d5db; }

  .disparo{border-radius:14px; padding:12px; margin:8px 0; color:#fff; box-shadow:0 10px 22px -12px rgba(0,0,0,.4); cursor:pointer;transition:transform .15s ease, box-shadow .2s ease; animation:pop .18s ease-out both; font-size:13px}
  .disparo:hover{ transform:translateY(-4px); box-shadow:0 20px 28px -18px rgba(0,0,0,.35) }
  .disparo[aria-busy="true"]{ filter:grayscale(.25); opacity:.75; cursor:wait }
  .status-andamento{ background:var(--andamento) } .status-finalizado{ background:var(--finalizado) } .status-insucesso{ background:var(--insucesso) }
  .badge{ font-size:10px; font-weight:800; padding:3px 6px; border-radius:999px; background:rgba(255,255,255,.25); margin-bottom:4px; display:inline-block }
  .title{font-weight:800; font-size:13px; margin-bottom:2px} .meta{font-size:11.5px; opacity:.95}
  @keyframes pop{from{opacity:0; transform:translateY(4px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}

  .login-card{background:var(--card); border:1px solid var(--border); padding:20px; margin:18px auto; border-radius:18px; max-width:420px; box-shadow:0 18px 32px -24px rgba(15,106,216,.35)}
  html.dark .login-card{background:rgba(17,24,39,.92); border-color:rgba(59,130,246,.25); box-shadow:0 22px 40px -28px rgba(15,23,42,.9);}
  .login-title{margin:0 0 10px; color:var(--primary); text-align:center; font-size:18px}
  html.dark .login-title{color:#93c5fd;}
  .login-actions{display:flex; gap:8px; margin-top:8px}

  .footer{width:100%; background:rgba(255,255,255,.92); border-top:1px solid var(--border); color:var(--muted); font-size:12px; text-align:center; padding:14px}
  html.dark .footer{background:rgba(17,24,39,.95); border-color:rgba(59,130,246,.18); color:#94a3b8;}

  /* Splash/Spinner */
  .splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:9999; transition:opacity .25s ease, background-color .3s}
  .splash.hide{ opacity:0; pointer-events:none }
  .ring{ width:40px; height:40px; border:3px solid #e5e7eb; border-top-color:var(--primary-2); border-radius:50%; animation:spin 1s linear infinite }
  html.dark .ring { border-color: #374151; border-top-color: var(--primary-2); }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* ===== Toast (Suavizado) ===== */
  .topbar{position:fixed; top:16px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:8px; z-index:9999; pointer-events:none}
  .toast{
      pointer-events:auto; padding:10px 16px; border-radius:12px;
      border: 1px solid var(--border);
      background:var(--card);
      box-shadow:0 10px 25px -5px rgba(0,0,0,.1), 0 8px 10px -6px rgba(0,0,0,.1);
      font-size:14px; display:flex; align-items:center; gap:10px;
      animation: slideIn .3s ease-out both;
  }
  .toast-icon { width: 20px; height: 20px; }
  .toast.warn{ border-color:rgba(251, 191, 36, 0.5); background:#fffbeb; color:#92400e; }
  .toast.warn .toast-icon { color: #f59e0b; }
  .toast.error{ border-color:rgba(239, 68, 68, 0.5); background:#fef2f2; color:#991b1b; }
  .toast.error .toast-icon { color: #ef4444; }
  .toast.ok{ border-color:rgba(16, 185, 129, 0.5); background:#f0fdf4; color:#065f46; }
  .toast.ok .toast-icon { color: #10b981; }
  .toast button{background:transparent; color:inherit; border:none; cursor:pointer; padding:0 4px; font-weight:700; opacity:0.6; margin-left:auto;}
  .toast button:hover{ opacity:1; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
  html.dark .toast { background: #374151; border-color: #4b5563; color: var(--text); }
  html.dark .toast.warn { background: #422006; color: #fef3c7; border-color: #78350f; }
  html.dark .toast.error { background: #4c0519; color: #fee2e2; border-color: #881337; }
  html.dark .toast.ok { background: #064e3b; color: #d1fae5; border-color: #047857; }

  /* ===== Filtro por data (Aprimorado) ===== */
  .date-filters{
    display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:center;
    margin:18px 0 12px; background:rgba(255,255,255,.92); padding:12px 16px; border-radius:14px;
    box-shadow:0 16px 28px -26px rgba(15,106,216,.45); border:1px solid var(--border);
  }
  html.dark .date-filters{background:rgba(17,24,39,.9); border-color:rgba(59,130,246,.25); box-shadow:0 18px 30px -28px rgba(15,23,42,.9);}
  .date-filter-group{
    display:flex; align-items:center; gap:8px; background:#f8fafc;
    border:1px solid var(--border); border-radius:10px; padding:6px 10px;
  }
  html.dark .date-filter-group { background: #111827; border-color:#1f2937; }
  .date-filter-group .label{ color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.08em; }
  .date-filters input[type="date"]{
    background:transparent; border:none; color:var(--text); font-size:13px; padding:2px;
  }
  .date-filters input[type="date"]:focus{ outline:none; }
  .date-filters input[type="date"]::-webkit-calendar-picker-indicator{ cursor:pointer; opacity:0.6; }
  .date-filters input[type="date"]::-webkit-calendar-picker-indicator:hover{ opacity:1; }
  html.dark .date-filters input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1); }

  /* ===== Modal (Repaginado) ===== */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15, 23, 42, 0.6); z-index:10000; backdrop-filter: blur(4px);}
  .modal.show{display:flex}
  .modal-card{
    width:min(720px, calc(100% - 24px));
    background: var(--card);
    border-radius: 16px;
    box-shadow:0 25px 50px -12px rgba(0,0,0,.25); overflow:hidden;
    animation:pop .25s cubic-bezier(0.165, 0.84, 0.44, 1) both; position:relative;
    border: 1px solid var(--border);
  }
  html.dark .modal-card { background: #1f2937; }
  .modal-header{
    padding: 16px 20px;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    position:relative;
  }
  html.dark .modal-header { background: #111827; }
  .modal-title-wrapper { display: flex; align-items: center; gap: 12px; }
  .modal-title{margin:0; font-weight:800; font-size: 18px; color: var(--text); }
  .modal-sub{margin: 2px 0 0; font-size:12px; opacity:.75; color: var(--muted); }
  .modal-close{
    position:absolute; top: 12px; right: 12px; width:32px; height:32px;
    display:flex; align-items:center; justify-content:center;
    background: #f1f5f9; border:1px solid #e2e8f0;
    border-radius:999px; color:var(--muted); font-weight:900; cursor:pointer; line-height:1; font-size:16px;
    transition: background-color .2s, color .2s;
  }
  .modal-close:hover{ background-color: #e2e8f0; color: var(--text); }
  html.dark .modal-close { background: #374151; border-color: #4b5563; color: var(--muted); }
  html.dark .modal-close:hover { background: #4b5563; color: var(--text); }
  .modal-body{ padding: 20px; max-height: calc(90vh - 80px); overflow-y: auto;}

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding: 6px 12px; border-radius:999px; font-weight:700; font-size:12px;
    text-transform: uppercase; letter-spacing: .5px;
  }
  .pill.andamento{ background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
  .pill.finalizado{ background: #f0fdf4; color: #065f46; border: 1px solid #bbf7d0; }
  .pill.insucesso{ background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

  .info-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin: 16px 0; }
  .info-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
  html.dark .info-item { background: #111827; }
  .info-item b{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; }
  .info-item span { font-size: 16px; font-weight: 600; color: var(--text); }

  .template-box{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-top:16px }
  html.dark .template-box { background: #111827; }
  .template-header { display:flex;align-items:center;justify-content:space-between;gap:8px; }
  .template-header b { font-size: 16px; }

  .btns{ display:flex; flex-wrap:wrap; gap:8px; }
  .btn{
    background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; border:none; border-radius:12px;
    padding:10px 16px; font-weight:700; cursor:pointer;
    box-shadow:0 12px 25px -18px rgba(15,106,216,.55);
    font-size:13px; transition: transform .15s, box-shadow .15s;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 16px 30px -18px rgba(15,106,216,.55); }
  .btn.ghost{ background:var(--card); color:var(--primary); border:1px solid var(--primary); box-shadow:none; }
  .btn.ghost:hover { background: #f0f9ff; }
  html.dark .btn.ghost { background: #1e293b; color: #60a5fa; border-color: #2563eb; }
  html.dark .btn.ghost:hover { background: #334155; }
  .btn.warn{ background:linear-gradient(90deg,#f97316,#fb923c); }
  .btn.success{ background:linear-gradient(90deg,#059669,#10b981); }

  #mText {
    white-space:pre-wrap; font-family:inherit; margin:16px 0 0;
    background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0;
    line-height: 1.6; color: #334155;
  }
  html.dark #mText { background: #1f2937; border-color: var(--border); color: var(--muted); }
  .template-vars { color:var(--muted); font-size:12px; margin-top:12px; background: #f1f5f9; padding: 8px; border-radius: 8px; }
  html.dark .template-vars { background: #374151; }

  @media (max-width: 860px){
    .app-banner{flex-direction:column; align-items:flex-start; gap:18px;}
    .header-actions{width:100%; justify-content:space-between; flex-direction:column; align-items:flex-start; gap:10px;}
    .header-nav{width:100%; flex-wrap:wrap; justify-content:flex-start;}
    .header-actions{width:100%; justify-content:space-between;}
    .metrics{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
    .grid{grid-template-columns: repeat(2, minmax(160px,1fr));}
    .grid > div:nth-child(1){border-top-left-radius:18px;}
  }
</style>

</head>
<body>
  <div id="splash" class="splash"><div class="ring" aria-label="Carregando"></div></div>
  <div id="topbar" class="topbar" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <div class="app-banner">
      <div class="brand">
        <span class="brand-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5h18M4.5 12h15M6 16.5h12" />
          </svg>
        </span>
        <div>
          <h1 class="app-title">Painel de Disparos</h1>
          <p class="app-subtitle">Monitoramento em tempo real dos disparos</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="header-nav" role="tablist" aria-label="Navegação principal">
          <button class="tab active" type="button" data-tab="painel">Painel</button>
          <button class="tab" type="button" data-tab="login">Login</button>
        </div>
        <span class="header-chip" id="currentTimeChip" aria-live="polite">—</span>
        <span class="header-chip">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <p class="app-subtitle">Monitoramento em tempo real dos chamados</p>
        </div>
      </div>
      <div class="header-actions">
        <span class="header-chip">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span id="currentDateChip">—</span>
        </span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="theme-toggle-wrap">
      <button id="themeToggle" class="theme-toggle" title="Alternar tema"></button>
    </div>

    <section class="metrics" aria-live="polite" aria-label="Resumo do dia">
      <article class="metric-card">
        <span class="metric-icon icon-total" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5h15v15h-15z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9h6v6H9z" />
          </svg>
        </span>
        <span class="metric-label">Total de disparos</span>
        <strong class="metric-value" id="metricTotal">0</strong>
        <span class="metric-foot" id="metricsRangeLabel">Nenhum dia selecionado</span>
      </article>
      <article class="metric-card content-warn">
        <span class="metric-icon icon-progress" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5l7.5-7.5L18 13.5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12" />
          </svg>
        </span>
        <span class="metric-label">Em andamento</span>
        <strong class="metric-value" id="metricAndamento">0</strong>
        <span class="metric-foot">Disparos ativos</span>
      </article>
      <article class="metric-card content-success">
        <span class="metric-icon icon-done" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        </span>
        <span class="metric-label">Finalizados</span>
        <strong class="metric-value" id="metricFinalizado">0</strong>
        <span class="metric-foot">Disparos concluídos</span>
      </article>
      <article class="metric-card content-error">
        <span class="metric-icon icon-error" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.008v.008H12z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </span>
        <span class="metric-label">Insucessos</span>
        <strong class="metric-value" id="metricInsucesso">0</strong>
        <span class="metric-foot">Atenção necessária</span>
      </article>
    </section>

    <section class="metrics" aria-live="polite" aria-label="Resumo do dia">
      <article class="metric-card">
        <span class="metric-icon icon-total" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5h15v15h-15z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9h6v6H9z" />
          </svg>
        </span>
        <span class="metric-label">Total de disparos</span>
        <strong class="metric-value" id="metricTotal">0</strong>
        <span class="metric-foot" id="metricsRangeLabel">Nenhum dia selecionado</span>
      </article>
      <article class="metric-card content-warn">
        <span class="metric-icon icon-progress" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5l7.5-7.5L18 13.5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12" />
          </svg>
        </span>
        <span class="metric-label">Em andamento</span>
        <strong class="metric-value" id="metricAndamento">0</strong>
        <span class="metric-foot">Chamados ativos</span>
      </article>
      <article class="metric-card content-success">
        <span class="metric-icon icon-done" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        </span>
        <span class="metric-label">Finalizados</span>
        <strong class="metric-value" id="metricFinalizado">0</strong>
        <span class="metric-foot">Chamados resolvidos</span>
      </article>
      <article class="metric-card content-error">
        <span class="metric-icon icon-error" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.008v.008H12z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </span>
        <span class="metric-label">Insucessos</span>
        <strong class="metric-value" id="metricInsucesso">0</strong>
        <span class="metric-foot">Atenção necessária</span>
      </article>
    </section>

    <div id="dateFilters" class="date-filters">
        <div class="date-filter-group">
            <span class="label">Data:</span>
            <input type="date" id="datePick" title="Escolher dia" />
        </div>
    </div>

    <section id="view-painel">
      <div class="legenda">
        <div class="legenda-item"><span class="cor andamento"></span> Em andamento</div>
        <div class="legenda-item"><span class="cor finalizado"></span> Finalizado</div>
        <div class="legenda-item"><span class="cor insucesso"></span> Insucesso</div>
      </div>

      <div id="form-wrapper" class="form-container" style="display:none;">
        <h2>Novo Disparo</h2>
        <form id="formDisparo" class="form-grid">
          <div>
            <label for="tipo">Nome do Disparo</label>
            <input type="text" id="tipo" placeholder="Ex.: Lote Preventivo" />
          </div>
          <div>
            <label for="template">Template</label>
            <select id="template">
              <option value="">(nenhum)</option>
              <option value="preventivo_d0">Preventivo D0</option>
              <option value="preventivo_d3_d10">Preventivo D3 e D10</option>
              <option value="vencidos_1">Vencidos 1</option>
              <option value="vencidos_2">Vencidos 2</option>
              <option value="vencidos_5">Vencidos 5</option>
            </select>
          </div>
          <div>
            <label for="volume">Volume (qtd disparos)</label>
            <input type="number" id="volume" min="0" placeholder="Ex.: 120"/>
          </div>
          <div>
            <label for="tempoHoras">Tempo Médio</label>
            <div class="tempo-group">
              <input type="number" id="tempoHoras" min="0" max="23" placeholder="0" aria-label="Horas" />
              <span class="tempo-sep">h</span>
              <input type="number" id="tempoMinutos" min="0" max="59" placeholder="00" aria-label="Minutos" />
              <span class="tempo-sep">min</span>
            </div>
          </div>
          <div>
            <label for="potes">Quantidade de Potes</label>
            <input type="number" id="potes" min="0" />
          </div>
          <div>
            <label for="horario">Horário</label>
            <select id="horario">
              <option value="08:00">08:00</option>
              <option value="12:00">12:00</option>
              <option value="16:00">16:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          <div class="full">
            <button type="submit">Adicionar</button>
          </div>
        </form>
      </div>

      <div id="readOnlyHint" class="badge-info" style="display:none; text-align:center;">
        Você está em <strong>modo leitura</strong>. Faça login para adicionar/alterar disparos.
      </div>

      <div class="table-card" style="margin-top:12px;">
        <div class="grid" id="painel-grid">
          <div class="header">Horário</div>
          <div class="header">08:00</div>
          <div class="header">12:00</div>
          <div class="header">16:00</div>
          <div class="header">20:00</div>

          <div class="header">Disparos</div>
          <div id="col-08"></div>
          <div id="col-12"></div>
          <div id="col-16"></div>
          <div id="col-20"></div>
        </div>
      </div>
    </section>

    <section id="view-login" style="display:none;">
      <div class="login-card">
        <h2 class="login-title">Acessar</h2>
        <form id="loginForm">
          <label for="loginUser">Usuário</label>
          <input type="text" id="loginUser" placeholder="usuário" required />
          <label for="loginPass" style="margin-top:8px;">Senha</label>
          <input type="password" id="loginPass" placeholder="senha" required />
          <div class="login-actions">
            <button type="submit" id="btnLogin">Entrar</button>
            <button type="button" id="btnLogout" style="display:none;background:#ef4444;">Sair</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title-wrapper">
          <div id="mStatusPill" class="pill"></div>
          <div>
            <h3 class="modal-title" id="mTitle">Detalhes do disparo</h3>
            <div class="modal-sub" id="mSub"></div>
          </div>
        </div>
        <button class="modal-close" id="mClose" title="Fechar">×</button>
      </div>
      <div class="modal-body">
          <div class="info-list">
              <div class="info-item"><b>Volume</b><span id="mVolume">—</span></div>
              <div class="info-item"><b>Potes</b><span id="mPotes">—</span></div>
              <div class="info-item"><b>Tempo total</b><span id="mTempo">—</span></div>
              <div class="info-item"><b>Tempo restante</b><span id="mRestante">—</span></div>
              <div class="info-item"><b>Horário</b><span id="mHora">—</span></div>
              <div class="info-item"><b>Template</b><span id="mTpl">—</span></div>
          </div>

          <div class="template-box">
              <div class="template-header">
                  <b>Fraseologia</b>
                  <div class="btns">
                      <button class="btn success" id="mCopy">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                          Copiar
                      </button>
                      <button class="btn ghost" id="mRefresh">Atualizar</button>
                  </div>
              </div>
              <pre id="mText"></pre>
              <div class="template-vars">Variáveis: $[nome], $[valor], $[data_vencimento], $[dias_vencidos], $[quantidade_boletos]</div>
               <div class="btns" style="margin-top: 16px; justify-content: flex-end;">
                  <button class="btn warn" id="mCycle" style="display:none;">Alterar status</button>
              </div>
          </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <script>
  /* ========================= THEME TOGGLE ======================= */
  const themeToggleBtn = document.getElementById("themeToggle");
  const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a2.25 2.25 0 00-2.25 2.25 2.25 2.25 0 002.25 2.25 2.25 2.25 0 002.25-2.25A2.25 2.25 0 0012 12z" /></svg>`;
  const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`;
  const THEME_KEY = "painel_theme";

  function applyTheme(theme) {
      if (theme === 'dark') {
          document.documentElement.classList.add('dark');
          themeToggleBtn.innerHTML = sunIcon;
      } else {
          document.documentElement.classList.remove('dark');
          themeToggleBtn.innerHTML = moonIcon;
      }
  }

  function toggleTheme() {
      const currentTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, newTheme);
      applyTheme(newTheme);
  }

  const savedTheme = localStorage.getItem(THEME_KEY);
  if (savedTheme) {
      applyTheme(savedTheme);
  } else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
  }

  if(themeToggleBtn) {
    themeToggleBtn.addEventListener("click", toggleTheme);
  }

  /* ====================== DASHBOARD METRICS ==================== */
  const metricEls = {
    total: document.getElementById("metricTotal"),
    andamento: document.getElementById("metricAndamento"),
    finalizado: document.getElementById("metricFinalizado"),
    insucesso: document.getElementById("metricInsucesso"),
    range: document.getElementById("metricsRangeLabel")
  };
  const headerDateChip = document.getElementById("currentDateChip");
  const headerTimeChip = document.getElementById("currentTimeChip");
  const headerClock = document.getElementById("currentDateChip");

  const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : str;

  function formatRangeLabel(){
    const dp = document.getElementById("datePick");
    if (!dp || !dp.value) return "Todos os disparos";
    try{
      const formatted = new Date(`${dp.value}T00:00:00`).toLocaleDateString("pt-BR", {
        weekday: "long",
        day: "2-digit",
        month: "long"
      });
      return capitalize(formatted);
    }catch{
      return dp.value;
    }
  }

  function updateMetrics(records = []){
    const totals = { total: records.length, andamento: 0, finalizado: 0, insucesso: 0 };
    records.forEach(r => {
      const status = (r?.status || "").toLowerCase();
      if (status.includes("final")) totals.finalizado++;
      else if (status.includes("insu")) totals.insucesso++;
      else totals.andamento++;
    });
    if (metricEls.total) metricEls.total.textContent = totals.total;
    if (metricEls.andamento) metricEls.andamento.textContent = totals.andamento;
    if (metricEls.finalizado) metricEls.finalizado.textContent = totals.finalizado;
    if (metricEls.insucesso) metricEls.insucesso.textContent = totals.insucesso;
    if (metricEls.range) metricEls.range.textContent = formatRangeLabel();
  }

  function updateHeaderClock(){
    const now = new Date();
    if (headerTimeChip){
      headerTimeChip.textContent = now.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }
    if (headerDateChip){
      const formatted = now.toLocaleDateString("pt-BR", { weekday: "long", day: "2-digit", month: "long" });
      headerDateChip.textContent = capitalize(formatted);
    }
  }

  updateHeaderClock();
  if (headerDateChip || headerTimeChip) setInterval(updateHeaderClock, 1000);
    if (!headerClock) return;
    const now = new Date();
    const options = { weekday: "long", day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit" };
    let formatted = now.toLocaleDateString("pt-BR", options).replace(",", " •");
    headerClock.textContent = capitalize(formatted);
  }

  updateHeaderClock();
  if (headerClock) setInterval(updateHeaderClock, 60000);
  updateMetrics([]);

  /* ========================== CONFIG ========================== */
  const API_BASE = "";
  const IS_FILE = location.protocol === "file:";
  const FORCE_OFFLINE = (new URLSearchParams(location.search)).get("offline") === "1";
  let OFFLINE_MODE = IS_FILE || FORCE_OFFLINE;
  const BASE = (API_BASE || "").replace(/\/+$/,"");
  const url = (p) => `${BASE}${p}`;

  /* ====================== SPLASH & TOASTS ===================== */
  const splash = document.getElementById("splash");
  const hideSplashSoon = () => { splash?.classList.add("hide"); setTimeout(()=>{ try{splash.remove();}catch{} }, 300); };
  const splashTimer = setTimeout(hideSplashSoon, 1200);
  window.addEventListener("error", hideSplashSoon);
  window.addEventListener("unhandledrejection", hideSplashSoon);

  const topbar = document.getElementById("topbar");
  const toasts = new Set();
  function toast(msg, type="ok", ms=2500, key=null){
      if (key && toasts.has(key)) return;
      const div = document.createElement("div");
      div.className = `toast ${type}`;

      const icons = {
          ok: `<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
          warn: `<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
          error: `<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`
      };

      div.innerHTML = `${icons[type] || ""}<span>${msg}</span><button aria-label="fechar">×</button>`;
      const btn = div.querySelector("button");
      const removeToast = ()=> {
          div.style.animation = "slideOut .3s ease-in forwards";
          div.addEventListener('animationend', () => {
              try{ div.remove(); } catch(e){}
              if (key) toasts.delete(key);
          }, { once: true });
      };

      btn.onclick = removeToast;
      topbar.appendChild(div);
      if (key) toasts.add(key);

      setTimeout(removeToast, ms);
  }

  /* ============================ AUTH =========================== */
  const AUTH_KEY = "painel_auth_ok";
  let isAuthed = localStorage.getItem(AUTH_KEY) === "1";
  
  function updateAuthUI(){
    const formWrap = document.getElementById("form-wrapper");
    const hint = document.getElementById("readOnlyHint");
    const logoutBtn = document.getElementById("btnLogout");
    if(isAuthed){
      formWrap && (formWrap.style.display = "");
      hint && (hint.style.display = "none");
      logoutBtn && (logoutBtn.style.display = "");
    }else{
      formWrap && (formWrap.style.display = "none");
      hint && (hint.style.display = "");
      logoutBtn && (logoutBtn.style.display = "none");
    }
  }

  /* ============================ TABS =========================== */
  const tabs = document.querySelectorAll(".tab");
  function switchTab(name){
    tabs.forEach(t => {
      const isActive = t.dataset.tab === name;
      t.classList.toggle("active", isActive);
      t.setAttribute("aria-selected", isActive ? "true" : "false");
    });
    document.getElementById("view-painel").style.display = (name==="painel") ? "" : "none";
    document.getElementById("view-login").style.display  = (name==="login") ? "" : "none";
    if (name === "login") setTimeout(()=>document.getElementById("loginUser")?.focus(), 50);
  }
  tabs.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

  /* ============================ UTILS ========================== */
  // ===== ALTERAÇÃO 1: Mudar chaves para corresponder ao Airtable =====
  const TEMPLATE_TEXTS = {
    "preventivo_d0": `Olá $[nome]!😊

Seu boleto vence Hoje! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o código de barras.(Caso já tenha pago é só desconsiderar)

*Valor* R$: $[valor]
*Vencimento* : $[data_vencimento]

📞 Este é nosso número oficial de atendimento. Caso tenha alguma dúvida é só entrar em contato por aqui, combinado? 👍

Energia de TODOS: Faz bem para o seu bolso e para o planeta!🌎 💚`,
    "preventivo_d3_d10": `Olá $[nome]!😊

Seu boleto vence em $[data_vencimento]! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o código de barras (Caso já tenha pago é só desconsiderar).

*Valor* R$ : $[valor]

📞 Este é nosso número oficial de atendimento. Caso tenha alguma dúvida é só entrar em contato por aqui, combinado? 👍

Energia de TODOS: A Energia que Retorna!🌎`,
    "vencidos_1": `Olá $[nome]!😊

*ATENÇÃO! Sua conta de energia venceu há $[dias_vencidos] dias atrás e não identificamos seu pagamento*

*Valor* R$ :$[valor]
*Vencimento* : $[data_vencimento]

*Atenção*: não deixe de pagar em dia suas faturas para evitar juros e continuar economizando! (Favor desconsiderar essa mensagem, caso já tenha pago).

👉 Caso não tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o código de barras.

❗ Caso tenha dúvida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* 🌎💚`,
    "vencidos_2": `Olá $[nome]!😊

*ATENÇÃO! Sua conta de energia venceu há  $[dias_vencidos]  dias atrás e não identificamos seu pagamento*

Por conta disso poderá haver a suspensão de energia solar. A boa notícia é que ainda há chances de regularizar antes que isso aconteça.  (Favor desconsiderar essa mensagem, caso já tenha pago).

*Valor* R$ :  $[valor]
*Vencimento* : $[data_vencimento]

👉 Caso não tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o código de barras.

❗ Caso tenha dúvida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* 🌎💚`,
    "vencidos_5": `Olá $[nome]!😊

⚠ Até o momento não identificamos o pagamento do seu débito com a Energia de TODOS. Após várias tentativas de contato e de negociação sem sucesso, encaminhamos o seu cadastro ao Serviço de Proteção ao Crédito - SPC.

👉 Quantidade de boletos sem pagamento:  $[quantidade_boletos]
👉 Valor pendente: R$  $[valor]

Queremos escutar a sua proposta! 👉 Para conhecer nossas opções de parcelamento, fale abaixo com nossos atendentes.

📞 Este é nosso número oficial de atendimento via WhatsApp. Se tiver alguma dúvida é só entrar em contato por aqui, combinado? 👍

*Mais Sol, Energia e Economia para TODOS* 🌎💚`
  };
  
  // ===== ALTERAÇÃO 2: Adicionar um mapa para nomes de exibição =====
  const TEMPLATE_DISPLAY_NAMES = {
      "preventivo_d0": "Preventivo D0",
      "preventivo_d3_d10": "Preventivo D3 e D10",
      "vencidos_1": "Vencidos 1",
      "vencidos_2": "Vencidos 2",
      "vencidos_5": "Vencidos 5"
  };

  function tplText(name){ return TEMPLATE_TEXTS[(name||"").trim()] || "(nenhum template associado)"; }

  function clsForStatus(status){
    switch((status||"").toLowerCase()){
      case "finalizado": return "finalizado";
      case "insucesso":  return "insucesso";
      default:           return "andamento";
    }
  }
  function nextStatus(current){
    const order = ["Em andamento","Finalizado","Insucesso"];
    const i = order.indexOf(current);
    return order[(i+1) % order.length];
  }
  function uid(){ return "tmp_" + Math.random().toString(36).slice(2); }
  function calcHash(records){
    try{
      return (records||[]).map(r => `${r.id}|${r.tipo}|${r.status}|${r.horario}|${r.tempo}|${r.potes}|${r.template||""}|${r.volume||""}|${r.atualizadoEm||""}`).join("§");
    }catch{ return Math.random().toString(36); }
  }
  function fetchWithTimeout(resource, options = {}, timeout = 3000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    return fetch(resource, { ...options, signal: controller.signal }).finally(() => clearTimeout(id));
  }
  function fmtDateOnly(s){
    if(!s) return null;
    return s.split("T")[0];
  }

  function minutesToParts(totalMinutes){
    const mins = Math.max(0, Number(totalMinutes) || 0);
    return { hours: Math.floor(mins / 60), minutes: mins % 60 };
  }
  function formatTempoLabel(totalMinutes){
    const { hours, minutes } = minutesToParts(totalMinutes);
    const parts = [];
    if (hours) parts.push(`${hours}h`);
    if (minutes) parts.push(`${minutes}min`);
    if (!parts.length) parts.push("0min");
    return parts.join(" ");
  }
  function formatRemainingLabel(ms){
    if (ms === null) return "—";
    if (ms <= 0) return "Finalizado";
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const parts = [];
    if (hours) parts.push(`${hours}h`);
    parts.push(`${String(minutes).padStart(2, '0')}m`);
    parts.push(`${String(seconds).padStart(2, '0')}s`);
    return parts.join(' ');
  }
  function remainingMsFromRecord(r){
    try{
      const mins = Number(r?.tempo || 0);
      const ts = r?.atualizadoEm ? Date.parse(r.atualizadoEm) : NaN;
      if (!mins || isNaN(ts)) return null;
      const end = ts + mins * 60000;
      return end - Date.now();
    }catch{
      return null;
    }
  }

  /* ================== FILTRO POR DATA ============ */
  let currentRange = "all";
  function setRange(range){
    currentRange = range || "all";
    softRender(lastNonEmpty);
  }
  function inRange(rec){
    if (!rec || !rec.data) return true; 
    if (currentRange === 'all') return true;
    return rec.data === currentRange;
  }

  /* =========================== RENDER ========================== */
  function clearColumns(){
    ["08","12","16","20"].forEach(h => {
      const el = document.getElementById("col-"+h);
      if (el) el.innerHTML = "";
    });
  }

  function cardTemplate(r){
    const div = document.createElement("div");
    div.className = `disparo status-${clsForStatus(r.status)}`;
    div.dataset.id = r.id || uid();
    div.dataset.status = r.status || "Em andamento";
    div.dataset.horario = r["horario"] || "08:00";
    div.dataset.template = r.template || "";
    div.dataset.volume = r.volume || "";
    div.dataset.atualizadoEm = r.atualizadoEm || "";
    div.dataset.data = r.data || "";
    div.dataset.tempo = r.tempo ?? "";

    const remainingLabel = formatRemainingLabel(remainingMsFromRecord(r));
    const metaParts = [
      `Tempo: <strong>${formatTempoLabel(r.tempo)}</strong>`,
      `Restante: <strong data-restante>${remainingLabel}</strong>`
    ];
    if (r.potes !== undefined && r.potes !== null && r.potes !== "") {
      metaParts.push(`Potes: <strong>${r.potes}</strong>`);
    }
    if (r.volume) {
      metaParts.push(`Vol.: <strong>${r.volume}</strong>`);
    }
    div.innerHTML = `
      <span class="badge" data-role="badge">${r.status || "Em andamento"}</span>
      <div class="title">${r.tipo || ""}</div>
      <div class="meta">${metaParts.join(' • ')}</div>
    `;
    div.addEventListener("click", () => openModal(r));
    return div;
  }

  function placeRecord(r){
    const hh = (r["horario"] || "08:00").split(":")[0];
    const col = document.getElementById("col-"+hh);
    if (col) {
      const card = cardTemplate(r);
      col.appendChild(card);
      registerCountdown(r, card);
    }
  }

  function renderSnapshot(records){
    clearColumns();
    const filtered = (records||[]).filter(inRange);
    updateMetrics(filtered);
    countdownEntries.clear();
    if (countdownEntries.size === 0 && countdownInterval){
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    filtered.forEach(r => placeRecord(r));
  }

  function updateCardAppearance(card, status){
    const cls = clsForStatus(status);
    card.className = `disparo status-${cls}`;
    card.dataset.status = status;
    const badge = card.querySelector('[data-role="badge"]');
    if (badge) badge.textContent = status;
  }

  function updateCardCountdown(card, remainingMs){
    const target = card.querySelector('[data-restante]');
    if (target) target.textContent = formatRemainingLabel(remainingMs);
  }

  function ensureCountdownRunner(){
    if (countdownInterval) return;
    countdownInterval = setInterval(()=>{
      countdownEntries.forEach((entry, id) => {
        const remaining = remainingMsFromRecord(entry.record);
        updateCardCountdown(entry.element, remaining);
        if (remaining !== null && remaining <= 0){
          countdownEntries.delete(id);
          updateCardAppearance(entry.element, "Finalizado");
          triggerAutoFinalize(id);
        }
      });
      if (countdownEntries.size === 0 && countdownInterval){
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }, 1000);
  }

  function registerCountdown(record, element){
    const id = String(record.id || element.dataset.id || "");
    const status = (record.status || "").toLowerCase();
    const remaining = remainingMsFromRecord(record);
    updateCardCountdown(element, remaining);
    if (!id){ return; }
    if (status.includes("andamento")){
      autoFinalizedIds.delete(id);
    }
    if (!record.tempo || !record.atualizadoEm || status.includes("final") || status.includes("insu")){
      countdownEntries.delete(id);
      return;
    }
    countdownEntries.set(id, { record: { id: record.id, tempo: record.tempo, atualizadoEm: record.atualizadoEm, status: record.status }, element });
    ensureCountdownRunner();
  }

  async function triggerAutoFinalize(id){
    if (!id || autoFinalizedIds.has(id)) return;
    autoFinalizedIds.add(id);
    const record = (lastNonEmpty || []).find(r => `${r.id}` === `${id}`);
    if (!record) return;
    const status = (record.status || "").toLowerCase();
    if (status.includes("final") || status.includes("insu")) return;

    record.status = "Finalizado";
    record.atualizadoEm = new Date().toISOString();
    toast("Disparo finalizado automaticamente.", "ok", 2200, `auto-finish-${id}`);

    const rerender = () => softRender((lastNonEmpty || []).slice());
    const isTempId = String(record.id || "").startsWith("tmp_");

    if (!OFFLINE_MODE && isAuthed && record.id && !isTempId){
      try{
        const resp = await fetch(url(`/api/disparos/${record.id}`), {
          method: "PATCH",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify({ status: "Finalizado" })
        });
        if (resp.status === 401){
          isAuthed = false;
          localStorage.removeItem(AUTH_KEY);
          updateAuthUI();
          switchTab("login");
          toast("Sessão expirada ao finalizar automaticamente.", "warn", 3200, "auto-expired");
        }
      }catch{
        /* silencioso */
      }finally{
        setTimeout(rerender, 60);
      }
    }else{
      setTimeout(rerender, 60);
    }
    filtered.forEach(r => placeRecord(r));
  }

  /* ===== Modal ===== */
  const modal = document.getElementById('modal');
  const mClose = document.getElementById('mClose');
  const mTitle = document.getElementById('mTitle');
  const mSub   = document.getElementById('mSub');
  const mPill  = document.getElementById('mStatusPill');
  const mVolume= document.getElementById('mVolume');
  const mPotes = document.getElementById('mPotes');
  const mTempo = document.getElementById('mTempo');
  const mRest  = document.getElementById('mRestante');
  const mHora  = document.getElementById('mHora');
  const mTpl   = document.getElementById('mTpl');
  const mText  = document.getElementById('mText');
  const mCopy  = document.getElementById('mCopy');
  const mRefresh = document.getElementById('mRefresh');
  const mCycle = document.getElementById('mCycle');

  let currentRecord = null;
  let modalTimer = null;

  function openModal(r){
    currentRecord = r;
    mTitle.textContent = r.tipo || "(sem nome)";
    const dstr = r.atualizadoEm ? `Atualizado: ${new Date(r.atualizadoEm).toLocaleString()}` : "";
    mSub.textContent = dstr;

    const c = clsForStatus(r.status);
    mPill.className = `pill ${c}`;
    mPill.textContent = r.status || "Em andamento";

    mVolume.textContent = r.volume ?? "—";
    mPotes.textContent  = r.potes ?? "—";
    mTempo.textContent  = formatTempoLabel(r.tempo);
    mHora.textContent   = r.horario || "—";
    
    const tplName = (r.template || "").trim();
    // ===== ALTERAÇÃO 3: Usar o mapa para exibir o nome correto =====
    mTpl.textContent = TEMPLATE_DISPLAY_NAMES[tplName] || tplName || "(nenhum)";
    mText.textContent = tplText(tplName);

    mRest.textContent = calcRestante(r);
    if (modalTimer) clearInterval(modalTimer);
    modalTimer = setInterval(() => {
      if (!currentRecord) return;
      mRest.textContent = calcRestante(currentRecord);
    }, 1000);
    mCycle.style.display = isAuthed ? "" : "none";

    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    if (modalTimer) { clearInterval(modalTimer); modalTimer = null; }
    currentRecord = null;
  }
  mClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  function calcRestante(r){
    if (!r) return "—";
    const status = (r.status || "").toLowerCase();
    if (status.includes("final")) return "Finalizado";
    if (status.includes("insu")) return "—";
    const remaining = remainingMsFromRecord(r);
    if (remaining === null) return "—";
    return formatRemainingLabel(remaining);
  }

  mCopy.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(mText.textContent || "");
      toast("Texto copiado!", "ok", 1800, "copy-ok");
    }catch{
      toast("Não consegui copiar 😕", "error");
    }
  });
  mRefresh.addEventListener('click', ()=> {
    if (currentRecord) {
      mRest.textContent = calcRestante(currentRecord);
      toast("Atualizado.", "ok", 1100, "upd");
    }
  });
  mCycle.addEventListener('click', async ()=>{
    if (!currentRecord) return;
    if (!isAuthed){ toast("Faça login para alterar.", "warn"); return; }
    const next = nextStatus(currentRecord.status || "Em andamento");
    try{
      const res = await fetch(url(`/api/disparos/${currentRecord.id}`), {
        method:"PATCH", headers:{"Content-Type":"application/json"}, credentials:"include",
        body: JSON.stringify({ status: next })
      });
      if (res.ok){
        toast("Status atualizado", "ok", 1300, "upd-status");
        setTimeout(softRefresh, 250);
        closeModal();
      }else if(res.status===401){
        isAuthed=false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        toast("Sessão expirada.", "warn");
      }else{
        toast("Falha ao atualizar status.", "error");
      }
    }catch{ toast("Rede instável.", "error"); }
  });

  /* ============= Data (Cache + SSE + Polling Backoff) ========= */
  const CACHE_KEY = "painel_snapshot_v2";
  const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6h
  let lastNonEmpty = [];
  let lastHash = "";
  let sse = null, pollTimer = null, backoffMs = 5000, gotFirstPaint = false;
  const countdownEntries = new Map();
  const autoFinalizedIds = new Set();
  let countdownInterval = null;

  (function paintFromCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return;
      const {ts, data} = JSON.parse(raw);
      if (!data || (Date.now() - ts) > CACHE_TTL_MS) return;
      lastNonEmpty = data;
      lastHash = calcHash(data);
      renderSnapshot(data);
      clearTimeout(splashTimer);
      hideSplashSoon();
      gotFirstPaint = true;
    }catch{}
  })();

  function saveCache(records){
    try{
      const payload = { ts: Date.now(), data: records };
      (window.requestIdleCallback || setTimeout)(() =>
        localStorage.setItem(CACHE_KEY, JSON.stringify(payload)), 0
      );
    }catch{}
  }

  function softRender(records){
    const filtered = (records||[]).filter(inRange);
    updateMetrics(filtered);
    const incomingHash = calcHash(filtered);
    if (incomingHash === lastHash) return;
    renderSnapshot(records);
    lastHash = incomingHash;
    if ((records?.length || 0) > 0) { lastNonEmpty = records; saveCache(records); }
    if (!gotFirstPaint){ gotFirstPaint = true; clearTimeout(splashTimer); hideSplashSoon(); }
  }

  async function loadInitial(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetchWithTimeout(url("/api/disparos"), {cache:"no-store", credentials:"include"}, 3000);
      if (!resp.ok) throw new Error(resp.status);
      const data = await resp.json();
      softRender(data);
    }catch(e){ /* silencioso */ }
  }

  async function softRefresh(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
      if (!resp.ok) return;
      const data = await resp.json();
      softRender(data);
    }catch{}
  }

  function startPolling(){
    if (OFFLINE_MODE) return;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
        if (resp.ok){
          const data = await resp.json();
          softRender(data);
          backoffMs = Math.max(5000, Math.floor(backoffMs/2));
        }
      }catch{}
    }, backoffMs);
    backoffMs = Math.min(backoffMs * 2, 30000);
  }
  function stopPolling(){ if (pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

  function startSSE(){
    if (OFFLINE_MODE) return;
    try{
      if (sse) sse.close();
      sse = new EventSource(url("/api/stream"));
      sse.onmessage = (evt) => {
        try{
          const payload = JSON.parse(evt.data);
          if (payload.type === "snapshot") softRender(payload.records || []);
        }catch{}
      };
      sse.onerror = () => { startPolling(); };
    }catch{ startPolling(); }
  }
  function stopSSE(){ if (sse){ try{sse.close();}catch{} sse=null; } }

  /* ======================== FORM ADD ========================== */
  const form = document.getElementById("formDisparo");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = document.getElementById("datePick").value;
    if (!data) {
      toast("Por favor, selecione uma data no filtro.", "warn");
      return;
    }

    const tipo     = document.getElementById("tipo").value.trim();
    let tempoHoras = parseInt(document.getElementById("tempoHoras").value || "0", 10);
    let tempoMin   = parseInt(document.getElementById("tempoMinutos").value || "0", 10);
    tempoHoras = isNaN(tempoHoras) ? 0 : Math.max(0, tempoHoras);
    tempoMin   = isNaN(tempoMin) ? 0 : tempoMin;
    if (tempoMin < 0 || tempoMin > 59){ toast("Minutos devem estar entre 0 e 59.", "warn"); return; }
    const tempo    = (tempoHoras * 60) + tempoMin;
    const potes    = Number(document.getElementById("potes").value);
    const horario  = document.getElementById("horario").value;
    const template = document.getElementById("template").value;
    const volume   = Number(document.getElementById("volume").value || 0);

    if(!tipo && !template){ toast("Preencha o nome do disparo ou escolha um template.", "warn"); return; }
    if(tempo <= 0){ toast("Informe um tempo médio válido.", "warn"); return; }

    const optimisticRecord = { 
      id: uid(), 
      tipo, 
      tempo, 
      potes, 
      horario, 
      status:"Em andamento", 
      template,
      volume,
      data: data,
      atualizadoEm: new Date().toISOString()
    };
    
    (lastNonEmpty = lastNonEmpty || []).push(optimisticRecord);
    softRender(lastNonEmpty);

    if (OFFLINE_MODE) { e.target.reset(); return; }
    if(!isAuthed){
      toast("Você está em modo leitura. Faça login para adicionar.", "warn", 3000, "readonly-add");
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      softRender(lastNonEmpty);
      return;
    }

    const payload = {
      tipo: optimisticRecord.tipo,
      tempo: optimisticRecord.tempo,
      potes: optimisticRecord.potes,
      horario: optimisticRecord.horario,
      status: optimisticRecord.status,
      template: optimisticRecord.template,
      volume: optimisticRecord.volume,
      data: optimisticRecord.data
    };

    try{
      const resp = await fetch(url("/api/disparos"), {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify(payload)
      });
      if (!resp.ok){
        if (resp.status === 401){
          toast("Sessão expirada. Faça login novamente.", "warn", 3200, "sessao");
          isAuthed = false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        } else {
          const errData = await resp.json();
          const errMsg = errData?.error?.message || "Não consegui salvar no servidor.";
          toast(errMsg, "error", 4000);
          console.error("Erro do servidor:", errData);
        }
        lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
        softRender(lastNonEmpty);
      } else {
        e.target.reset();
        toast("Disparo adicionado!", "ok");
        setTimeout(softRefresh, 300);
      }
    }catch(err){
      toast("Falha de rede ao salvar.", "error");
      console.error("Falha na requisição:", err);
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      softRender(lastNonEmpty);
    }
  });

  /* ====================== LOGIN / LOGOUT ====================== */
  const loginForm = document.getElementById("loginForm");
  const btnLogin  = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const u = (document.getElementById("loginUser").value || "").trim();
    const p = (document.getElementById("loginPass").value || "").trim();

    if (!u || !p){ return; }
    btnLogin.disabled = true;

    if (u !== "energia" || p !== "energia1") {
      toast("Usuário ou senha inválidos.", "error");
      btnLogin.disabled = false;
      return;
    }

    isAuthed = true; localStorage.setItem(AUTH_KEY, "1"); updateAuthUI(); switchTab("painel");

    try{
      const r = await fetch(url("/api/login"), {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({ username:u, password:p })
      });
      if (!r.ok){
        toast("Não consegui criar sessão segura no servidor.", "warn");
      }else{
        setTimeout(softRefresh, 150);
      }
    }catch{
      toast("Rede instável ao criar sessão.", "warn");
    }finally{
      btnLogin.disabled = false;
    }
  });

  btnLogout.addEventListener("click", () => {
    isAuthed = false; localStorage.removeItem(AUTH_KEY);
    updateAuthUI(); switchTab("login");
    stopSSE(); stopPolling();

    const u = document.getElementById("loginUser"), p = document.getElementById("loginPass");
    if (p) p.value = ""; if (u) { u.value = ""; u.focus(); }

    try{ fetch(url("/api/logout"), { method:"POST", credentials:"include" }); }catch{}
    setTimeout(()=>{ startSSE(); }, 300);
  });

  /* ======================= DATE FILTER UI ===================== */
  (() => {
    const dp = document.getElementById('datePick');
    if (!dp) return;
    
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayString = `${yyyy}-${mm}-${dd}`;
    
    dp.value = todayString;
    setRange(todayString);
    
    dp.addEventListener('change', () => {
      setRange(dp.value || "all");
    });
  })();

  /* ========================== START =========================== */
  (async () => {
    switchTab("painel");
    updateAuthUI();

    if (OFFLINE_MODE) { clearTimeout(splashTimer); hideSplashSoon(); return; }

    startSSE();
    loadInitial();
  })();
  </script>
</body>
</html>
