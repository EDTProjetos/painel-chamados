<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#0b4a8f; --primary-2:#0f6ad8;
      --andamento:#ff9f1a; --finalizado:#1fb36a; --insucesso:#e23b3b;
      --warn:#fbbf24; --error:#ef4444; --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text); margin:0; display:flex; flex-direction:column; min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px;width:100%;flex:1}

    .app-header{background: linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); margin:0 0 12px 0}
    .app-title{margin:0; padding:20px 16px; text-align:center; font-size:26px; letter-spacing:.3px}

    .tabs{display:flex; gap:10px; justify-content:center; margin:12px 0 0}
    .tab{background:#fff; border:1px solid var(--border); color:#111827; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700; transition:transform .15s ease, box-shadow .2s ease}
    .tab:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.08) }
    .tab.active{ border-color: var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.12) }

    .legenda{display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin:16px 0 8px}
    .legenda-item{display:flex; align-items:center; gap:8px; font-weight:600; background:var(--card); padding:8px 12px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.06); border:1px solid var(--border)}
    .cor{width:16px;height:16px;border-radius:4px;display:inline-block}
    .cor.andamento{background:var(--andamento)} .cor.finalizado{background:var(--finalizado)} .cor.insucesso{background:var(--insucesso)}

    .form-container{background:var(--card); border:1px solid var(--border); padding:20px; margin:18px 0; border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .form-container h2{margin:0 0 12px; color:var(--primary)}
    .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .form-grid > .full{grid-column:1 / -1}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,button{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#111827; font-size:14px}
    button{background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer; letter-spacing:.2px}
    button.secondary{background:#e2e8f0; color:#0f172a}

    .badge-info{display:inline-block; background:#fff; border:1px dashed var(--border); color:var(--muted); padding:8px 10px; border-radius:10px; font-size:13px; margin-top:8px}

    .table-card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.08); overflow:hidden}
    .grid{display:grid; grid-template-columns: 160px repeat(4, minmax(200px,1fr)); width:100%}
    .grid > div{border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:12px; min-height:72px; background:#fff}
    .header{background:#f8fafc; color:#0f172a; font-weight:800; text-transform:uppercase; text-align:center}

    .disparo{border-radius:12px; padding:12px; margin:8px 0; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.15); cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; animation:pop .2s ease-out both}
    .disparo:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(0,0,0,.22) }
    .status-andamento{ background:var(--andamento) } .status-finalizado{ background:var(--finalizado) } .status-insucesso{ background:var(--insucesso) }
    .badge{ font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.25); margin-bottom:6px; display:inline-block }
    .title{font-weight:800; font-size:14px; margin-bottom:4px} .meta{font-size:12px; opacity:.95}
    @keyframes pop{from{opacity:0; transform:translateY(4px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}

    /* Splash/Spinner */
    .splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:9999; transition:opacity .25s ease}
    .splash.hide{ opacity:0; pointer-events:none }
    .ring{ width:48px; height:48px; border:4px solid #e5e7eb; border-top-color:var(--primary-2); border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Toast (popup) */
    .toasts{position:fixed; top:18px; left:50%; transform:translateX(-50%); z-index:9999; display:flex; flex-direction:column; gap:10px; pointer-events:none}
    .toast{pointer-events:auto; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; box-shadow:0 12px 26px rgba(2,6,23,.18); font-size:14px; display:flex; align-items:center; gap:10px; min-width:280px; justify-content:center}
    .toast.ok{ border-color:#bbf7d0; background:#f0fdf4 } 
    .toast.warn{ border-color:#fde68a; background:#fffbeb } 
    .toast.error{ border-color:#fecaca; background:#fff1f2 } 
    .toast .x{margin-left:6px; cursor:pointer; font-weight:900}

    .footer{width:100%; background:#fff; border-top:1px solid var(--border); color:var(--muted); font-size:13px; text-align:center; padding:14px 12px}

    /* Login */
    .login-card{background:var(--card); border:1px solid var(--border); padding:20px; margin:18px auto; border-radius:14px; max-width:520px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .login-title{margin:0 0 12px; color:var(--primary); text-align:left; font-size:22px}
    .login-actions{display:flex; gap:10px; margin-top:8px}
    .logout-btn{background:#ef4444}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(2,6,23,.56); display:none; align-items:center; justify-content:center; z-index:9998; padding:16px}
    .modal.show{display:flex}
    .modal-card{background:#ffffff; border-radius:16px; max-width:900px; width:100%; box-shadow:0 24px 60px rgba(2,6,23,.35); border:1px solid var(--border); overflow:hidden}
    .modal-head{display:flex; justify-content:flex-start; align-items:center; padding:14px 16px; background:#f8fafc; border-bottom:1px solid var(--border); position:relative}
    .modal-head h3{margin:0; font-size:18px; padding-right:44px}
    .modal-head .close-btn{
      position:absolute; right:12px; top:10px;
      width:28px; height:28px; border-radius:999px;
      background:linear-gradient(90deg,var(--primary),var(--primary-2));
      color:#fff; border:none; display:grid; place-items:center;
      font-weight:900; font-size:16px; line-height:0;
      box-shadow:0 6px 16px rgba(2,6,23,.25);
      cursor:pointer; transition:transform .12s ease, opacity .12s ease;
    }
    .modal-head .close-btn:hover{ transform:scale(1.04); opacity:.95 }
    .modal-body{padding:16px}
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; color:#0f172a; background:#eef2f7; border:1px solid #e2e8f0}
    .template-box{background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px; white-space:pre-wrap}
    .modal-actions{display:flex; gap:10px; margin-top:12px}
  </style>
</head>
<body>
  <div id="splash" class="splash"><div class="ring" aria-label="Carregando"></div></div>
  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <h1 class="app-title">Painel de Disparos</h1>
  </header>

  <div class="wrap">
    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="painel">Painel</button>
      <button class="tab" data-tab="login">Login</button>
    </nav>

    <!-- VIEW: PAINEL -->
    <section id="view-painel">
      <div class="legenda">
        <div class="legenda-item"><span class="cor andamento"></span> Em andamento</div>
        <div class="legenda-item"><span class="cor finalizado"></span> Finalizado</div>
        <div class="legenda-item"><span class="cor insucesso"></span> Insucesso</div>
      </div>

      <!-- Form (só logado) -->
      <div id="form-wrapper" class="form-container" style="display:none;">
        <h2>Novo Disparo</h2>
        <form id="formDisparo" class="form-grid">
          <div>
            <label for="tipo">Nome do Disparo</label>
            <input type="text" id="tipo" placeholder="ex.: Disparo D0" required />
          </div>
          <div>
            <label for="templateSel">Template (opcional)</label>
            <select id="templateSel">
              <option value="">— Sem template —</option>
              <option>Preventivo D0</option>
              <option>Preventivo D3 e D10</option>
              <option>Vencidos 1</option>
              <option>Vencidos 2</option>
              <option>Vencidos 5</option>
            </select>
          </div>
          <div>
            <label for="tempo">Tempo Médio (min)</label>
            <input type="number" id="tempo" min="0" placeholder="ex.: 10" />
          </div>
          <div>
            <label for="potes">Quantidade de Potes</label>
            <input type="number" id="potes" min="1" value="1" />
          </div>
          <div>
            <label for="volume">Volume de Disparos</label>
            <input type="number" id="volume" min="0" value="0" />
          </div>
          <div>
            <label for="horario">Horário</label>
            <select id="horario" required>
              <option value="08:00">08:00</option>
              <option value="12:00">12:00</option>
              <option value="16:00">16:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          <div class="full">
            <button type="submit">Adicionar</button>
          </div>
        </form>
      </div>

      <!-- Aviso quando deslogado -->
      <div id="readOnlyHint" class="badge-info" style="display:none; text-align:center;">
        Você está em <strong>modo leitura</strong>. Faça login para adicionar disparos.
      </div>

      <!-- Tabela -->
      <div class="table-card" style="margin-top:14px;">
        <div class="grid" id="painel-grid">
          <div class="header">Horário</div>
          <div class="header">08:00</div>
          <div class="header">12:00</div>
          <div class="header">16:00</div>
          <div class="header">20:00</div>

          <div class="header">Disparos</div>
          <div id="col-08"></div>
          <div id="col-12"></div>
          <div id="col-16"></div>
          <div id="col-20"></div>
        </div>
      </div>
    </section>

    <!-- VIEW: LOGIN -->
    <section id="view-login" style="display:none;">
      <div class="login-card">
        <h2 class="login-title">Acessar</h2>
        <form id="loginForm">
          <label for="loginUser">Usuário</label>
          <input type="text" id="loginUser" placeholder="usuário" required value="energia" />
          <label for="loginPass" style="margin-top:10px;">Senha</label>
          <input type="password" id="loginPass" placeholder="senha" required />
          <div class="login-actions">
            <button id="btnLogin" type="submit">Entrar</button>
            <button type="button" id="btnLogout" class="logout-btn" style="display:none;">Sair</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <footer class="footer">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <!-- MODAL Detalhes -->
  <div id="detailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modalTitle">Detalhes do Disparo</h3>
        <button class="close-btn" onclick="hideModal()" aria-label="Fechar">×</button>
      </div>
      <div class="modal-body">
        <div class="chips">
          <div class="chip" id="chipStatus"><strong>Status:</strong> <span>—</span></div>
          <div class="chip" id="chipHorario"><strong>Horário:</strong> <span>—</span></div>
          <div class="chip" id="chipPotes"><strong>Potes:</strong> <span>—</span></div>
          <div class="chip" id="chipVolume"><strong>Volume:</strong> <span>—</span></div>
          <div class="chip" id="chipTempo"><strong>Tempo médio:</strong> <span>—</span></div>
          <div class="chip" id="chipRestante"><strong>Tempo restante:</strong> <span>—</span></div>
        </div>

        <h4 id="tplTitle" style="margin:0 0 8px;">Template: —</h4>
        <div id="templateText" class="template-box">(Sem template associado a este disparo)</div>

        <div class="modal-actions">
          <button type="button" onclick="copyTemplate()">Copiar template</button>
          <button type="button" class="secondary" onclick="copyResumo()">Copiar resumo</button>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ========================== CONFIG ========================== */
  // Use MESMO HOST (string vazia) para cookies funcionarem sem CORS.
  const API_BASE = "";

  const IS_FILE = location.protocol === "file:";
  const FORCE_OFFLINE = (new URLSearchParams(location.search)).get("offline") === "1";
  let OFFLINE_MODE = IS_FILE || FORCE_OFFLINE;

  const BASE = (API_BASE || "").replace(/\/+$/,"");
  const url = (p) => `${BASE}${p}`;

  /* ====================== SPLASH & TOASTS ===================== */
  const splash = document.getElementById("splash");
  const hideSplashSoon = () => { splash?.classList.add("hide"); setTimeout(()=>{ try{splash.remove();}catch{} }, 300); };
  const splashTimer = setTimeout(hideSplashSoon, 1200);
  window.addEventListener("error", hideSplashSoon);
  window.addEventListener("unhandledrejection", hideSplashSoon);

  const toasts = document.getElementById("toasts");
  const toastKeys = new Set();
  function toast(msg, type="ok", ms=2200, key=null){
    if (key && toastKeys.has(key)) return;
    const div = document.createElement("div");
    div.className = `toast ${type}`;
    div.innerHTML = `<span>${msg}</span><span class="x" aria-label="fechar">×</span>`;
    const close = () => { div.remove(); if (key) toastKeys.delete(key); };
    div.querySelector(".x").onclick = close;
    toasts.appendChild(div);
    if (key) toastKeys.add(key);
    setTimeout(close, ms);
  }

  /* ============================ AUTH =========================== */
  const AUTH_KEY = "painel_auth_ok";
  let isAuthed = localStorage.getItem(AUTH_KEY) === "1";

  function updateAuthUI(){
    const formWrap = document.getElementById("form-wrapper");
    const hint = document.getElementById("readOnlyHint");
    const logoutBtn = document.getElementById("btnLogout");
    if(isAuthed){
      formWrap && (formWrap.style.display = "");
      hint && (hint.style.display = "none");
      logoutBtn && (logoutBtn.style.display = "");
    }else{
      formWrap && (formWrap.style.display = "none");
      hint && (hint.style.display = "");
      logoutBtn && (logoutBtn.style.display = "none");
    }
  }

  /* ============================ TABS =========================== */
  const tabs = document.querySelectorAll(".tab");
  function switchTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.getElementById("view-painel").style.display = (name==="painel") ? "" : "none";
    document.getElementById("view-login").style.display  = (name==="login") ? "" : "none";
    if (name === "login") setTimeout(()=>document.getElementById("loginUser")?.focus(), 50);
  }
  tabs.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

  /* ============================ UTILS ========================== */
  function clsForStatus(status){
    switch((status||"").toLowerCase()){
      case "finalizado": return "status-finalizado";
      case "insucesso":  return "status-insucesso";
      default:           return "status-andamento";
    }
  }
  function uid(){ return "tmp_" + Math.random().toString(36).slice(2); }
  function calcHash(records){
    try{
      return (records||[]).map(r => `${r.id}|${r.tipo}|${r.status}|${r.horario}|${r.tempo}|${r.potes}|${r.volume||""}|${r.template||""}`).join("§");
    }catch{ return Math.random().toString(36); }
  }
  function fetchWithTimeout(resource, options = {}, timeout = 3000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    return fetch(resource, { ...options, signal: controller.signal }).finally(() => clearTimeout(id));
  }

  /* =========================== RENDER ========================== */
  function clearColumns(){
    ["08","12","16","20"].forEach(h => {
      const el = document.getElementById("col-"+h);
      if (el) el.innerHTML = "";
    });
  }

  function cardTemplate(r){
    const div = document.createElement("div");
    div.className = `disparo ${clsForStatus(r.status)}`;
    div.dataset.id = r.id || uid();
    div.dataset.status = r.status || "Em andamento";
    div.dataset.horario = r["horario"] || "08:00";
    div.dataset.tipo = r.tipo || "";
    div.dataset.tempo = r.tempo ?? 0;
    div.dataset.potes = r.potes ?? 0;
    div.dataset.volume = r.volume ?? 0;
    div.dataset.template = r.template || "";

    div.innerHTML = `
      <span class="badge">${r.status || "Em andamento"}</span>
      <div class="title">${r.tipo || ""}</div>
      <div class="meta">Tempo médio: <strong>${r.tempo ?? ""} min</strong> • Potes: <strong>${r.potes ?? ""}</strong> • Vol: <strong>${r.volume ?? 0}</strong></div>
    `;

    // Clique -> abre modal (não altera status)
    div.addEventListener("click", () => openDetails(div));
    return div;
  }

  function placeRecord(r){
    const hh = (r["horario"] || "08:00").split(":")[0];
    const col = document.getElementById("col-"+hh);
    if (col) col.appendChild(cardTemplate(r));
  }

  function renderSnapshot(records){
    clearColumns();
    (records||[]).forEach(r => placeRecord(r));
  }

  /* ============= Data (Cache + SSE + Polling Backoff) ========= */
  const CACHE_KEY = "painel_snapshot_v1";
  const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6h
  let lastNonEmpty = [];
  let lastHash = "";
  let sse = null;
  let pollTimer = null;
  let backoffMs = 5000;
  let gotFirstPaint = false;

  (function paintFromCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return;
      const {ts, data} = JSON.parse(raw);
      if (!data || (Date.now() - ts) > CACHE_TTL_MS) return;
      lastNonEmpty = data;
      lastHash = calcHash(data);
      renderSnapshot(data);
      clearTimeout(splashTimer);
      hideSplashSoon();
      gotFirstPaint = true;
    }catch{}
  })();

  function saveCache(records){
    try{
      const payload = { ts: Date.now(), data: records };
      (window.requestIdleCallback || setTimeout)(() =>
        localStorage.setItem(CACHE_KEY, JSON.stringify(payload)), 0
      );
    }catch{}
  }

  function safeRender(records){
    const incomingHash = calcHash(records);
    if (incomingHash === lastHash) return;
    if ((records?.length || 0) === 0 && (lastNonEmpty?.length || 0) > 0) return;
    renderSnapshot(records);
    lastHash = incomingHash;
    if ((records?.length || 0) > 0) { lastNonEmpty = records; saveCache(records); }
    if (!gotFirstPaint){ gotFirstPaint = true; clearTimeout(splashTimer); hideSplashSoon(); }
  }

  async function loadInitial(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetchWithTimeout(url("/api/disparos"), {cache:"no-store", credentials:"include"}, 3000);
      if (!resp.ok) throw new Error(resp.status);
      const data = await resp.json();
      safeRender(data);
    }catch(e){}
  }

  async function softRefresh(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
      if (!resp.ok) return;
      const data = await resp.json();
      safeRender(data);
    }catch{}
  }

  function startPolling(){
    if (OFFLINE_MODE) return;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
        if (resp.ok){
          const data = await resp.json();
          safeRender(data);
          backoffMs = Math.max(5000, Math.floor(backoffMs/2));
        }
      }catch{}
    }, backoffMs);
    backoffMs = Math.min(backoffMs * 2, 30000);
  }

  function startSSE(){
    if (OFFLINE_MODE) return;
    try{
      if (sse) sse.close();
      sse = new EventSource(url("/api/stream"));
      sse.onmessage = (evt) => {
        try{
          const payload = JSON.parse(evt.data);
          if (payload.type === "snapshot") safeRender(payload.records || []);
        }catch{}
      };
      sse.onerror = () => { startPolling(); };
    }catch{
      startPolling();
    }
  }

  /* ======================== FORM ADD ========================== */
  const form = document.getElementById("formDisparo");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const tipo  = document.getElementById("tipo").value.trim();
    const tempo = Number(document.getElementById("tempo").value || 0);
    const potes = Number(document.getElementById("potes").value || 0);
    const volume = Number(document.getElementById("volume").value || 0);
    const horario = document.getElementById("horario").value;
    const template = document.getElementById("templateSel").value;

    if(!tipo) return;

    const optimisticRecord = { id: uid(), tipo, tempo, potes, volume, horario, template, status:"Em andamento" };
    (lastNonEmpty = lastNonEmpty || []).push(optimisticRecord);
    safeRender(lastNonEmpty);

    if (OFFLINE_MODE) { e.target.reset(); return; }
    if(!isAuthed){
      toast("Você está em modo leitura. Faça login para adicionar.", "warn", 3000, "readonly-add");
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      safeRender(lastNonEmpty);
      return;
    }

    try{
      const body = JSON.stringify(optimisticRecord);
      const resp = await fetch(url("/api/disparos"), {
        method:"POST", headers:{"Content-Type":"application/json"},
        credentials:"include", body
      });
      if (!resp.ok){
        if (resp.status === 401){
          toast("Sessão expirada. Faça login novamente.", "warn", 3500, "sessao");
          isAuthed = false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        }else{
          toast("Não consegui salvar no servidor.", "error");
        }
        // desfaz otimista
        lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
        safeRender(lastNonEmpty);
      } else {
        e.target.reset();
        setTimeout(softRefresh, 400);
        toast("Disparo adicionado!", "ok");
      }
    }catch{
      toast("Falha de rede ao salvar.", "error");
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      safeRender(lastNonEmpty);
    }
  });

  /* ====================== LOGIN / LOGOUT ====================== */
  const loginForm = document.getElementById("loginForm");
  const btnLogin  = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const u = (document.getElementById("loginUser").value || "").trim();
    const p = (document.getElementById("loginPass").value || "").trim();
    if (!u || !p){ return; }
    btnLogin.disabled = true;

    // libera UI imediatamente se for o par padrão
    if (u !== "energia" || p !== "energia1") {
      toast("Usuário ou senha inválidos.", "error");
      btnLogin.disabled = false;
      return;
    }
    isAuthed = true; localStorage.setItem(AUTH_KEY, "1"); updateAuthUI(); switchTab("painel");

    try{
      const r = await fetch(url("/api/login"), {
        method:"POST", headers:{"Content-Type":"application/json"},
        credentials:"include", body: JSON.stringify({ username:u, password:p })
      });
      if (!r.ok){
        toast("Sessão não criada no servidor, mas UI liberada.", "warn");
      }else{
        setTimeout(softRefresh, 150);
        toast("Login realizado!", "ok");
      }
    }catch{
      toast("Rede instável ao criar sessão. UI liberada.", "warn");
    }finally{
      btnLogin.disabled = false;
    }
  });

  btnLogout.addEventListener("click", () => {
    isAuthed = false; localStorage.removeItem(AUTH_KEY);
    updateAuthUI(); switchTab("login");
    const u = document.getElementById("loginUser"), p = document.getElementById("loginPass");
    if (p) p.value = ""; if (u) { u.focus(); }
    try{ fetch(url("/api/logout"), { method:"POST", credentials:"include" }); }catch{}
    toast("Sessão encerrada.", "ok");
  });

  /* =================== MODAL + Templates ====================== */
  const TEMPLATES = {
    "Preventivo D0":
`Olá $[nome]!😊

Seu boleto vence Hoje! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o código de barras.(Caso já tenha pago é só desconsiderar)

*Valor* R$: $[valor]
*Vencimento* : $[data_vencimento]

📞 Este é nosso número oficial de atendimento. Caso tenha alguma dúvida é só entrar em contato por aqui, combinado? 👍

Energia de TODOS: Faz bem para o seu bolso e para o planeta!🌎 💚`,

    "Preventivo D3 e D10":
`Olá $[nome]!😊

Seu boleto vence em $[data_vencimento]! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o código de barras (Caso já tenha pago é só desconsiderar).

*Valor* R$ : $[valor]

📞 Este é nosso número oficial de atendimento. Caso tenha alguma dúvida é só entrar em contato por aqui, combinado? 👍

Energia de TODOS: A Energia que Retorna!🌎`,

    "Vencidos 1":
`Olá $[nome]!😊

*ATENÇÃO! Sua conta de energia venceu há $[dias_vencidos] dias atrás e não identificamos seu pagamento*

*Valor* R$ :$[valor]
*Vencimento* : $[data_vencimento]

*Atenção*: não deixe de pagar em dia suas faturas para evitar juros e continuar economizando! (Favor desconsiderar essa mensagem, caso já tenha pago).

👉 Caso não tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o código de barras.

❗ Caso tenha dúvida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* 🌎💚`,

    "Vencidos 2":
`Olá $[nome]!😊

*ATENÇÃO! Sua conta de energia venceu há  $[dias_vencidos]  dias atrás e não identificamos seu pagamento*

Por conta disso poderá haver a suspensão de energia solar. A boa notícia é que ainda há chances de regularizar antes que isso aconteça.  (Favor desconsiderar essa mensagem, caso já tenha pago).

*Valor* R$ :  $[valor]
*Vencimento* : $[data_vencimento]

👉 Caso não tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o código de barras.

❗ Caso tenha dúvida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* 🌎💚`,

    "Vencidos 5":
`Olá $[nome]!😊

⚠ Até o momento não identificamos o pagamento do seu débito com a Energia de TODOS. Após várias tentativas de contato e de negociação sem sucesso, encaminhamos o seu cadastro ao Serviço de Proteção ao Crédito - SPC.

👉 Quantidade de boletos sem pagamento:  $[quantidade_boletos]
👉 Valor pendente: R$  $[valor]

Queremos escutar a sua proposta! 👉 Para conhecer nossas opções de parcelamento, fale abaixo com nossos atendentes.

📞 Este é nosso número oficial de atendimento via WhatsApp. Se tiver alguma dúvida é só entrar em contato por aqui, combinado? 👍

*Mais Sol, Energia e Economia para TODOS* 🌎💚`
  };

  const detailsModal = document.getElementById('detailsModal');
  let currentTemplateText = "";
  let currentResumoText = "";

  function openDetails(div){
    const tipo = div.dataset.tipo || "";
    const status = (div.dataset.status || "").toLowerCase();
    const tempo = Number(div.dataset.tempo || 0);
    const potes = Number(div.dataset.potes || 0);
    const volume = Number(div.dataset.volume || 0);
    const horario = div.dataset.horario || "";
    const tplName = div.dataset.template || "";

    const tempoTotalMin = Math.max(0, tempo * Math.max(1, potes));
    const tempoRestante = tempoTotalMin;

    document.getElementById('modalTitle').textContent = tipo || '(sem título)';

    const chipStatus  = document.getElementById('chipStatus');
    const chipHorario = document.querySelector('#chipHorario span');
    const chipPotes   = document.querySelector('#chipPotes span');
    const chipVolume  = document.querySelector('#chipVolume span');
    const chipTempo   = document.querySelector('#chipTempo span');
    const chipRest    = document.querySelector('#chipRestante span');

    chipHorario.textContent = horario || '—';
    chipPotes.textContent   = (potes||0).toString();
    chipVolume.textContent  = (volume||0).toString();
    chipTempo.textContent   = tempo ? `${tempo} min` : '—';
    chipRest.textContent    = tempoRestante ? `${tempoRestante} min` : '—';

    chipStatus.querySelector('span').textContent = (status ? (status[0].toUpperCase()+status.slice(1)) : '—');

    // pinta o chip do Status
    let bg = '#eef2f7', border = '#e2e8f0', color = '#0f172a';
    if (status === 'em andamento' || status === 'andamento'){
      bg = '#fff7ed'; border = '#fed7aa'; color = '#9a3412';
    } else if (status === 'finalizado'){
      bg = '#ecfdf5'; border = '#bbf7d0'; color = '#065f46';
    } else if (status === 'insucesso'){
      bg = '#fef2f2'; border = '#fecaca'; color = '#991b1b';
    }
    chipStatus.style.background = bg;
    chipStatus.style.borderColor = border;
    chipStatus.style.color = color;

    document.getElementById('tplTitle').textContent = `Template: ${tplName || '—'}`;
    const text = tplName && TEMPLATES[tplName] ? TEMPLATES[tplName] : '(Sem template associado a este disparo)';
    currentTemplateText = text;
    document.getElementById('templateText').textContent = text;

    currentResumoText =
`Disparo: ${tipo || '—'}
Status: ${chipStatus.querySelector('span').textContent}
Horário: ${horario || '—'}
Potes: ${potes || 0}
Volume: ${volume || 0}
Tempo médio: ${tempo ? `${tempo} min` : '—'}
Tempo restante: ${tempoRestante ? `${tempoRestante} min` : '—'}
Template: ${tplName || '—'}`;

    detailsModal.classList.add('show');
  }

  function hideModal(){ detailsModal.classList.remove('show'); }
  detailsModal.addEventListener("click", (e)=>{ if(e.target === detailsModal) hideModal(); });

  async function copyToClipboard(txt){
    try{
      await navigator.clipboard.writeText(txt);
      toast("Copiado para a área de transferência!", "ok");
    }catch{
      toast("Não foi possível copiar.", "error");
    }
  }
  function copyTemplate(){ if (currentTemplateText) copyToClipboard(currentTemplateText); }
  function copyResumo(){ if (currentResumoText) copyToClipboard(currentResumoText); }

  /* ========================== START =========================== */
  (async () => {
    switchTab("painel");
    updateAuthUI();

    if (OFFLINE_MODE) { clearTimeout(splashTimer); hideSplashSoon(); return; }

    startSSE();
    loadInitial();
  })();
</script>
</body>
</html>
