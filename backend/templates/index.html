<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#0b4a8f;
      --primary-2:#0f6ad8;

      --andamento:#ff9f1a;
      --finalizado:#1fb36a;
      --insucesso:#e23b3b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px; width:100%; flex:1}

    .app-header{
      background: linear-gradient(90deg,var(--primary),var(--primary-2));
      color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18);
      margin:0 0 12px 0;
    }
    .app-title{margin:0; padding:20px 16px; text-align:center; font-size:26px; letter-spacing:.3px}

    .legenda{
      display:flex; flex-wrap:wrap; justify-content:center; gap:12px;
      margin:16px 0 8px;
    }
    .legenda-item{
      display:flex; align-items:center; gap:8px; font-weight:600;
      background:var(--card); padding:8px 12px; border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.06);
      border:1px solid var(--border);
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .legenda-item:hover{transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.10)}
    .cor{width:16px;height:16px;border-radius:4px;display:inline-block}
    .cor.andamento{background:var(--andamento)}
    .cor.finalizado{background:var(--finalizado)}
    .cor.insucesso{background:var(--insucesso)}

    .form-container{
      background:var(--card); border:1px solid var(--border);
      padding:20px; margin:18px 0; border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }
    .form-container h2{margin:0 0 12px; color:var(--primary)}
    .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .form-grid > .full{grid-column:1 / -1}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,button{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px;
      background:#fff; color:var(--text); font-size:14px;
      transition:border-color .2s ease, box-shadow .2s ease, transform .1s ease;
    }
    button{
      background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer;
      letter-spacing:.2px;
    }

    .table-card{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.08); overflow:hidden;
    }
    .grid{
      display:grid;
      grid-template-columns: 160px repeat(4, minmax(200px,1fr));
      border-collapse: collapse;
      width:100%;
    }
    .grid > div{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:12px; min-height:72px; background:#fff;
    }
    .header{
      background:#f8fafc; color:#0f172a; font-weight:800; text-transform:uppercase;
      text-align:center;
    }

    .disparo{
      border-radius:12px;
      padding:12px;
      margin:8px 0;
      color:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.15);
      cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease;
    }
    .disparo:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(0,0,0,.22) }

    .status-andamento{ background:var(--andamento) }
    .status-finalizado{ background:var(--finalizado) }
    .status-insucesso{ background:var(--insucesso) }

    .badge{
      font-size:11px; font-weight:800;
      padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.25);
      margin-bottom:6px;
      display:inline-block;
    }
    .title{font-weight:800; font-size:14px; margin-bottom:4px}
    .meta{font-size:12px; opacity:.95}

    .footer{
      width:100%;
      background:#fff;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:13px;
      text-align:center;
      padding:14px 12px;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <h1 class="app-title">Painel de Disparos</h1>
  </header>

  <div class="wrap">
    <div class="legenda">
      <div class="legenda-item"><span class="cor andamento"></span> Em andamento</div>
      <div class="legenda-item"><span class="cor finalizado"></span> Finalizado</div>
      <div class="legenda-item"><span class="cor insucesso"></span> Insucesso</div>
    </div>

    <div class="form-container">
      <h2>Novo Disparo</h2>
      <form id="formDisparo" class="form-grid">
        <div>
          <label for="tipo">Tipo de Disparo</label>
          <input type="text" id="tipo" required />
        </div>
        <div>
          <label for="tempo">Tempo Médio (minutos)</label>
          <input type="number" id="tempo" min="0" required />
        </div>
        <div>
          <label for="potes">Quantidade de Potes</label>
          <input type="number" id="potes" min="1" required />
        </div>
        <div>
          <label for="horario">Horário</label>
          <select id="horario" required>
            <option value="08:00">08:00</option>
            <option value="12:00">12:00</option>
            <option value="16:00">16:00</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="full">
          <button type="submit">Adicionar</button>
        </div>
      </form>
    </div>

    <div class="table-card">
      <div class="grid" id="painel">
        <div class="header">Horário</div>
        <div class="header">08:00</div>
        <div class="header">12:00</div>
        <div class="header">16:00</div>
        <div class="header">20:00</div>
        <div class="header">Disparos</div>
        <div id="col-08"></div>
        <div id="col-12"></div>
        <div id="col-16"></div>
        <div id="col-20"></div>
      </div>
    </div>
  </div>

  <footer class="footer">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <script>
  const API_BASE = "https://painelchamados.fly.dev/";
  const OFFLINE_MODE = false;

  function clsForStatus(status){
    switch((status||"").toLowerCase()){
      case "finalizado": return "status-finalizado";
      case "insucesso": return "status-insucesso";
      default: return "status-andamento";
    }
  }
  function nextStatus(current){
    const order = ["Em andamento","Finalizado","Insucesso"];
    const i = order.indexOf(current);
    return order[(i+1) % order.length];
  }
  function uid(){ return "tmp_" + Math.random().toString(36).slice(2); }

  function clearColumns(){
    ["08","12","16","20"].forEach(h => {
      const el = document.getElementById("col-"+h);
      if (el) el.innerHTML = "";
    });
  }

  function cardTemplate(r, {optimistic=false} = {}){
    const div = document.createElement("div");
    div.className = `disparo ${clsForStatus(r.status)}`;
    div.dataset.id = r.id || uid();
    div.dataset.status = r.status || "Em andamento";
    div.dataset.horario = r["horario"] || "08:00";
    if (optimistic) div.dataset.optimistic = "1";

    div.innerHTML = `
      <span class="badge">${r.status || "Em andamento"}</span>
      <div class="title">${r.tipo || ""}</div>
      <div class="meta">Tempo médio: <strong>${r.tempo ?? ""} min</strong> • Potes: <strong>${r.potes ?? ""}</strong></div>
    `;

    div.addEventListener("click", async () => {
      const current = div.dataset.status;
      const next = nextStatus(current);
      try{
        const id = div.dataset.id;
        const res = await fetch(`${API_BASE}/api/disparos/${id}`, {
          method: "PATCH",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ status: next })
        });
        if (res.ok){
          div.querySelector(".badge").textContent = next;
          div.className = `disparo ${clsForStatus(next)}`;
          div.dataset.status = next;
        }
      }catch(e){ console.error(e); }
    });
    return div;
  }

  function placeRecord(r, opts){
    const hh = (r["horario"] || "08:00").split(":")[0];
    const col = document.getElementById("col-"+hh);
    if (col) col.appendChild(cardTemplate(r, opts));
  }

  function renderSnapshot(records){
    clearColumns();
    (records||[]).forEach(r => placeRecord(r));
  }

  async function loadInitial(){
    if (OFFLINE_MODE) return;
    const resp = await fetch(`${API_BASE}/api/disparos`);
    if (!resp.ok) return;
    renderSnapshot(await resp.json());
  }

  function attachStream(){
    if (OFFLINE_MODE) return;
    const es = new EventSource(`${API_BASE}/api/stream`);
    es.onmessage = (evt) => {
      try{
        const payload = JSON.parse(evt.data);
        if (payload.type === "snapshot"){
          renderSnapshot(payload.records);
        }
      }catch(e){ console.error(e); }
    };
  }

  document.getElementById("formDisparo").addEventListener("submit", async (e) => {
    e.preventDefault();
    const tipo  = document.getElementById("tipo").value.trim();
    const tempo = Number(document.getElementById("tempo").value);
    const potes = Number(document.getElementById("potes").value);
    const horario = document.getElementById("horario").value;
    const optimisticRecord = {id: uid(), tipo, tempo, potes, horario, status:"Em andamento"};
    placeRecord(optimisticRecord, {optimistic:true});
    try{
      await fetch(`${API_BASE}/api/disparos`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify(optimisticRecord)
      });
      e.target.reset();
    }catch{}
  });

  (async()=>{ await loadInitial(); attachStream(); })();
  </script>
</body>
</html>
