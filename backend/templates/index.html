<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#0b4a8f; --primary-2:#0f6ad8;
      --andamento:#ff9f1a; --finalizado:#1fb36a; --insucesso:#e23b3b;
      --warn:#fbbf24; --error:#ef4444; --ok:#10b981;
      --chip:#eef2f7;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text); margin:0; display:flex; flex-direction:column; min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px;width:100%;flex:1}

    .app-header{background: linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); margin:0 0 12px 0}
    .app-title{margin:0; padding:20px 16px; text-align:center; font-size:26px; letter-spacing:.3px}

    .tabs{display:flex; gap:10px; justify-content:center; margin:12px 0 0}
    .tab{background:#fff; border:1px solid var(--border); color:#111827; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700; transition:transform .15s ease, box-shadow .2s ease}
    .tab:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.08) }
    .tab.active{ border-color: var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.12) }

    .legend{display:flex; gap:12px; justify-content:center; margin:16px 0}
    .legend .item{display:flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--border); padding:8px 12px; border-radius:10px}

    .dot{width:12px;height:12px;border-radius:3px}
    .dot.and{background:var(--andamento)}
    .dot.fin{background:var(--finalizado)}
    .dot.ins{background:var(--insucesso)}

    .form-card{background:#fff; border:1px solid var(--border); border-radius:14px; padding:20px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .form-title{margin:0 0 12px; font-weight:800; color:var(--primary)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid2 .full{grid-column:1/-1}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,button{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#111827; font-size:14px}
    button{background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer}
    button:disabled{opacity:.7; cursor:not-allowed}

    .table-card{background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.08); overflow:hidden; margin-top:14px}
    .grid{display:grid; grid-template-columns: 160px repeat(4, minmax(200px,1fr)); width:100%}
    .grid > div{border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:12px; min-height:72px; background:#fff}
    .header{background:#f8fafc; color:#0f172a; font-weight:800; text-transform:uppercase; text-align:center}

    .disparo{border-radius:12px; padding:12px; margin:8px 0; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.15); cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; animation:pop .2s ease-out both}
    .disparo:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(0,0,0,.22) }
    .status-andamento{ background:var(--andamento) } .status-finalizado{ background:var(--finalizado) } .status-insucesso{ background:var(--insucesso) }
    .badge{ font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.25); margin-bottom:6px; display:inline-block }
    .title{font-weight:800; font-size:14px; margin-bottom:4px} .meta{font-size:12px; opacity:.95}
    @keyframes pop{from{opacity:0; transform:translateY(4px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}

    .login-card{background:#fff; border:1px solid var(--border); padding:20px; margin:18px auto; border-radius:14px; max-width:520px; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .login-title{margin:0 0 12px; color:var(--primary); text-align:center}
    .login-actions{display:flex; gap:10px; margin-top:8px}
    .btn-danger{background:#ef4444}

    .splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:9999; transition:opacity .25s ease}
    .splash.hide{ opacity:0; pointer-events:none }
    .ring{ width:48px; height:48px; border:4px solid #e5e7eb; border-top-color:var(--primary-2); border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .topbar{position:fixed; top:14px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:9999; pointer-events:none}
    .toast{pointer-events:auto; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; box-shadow:0 10px 24px rgba(0,0,0,.08); font-size:14px; display:flex; align-items:center; gap:10px; min-width:240px; justify-content:center}
    .toast.ok{ border-color:#bbf7d0; background:#f0fdf4 } .toast.error{ border-color:#fecaca; background:#fff1f2 } .toast.warn{ border-color:#fde68a; background:#fffbeb }
    .toast .x{margin-left:6px; cursor:pointer; font-weight:800}

    /* MODAL */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:flex-start; justify-content:center; padding:28px; z-index:9990}
    .modal.show{display:flex}
    .modal-card{width:min(920px, 96vw); background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 18px 44px rgba(0,0,0,.22); overflow:hidden}
    .modal-header{position:relative; background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; padding:12px 48px 12px 16px; font-weight:900; display:flex; align-items:center; gap:12px}
    .modal-close{position:absolute; right:10px; top:8px; width:28px; height:28px; border-radius:999px; background:#0d4ea3; color:#fff; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:900}
    .modal-body{padding:14px 14px 18px}
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 14px}
    .chip{background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:13px}
    .status-chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:13px; border:1px solid var(--border)}
    .status-col-andamento{ background:#fff5e6; color:#7a4b00 }
    .status-col-finalizado{ background:#e8fff2; color:#0f6a44 }
    .status-col-insucesso{ background:#ffecec; color:#8b1e1e }
    .template-box{border:1px dashed var(--border); border-radius:12px; padding:12px; background:#fff}
    .modal-actions{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
  </style>
</head>
<body>
  <div id="splash" class="splash"><div class="ring" aria-label="Carregando"></div></div>
  <div id="topbar" class="topbar" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <h1 class="app-title">Painel de Disparos</h1>
  </header>

  <div class="wrap">
    <nav class="tabs">
      <button class="tab active" data-tab="painel">Painel</button>
      <button class="tab" data-tab="login">Login</button>
    </nav>

    <div class="legend">
      <div class="item"><span class="dot and"></span> Em andamento</div>
      <div class="item"><span class="dot fin"></span> Finalizado</div>
      <div class="item"><span class="dot ins"></span> Insucesso</div>
    </div>

    <!-- PAINEL -->
    <section id="view-painel">
      <div class="form-card" id="form-wrapper" style="display:none;">
        <h2 class="form-title">Novo Disparo</h2>
        <form id="formDisparo" class="grid2">
          <div>
            <label>Nome do Disparo</label>
            <input type="text" id="tipo" placeholder="Ex.: Disparo D0" required />
          </div>
          <div>
            <label>Template (opcional)</label>
            <select id="templateSelect">
              <option value="">‚Äî Sem template ‚Äî</option>
              <option value="Preventivo D0">Preventivo D0</option>
              <option value="Preventivo D3 e D10">Preventivo D3 e D10</option>
              <option value="Vencidos 1">Vencidos 1</option>
              <option value="Vencidos 2">Vencidos 2</option>
              <option value="Vencidos 5">Vencidos 5</option>
            </select>
          </div>

          <div>
            <label>Tempo M√©dio (min)</label>
            <input type="number" id="tempo" min="0" value="12" />
          </div>
          <div>
            <label>Quantidade de Potes</label>
            <input type="number" id="potes" min="1" value="1" />
          </div>

          <div>
            <label>Volume de Disparos</label>
            <input type="number" id="volume" min="0" value="0" />
          </div>
          <div>
            <label>Hor√°rio</label>
            <select id="horario">
              <option>08:00</option><option>12:00</option><option>16:00</option><option>20:00</option>
            </select>
          </div>

          <div class="full">
            <button type="submit" id="btnAdd">Adicionar</button>
          </div>
        </form>
      </div>

      <div id="readOnlyHint" class="form-card" style="display:none;">
        <strong>Modo leitura:</strong> fa√ßa login para adicionar/alterar.
      </div>

      <div class="table-card">
        <div class="grid">
          <div class="header">Hor√°rio</div>
          <div class="header">08:00</div>
          <div class="header">12:00</div>
          <div class="header">16:00</div>
          <div class="header">20:00</div>

          <div class="header">Disparos</div>
          <div id="col-08"></div>
          <div id="col-12"></div>
          <div id="col-16"></div>
          <div id="col-20"></div>
        </div>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="view-login" style="display:none;">
      <div class="login-card">
        <h2 class="login-title">Acessar</h2>
        <form id="loginForm">
          <label>Usu√°rio</label>
          <input type="text" id="loginUser" value="energia" required />
          <label style="margin-top:10px;">Senha</label>
          <input type="password" id="loginPass" value="energia1" required />
          <div class="login-actions">
            <button type="submit" id="btnLogin">Entrar</button>
            <button type="button" class="btn-danger" id="btnLogout" style="display:none;">Sair</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <footer class="footer" style="text-align:center;color:#6b7280;padding:14px 12px;border-top:1px solid var(--border);background:#fff;">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <!-- MODAL -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <div id="m-title" style="font-size:18px; font-weight:900;">Detalhes</div>
        <button class="modal-close" id="m-close" title="Fechar">√ó</button>
      </div>
      <div class="modal-body">
        <div class="chips" id="m-chips"></div>
        <div style="font-weight:800; margin:8px 0 8px;">Template: <span id="m-tpl-name">‚Äî</span></div>
        <div class="template-box">
          <pre id="m-tpl" style="white-space:pre-wrap; font-family:inherit; margin:0;"></pre>
        </div>
        <div class="modal-actions">
          <button id="btnCopyTpl">Copiar template</button>
          <button id="btnCopyResumo">Copiar resumo</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ===================== CONFIG ===================== */
  const API_BASE = ""; // mesmo host
  const IS_FILE = location.protocol === "file:";
  const url = (p) => `${(API_BASE||"").replace(/\/+$/,"")}${p}`;

  /* ===================== SPLASH + TOAST ===================== */
  const splash = document.getElementById("splash");
  const hideSplash = () => { splash?.classList.add("hide"); setTimeout(()=>splash?.remove(),300); };
  setTimeout(hideSplash, 1200);

  const topbar = document.getElementById("topbar");
  function toast(msg, type="ok", ms=2600){
    const div = document.createElement("div");
    div.className = `toast ${type}`;
    div.innerHTML = `<span>${msg}</span>`;
    topbar.appendChild(div);
    setTimeout(()=>div.remove(), ms);
  }

  /* ===================== AUTH ===================== */
  const AUTH_KEY = "painel_auth_ok";
  let isAuthed = localStorage.getItem(AUTH_KEY) === "1";

  function updateAuthUI(){
    const formWrap = document.getElementById("form-wrapper");
    const hint = document.getElementById("readOnlyHint");
    const btnLogout = document.getElementById("btnLogout");
    if(isAuthed){
      formWrap.style.display = "";
      hint.style.display = "none";
      btnLogout.style.display = "";
    }else{
      formWrap.style.display = "none";
      hint.style.display = "";
      btnLogout.style.display = "none";
    }
  }

  /* ===================== TABS ===================== */
  const tabs = document.querySelectorAll(".tab");
  function switchTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    document.getElementById("view-painel").style.display = (name==="painel") ? "" : "none";
    document.getElementById("view-login").style.display  = (name==="login") ? "" : "none";
  }
  tabs.forEach(b => b.addEventListener("click", ()=> switchTab(b.dataset.tab)));

  /* ===================== TEMPLATE LIB ===================== */
  const TEMPLATE_LIB = {
    "Preventivo D0": ({nome,valor,data_vencimento}) => 
`Ol√° ${nome}!üòä

Seu boleto vence Hoje! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o c√≥digo de barras.(Caso j√° tenha pago √© s√≥ desconsiderar)

*Valor* R$: ${valor}
*Vencimento* : ${data_vencimento}

üìû Este √© nosso n√∫mero oficial de atendimento. Caso tenha alguma d√∫vida √© s√≥ entrar em contato por aqui, combinado? üëç

Energia de TODOS: Faz bem para o seu bolso e para o planeta!üåé üíö`,

    "Preventivo D3 e D10": ({nome,valor,data_vencimento}) =>
`Ol√° ${nome}!üòä

Seu boleto vence em ${data_vencimento}! Para facilitar vamos encaminhar ele novamente por aqui.
Clique no documento para ver seu consumo de energia e o c√≥digo de barras (Caso j√° tenha pago √© s√≥ desconsiderar).

*Valor* R$ : ${valor}

üìû Este √© nosso n√∫mero oficial de atendimento. Caso tenha alguma d√∫vida √© s√≥ entrar em contato por aqui, combinado? üëç

Energia de TODOS: A Energia que Retorna!üåé`,

    "Vencidos 1": ({nome,valor,data_vencimento,dias_vencidos}) =>
`Ol√° ${nome}!üòä

*ATEN√á√ÉO! Sua conta de energia venceu h√° ${dias_vencidos} dias atr√°s e n√£o identificamos seu pagamento*

*Valor* R$ :${valor}
*Vencimento* : ${data_vencimento}

*Aten√ß√£o*: n√£o deixe de pagar em dia suas faturas para evitar juros e continuar economizando! (Favor desconsiderar essa mensagem, caso j√° tenha pago).

üëâ Caso n√£o tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o c√≥digo de barras.

‚ùó Caso tenha d√∫vida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* üåéüíö`,

    "Vencidos 2": ({nome,valor,data_vencimento,dias_vencidos}) =>
`Ol√° ${nome}!üòä

*ATEN√á√ÉO! Sua conta de energia venceu h√°  ${dias_vencidos}  dias atr√°s e n√£o identificamos seu pagamento*

Por conta disso poder√° haver a suspens√£o de energia solar. A boa not√≠cia √© que ainda h√° chances de regularizar antes que isso aconte√ßa.  (Favor desconsiderar essa mensagem, caso j√° tenha pago).

*Valor* R$ :  ${valor}
*Vencimento* : ${data_vencimento}

üëâ Caso n√£o tenha recebido o boleto *Energia de TODOS* vamos enviar ele aqui agora mesmo!

Clique no documento para ver seu consumo de energia e o c√≥digo de barras.

‚ùó Caso tenha d√∫vida, fale abaixo com nossos atendentes .

*Mais Sol, Energia e Economia para TODOS* üåéüíö`,

    "Vencidos 5": ({quantidade_boletos,valor}) =>
`Ol√° ${"${nome}"}!üòä

‚ö† At√© o momento n√£o identificamos o pagamento do seu d√©bito com a Energia de TODOS. Ap√≥s v√°rias tentativas de contato e de negocia√ß√£o sem sucesso, encaminhamos o seu cadastro ao Servi√ßo de Prote√ß√£o ao Cr√©dito - SPC.

üëâ Quantidade de boletos sem pagamento:  ${quantidade_boletos}
üëâ Valor pendente: R$  ${valor}

Queremos escutar a sua proposta! üëâ Para conhecer nossas op√ß√µes de parcelamento, fale abaixo com nossos atendentes.

üìû Este √© nosso n√∫mero oficial de atendimento via WhatsApp. Se tiver alguma d√∫vida √© s√≥ entrar em contato por aqui, combinado? üëç

*Mais Sol, Energia e Economia para TODOS* üåéüíö`,
  };

  /* ===================== RENDER ===================== */
  const COLS = { "08:00":"col-08", "12:00":"col-12", "16:00":"col-16", "20:00":"col-20" };
  function statusClass(s){ s=(s||"").toLowerCase(); if(s==="finalizado")return "status-finalizado"; if(s==="insucesso")return "status-insucesso"; return "status-andamento";}

  function clearCols(){ Object.values(COLS).forEach(id => { const el=document.getElementById(id); if(el) el.innerHTML=""; }); }

  function cardTemplate(r){
    const div = document.createElement("div");
    div.className = `disparo ${statusClass(r.status)}`;
    div.dataset.id = r.id;
    div.innerHTML = `
      <span class="badge">${r.status||"Em andamento"}</span>
      <div class="title">${r.tipo||""}</div>
      <div class="meta">Tempo m√©dio: <strong>${r.tempo??""} min</strong> ‚Ä¢ Potes: <strong>${r.potes??""}</strong> ‚Ä¢ Vol.: <strong>${r.volume??0}</strong></div>
    `;
    div.addEventListener("click", ()=> openModal(r));
    return div;
  }

  function place(r){
    const hh = (r.horario||"08:00").slice(0,2);
    const col = document.getElementById(`col-${hh}`);
    if(col) col.appendChild(cardTemplate(r));
  }

  function render(records){ clearCols(); (records||[]).forEach(place); }

  /* ===================== DATA + SSE ===================== */
  let lastHash = "";
  let lastSnapshot = [];
  let sse;

  function calcHash(records){
    try{
      return (records||[]).map(r => `${r.id}|${r.tipo}|${r.status}|${r.horario}|${r.tempo}|${r.potes}|${r.volume}|${r.template||""}`).join("¬ß");
    }catch{ return Math.random().toString(36); }
  }

  function applySnapshot(records, stale=false){
    const h = calcHash(records);
    if (h === lastHash) return;
    // se vier vazio E for stale, ignoramos (evita flicker). Se vazio e N√ÉO stale => aplicar (ex.: deletou tudo)
    if ((records?.length||0)===0 && stale) return;
    render(records);
    lastHash = h;
    lastSnapshot = records;
  }

  async function loadInitial(){
    try{
      const resp = await fetch(url("/api/disparos"), {credentials:"include", cache:"no-store"});
      const stale = resp.headers.get("X-Data-Stale")==="1";
      const data = await resp.json();
      applySnapshot(data, stale);
    }catch{}
    hideSplash();
  }

  function startSSE(){
    try{
      if (sse) sse.close();
      sse = new EventSource(url("/api/stream"));
      sse.onmessage = (evt)=>{
        try{
          const payload = JSON.parse(evt.data||"{}");
          if (payload.type==="snapshot") applySnapshot(payload.records||[], !!payload.stale);
        }catch{}
      };
      sse.onerror = ()=>{}; // polling n√£o necess√°rio aqui pois stream for√ßa leitura real
    }catch{}
  }

  /* ===================== FORM ===================== */
  document.getElementById("formDisparo").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!isAuthed){ toast("Fa√ßa login para adicionar.", "warn"); return; }

    const tipo = document.getElementById("tipo").value.trim();
    const tempo = Number(document.getElementById("tempo").value||0);
    const potes = Number(document.getElementById("potes").value||0);
    const volume = Number(document.getElementById("volume").value||0);
    const horario = document.getElementById("horario").value;
    const template = document.getElementById("templateSelect").value || "";

    if (!tipo) return;

    try{
      const resp = await fetch(url("/api/disparos"), {
        method:"POST",
        credentials:"include",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          tipo, tempo, potes, volume, horario, template,
          status:"Em andamento"
        })
      });
      if(!resp.ok){
        if(resp.status===401){ isAuthed=false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login"); toast("Sess√£o expirada.","warn"); }
        else{
          const txt = await resp.text();
          console.warn("POST falhou:", txt);
          toast("N√£o consegui salvar no servidor.","error");
        }
        return;
      }
      (e.target).reset();
      document.getElementById("tempo").value = 12;
      document.getElementById("potes").value = 1;
      document.getElementById("volume").value = 0;
      toast("Disparo adicionado!","ok");
      setTimeout(loadInitial, 250);
    }catch{
      toast("Falha de rede ao salvar.","error");
    }
  });

  /* ===================== LOGIN ===================== */
  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value.trim();
    if(!u || !p) return;

    try{
      const r = await fetch(url("/api/login"), {
        method:"POST", credentials:"include",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username:u, password:p})
      });
      if(r.ok){ isAuthed=true; localStorage.setItem(AUTH_KEY,"1"); updateAuthUI(); switchTab("painel"); toast("Login ok!","ok"); setTimeout(loadInitial, 120); }
      else{ toast("Usu√°rio ou senha inv√°lidos.","error"); }
    }catch{ toast("Rede inst√°vel.","warn"); }
  });

  document.getElementById("btnLogout").addEventListener("click", async ()=>{
    try{ await fetch(url("/api/logout"), {method:"POST", credentials:"include"}); }catch{}
    isAuthed=false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login"); toast("Sess√£o encerrada.","ok");
  });

  /* ===================== MODAL ===================== */
  const modal = document.getElementById("modal");
  document.getElementById("m-close").onclick = () => modal.classList.remove("show");
  modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("show"); });

  function statusChip(status){
    const s = (status||"Em andamento").toLowerCase();
    let cls = "status-col-andamento", txt="Em andamento";
    if(s==="finalizado"){ cls="status-col-finalizado"; txt="Finalizado"; }
    else if(s==="insucesso"){ cls="status-col-insucesso"; txt="Insucesso"; }
    const div = document.createElement("div");
    div.className = `status-chip ${cls}`;
    div.innerHTML = `<strong>Status:</strong>&nbsp;${txt}`;
    return div;
  }

  let currentRec = null;

  function openModal(r){
    currentRec = r;
    document.getElementById("m-title").textContent = r.tipo || "Detalhes";

    const chips = document.getElementById("m-chips");
    chips.innerHTML = "";
    chips.append(
      statusChip(r.status),
      chip("Hor√°rio:", r.horario||""),
      chip("Potes:", r.potes??0),
      chip("Volume:", r.volume??0),
      chip("Tempo m√©dio:", (r.tempo??0)+" min"),
      chip("Tempo restante:", calcRestante(r)+" min")
    );

    const tplName = r.template || "‚Äî";
    document.getElementById("m-tpl-name").textContent = tplName;

    const tplGen = TEMPLATE_LIB[tplName];
    const preview = tplGen ? tplGen({
      nome:"${nome}", valor:"${valor}", data_vencimento:"${data_vencimento}",
      dias_vencidos:"${dias_vencidos}", quantidade_boletos:"${quantidade_boletos}"
    }) : "(Sem template associado a este disparo)";
    document.getElementById("m-tpl").textContent = preview;

    modal.classList.add("show");
  }

  function chip(label, value){
    const d = document.createElement("div");
    d.className = "chip";
    d.innerHTML = `<strong>${label}</strong>&nbsp;${value}`;
    return d;
  }

  function calcRestante(r){
    const base = Number(r.tempo||0);
    // sem dados reais de in√≠cio/fim, mostramos o mesmo tempo (mock)
    return base;
  }

  document.getElementById("btnCopyTpl").addEventListener("click", async ()=>{
    const name = currentRec?.template || "";
    const gen = TEMPLATE_LIB[name];
    const text = gen ? gen({
      nome:"${nome}", valor:"${valor}", data_vencimento:"${data_vencimento}",
      dias_vencidos:"${dias_vencidos}", quantidade_boletos:"${quantidade_boletos}"
    }) : "(Sem template)";
    try{ await navigator.clipboard.writeText(text); toast("Template copiado!","ok"); }catch{ toast("Falha ao copiar.","error"); }
  });

  document.getElementById("btnCopyResumo").addEventListener("click", async ()=>{
    const r = currentRec || {};
    const resumo =
`Disparo: ${r.tipo||""}
Status: ${r.status||""}
Hor√°rio: ${r.horario||""}
Potes: ${r.potes??0}
Volume: ${r.volume??0}
Tempo m√©dio: ${r.tempo??0} min
Template: ${r.template||"‚Äî"}`;
    try{ await navigator.clipboard.writeText(resumo); toast("Resumo copiado!","ok"); }catch{ toast("Falha ao copiar.","error"); }
  });

  /* ===================== START ===================== */
  (async ()=>{
    switchTab("painel");
    updateAuthUI();
    startSSE();
    await loadInitial();
  })();
  </script>
</body>
</html>
