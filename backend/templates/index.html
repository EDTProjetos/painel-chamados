<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#0b4a8f;
      --primary-2:#0f6ad8;

      --andamento:#ff9f1a;
      --finalizado:#1fb36a;
      --insucesso:#e23b3b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0; display:flex; flex-direction:column; min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px; width:100%; flex:1}

    .app-header{
      background: linear-gradient(90deg,var(--primary),var(--primary-2));
      color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18);
      margin:0 0 12px 0;
    }
    .app-title{margin:0; padding:20px 16px; text-align:center; font-size:26px; letter-spacing:.3px}

    .tabs{display:flex; gap:10px; justify-content:center; margin:12px 0 0}
    .tab{
      background:#fff; border:1px solid var(--border); color:#111827;
      padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700;
      transition:transform .15s ease, box-shadow .2s ease;
    }
    .tab:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.08) }
    .tab.active{ border-color: var(--primary-2); box-shadow:0 0 0 3px rgba(15,106,216,.12) }

    .legenda{
      display:flex; flex-wrap:wrap; justify-content:center; gap:12px;
      margin:16px 0 8px;
    }
    .legenda-item{
      display:flex; align-items:center; gap:8px; font-weight:600;
      background:var(--card); padding:8px 12px; border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .cor{width:16px;height:16px;border-radius:4px;display:inline-block}
    .cor.andamento{background:var(--andamento)}
    .cor.finalizado{background:var(--finalizado)}
    .cor.insucesso{background:var(--insucesso)}

    .form-container{
      background:var(--card); border:1px solid var(--border);
      padding:20px; margin:18px 0; border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }
    .form-container h2{margin:0 0 12px; color:var(--primary)}
    .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .form-grid > .full{grid-column:1 / -1}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,button{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px;
      background:#fff; color:var(--text); font-size:14px;
    }
    button{
      background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff; font-weight:700; border:none; cursor:pointer;
      letter-spacing:.2px;
    }

    .badge-info{
      display:inline-block; background:#fff; border:1px dashed var(--border); color:var(--muted);
      padding:8px 10px; border-radius:10px; font-size:13px; margin-top:8px;
    }

    .table-card{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.08); overflow:hidden;
    }
    .grid{
      display:grid; grid-template-columns: 160px repeat(4, minmax(200px,1fr)); width:100%;
    }
    .grid > div{
      border-right:1px solid var(--border); border-bottom:1px solid var(--border);
      padding:12px; min-height:72px; background:#fff;
    }
    .header{
      background:#f8fafc; color:#0f172a; font-weight:800; text-transform:uppercase; text-align:center;
    }

    .disparo{
      border-radius:12px; padding:12px; margin:8px 0; color:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.15); cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease; animation:pop .2s ease-out both;
    }
    .disparo:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(0,0,0,.22) }
    .status-andamento{ background:var(--andamento) }
    .status-finalizado{ background:var(--finalizado) }
    .status-insucesso{ background:var(--insucesso) }
    .badge{ font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.25); margin-bottom:6px; display:inline-block }
    .title{font-weight:800; font-size:14px; margin-bottom:4px}
    .meta{font-size:12px; opacity:.95}
    @keyframes pop{from{opacity:0; transform:translateY(4px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}

    .login-card{
      background:var(--card); border:1px solid var(--border);
      padding:20px; margin:18px auto; border-radius:14px; max-width:420px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }
    .login-title{margin:0 0 12px; color:var(--primary); text-align:center}
    .login-actions{display:flex; gap:10px; margin-top:8px}

    .footer{
      width:100%; background:#fff; border-top:1px solid var(--border); color:var(--muted);
      font-size:13px; text-align:center; padding:14px 12px;
    }

    /* Splash/Spinner */
    .splash{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:var(--bg); z-index:9999; transition:opacity .25s ease;
    }
    .splash.hide{ opacity:0; pointer-events:none }
    .ring{ width:48px; height:48px; border:4px solid #e5e7eb; border-top-color:var(--primary-2);
      border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <div id="splash" class="splash"><div class="ring" aria-label="Carregando"></div></div>

  <header class="app-header">
    <h1 class="app-title">Painel de Disparos</h1>
  </header>

  <div class="wrap">
    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="painel">Painel</button>
      <button class="tab" data-tab="login">Login</button>
    </nav>

    <!-- VIEW: PAINEL -->
    <section id="view-painel">
      <div class="legenda">
        <div class="legenda-item"><span class="cor andamento"></span> Em andamento</div>
        <div class="legenda-item"><span class="cor finalizado"></span> Finalizado</div>
        <div class="legenda-item"><span class="cor insucesso"></span> Insucesso</div>
      </div>

      <!-- Form (só logado) -->
      <div id="form-wrapper" class="form-container" style="display:none;">
        <h2>Novo Disparo</h2>
        <form id="formDisparo" class="form-grid">
          <div>
            <label for="tipo">Tipo de Disparo</label>
            <input type="text" id="tipo" required />
          </div>
          <div>
            <label for="tempo">Tempo Médio (minutos)</label>
            <input type="number" id="tempo" min="0" required />
          </div>
          <div>
            <label for="potes">Quantidade de Potes</label>
            <input type="number" id="potes" min="1" required />
          </div>
          <div>
            <label for="horario">Horário</label>
            <select id="horario" required>
              <option value="08:00">08:00</option>
              <option value="12:00">12:00</option>
              <option value="16:00">16:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          <div class="full">
            <button type="submit">Adicionar</button>
          </div>
        </form>
      </div>

      <!-- Aviso quando deslogado -->
      <div id="readOnlyHint" class="badge-info" style="display:none; text-align:center;">
        Você está em <strong>modo leitura</strong>. Faça login para adicionar/alterar disparos.
      </div>

      <!-- Tabela -->
      <div class="table-card" style="margin-top:14px;">
        <div class="grid" id="painel-grid">
          <div class="header">Horário</div>
          <div class="header">08:00</div>
          <div class="header">12:00</div>
          <div class="header">16:00</div>
          <div class="header">20:00</div>

          <div class="header">Disparos</div>
          <div id="col-08"></div>
          <div id="col-12"></div>
          <div id="col-16"></div>
          <div id="col-20"></div>
        </div>
      </div>
    </section>

    <!-- VIEW: LOGIN -->
    <section id="view-login" style="display:none;">
      <div class="login-card">
        <h2 class="login-title">Acessar</h2>
        <form id="loginForm">
          <label for="loginUser">Usuário</label>
          <input type="text" id="loginUser" placeholder="usuário" required />
          <label for="loginPass" style="margin-top:10px;">Senha</label>
          <input type="password" id="loginPass" placeholder="senha" required />
          <div class="login-actions">
            <button type="submit" id="btnLogin">Entrar</button>
            <button type="button" id="btnLogout" style="display:none;background:#ef4444;">Sair</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <footer class="footer">
    Desenvolvido por Leahpar Code &copy; 2025
  </footer>

  <script>
  // ===== CONFIG =====
  // Use MESMO HOST (string vazia) para cookies de sessão funcionarem sem CORS:
  // Se preferir domínio, NÃO coloque barra no fim. Ex.: const API_BASE = "https://painelchamados.fly.dev";
  const API_BASE = "";

  // Detecta ambiente local (file://) ou ?offline=1
  const IS_FILE = location.protocol === "file:";
  const FORCE_OFFLINE = /(?:\\?|&)offline=1\\b/.test(location.search);
  let OFFLINE_MODE = IS_FILE || FORCE_OFFLINE;

  // Normaliza base e monta URLs
  const BASE = (API_BASE || "").replace(/\\/+$/,"");
  const url = (p) => `${BASE}${p}`;

  // ===== Auth (UI) =====
  const AUTH_KEY = "painel_auth_ok";
  let isAuthed = localStorage.getItem(AUTH_KEY) === "1";

  function updateAuthUI(){
    const formWrap = document.getElementById("form-wrapper");
    const hint = document.getElementById("readOnlyHint");
    const logoutBtn = document.getElementById("btnLogout");

    if(isAuthed){
      if (formWrap) formWrap.style.display = "";
      if (hint) hint.style.display = "none";
      if (logoutBtn) logoutBtn.style.display = "";
    }else{
      if (formWrap) formWrap.style.display = "none";
      if (hint) hint.style.display = "";
      if (logoutBtn) logoutBtn.style.display = "none";
    }
  }

  // ===== Tabs =====
  const tabs = document.querySelectorAll(".tab");
  function switchTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.getElementById("view-painel").style.display = (name==="painel") ? "" : "none";
    document.getElementById("view-login").style.display  = (name==="login") ? "" : "none";
    if (name === "login"){
      setTimeout(()=>document.getElementById("loginUser")?.focus(), 50);
    }
  }
  tabs.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

  // ===== Utils =====
  function clsForStatus(status){
    switch((status||"").toLowerCase()){
      case "finalizado": return "status-finalizado";
      case "insucesso":  return "status-insucesso";
      default:           return "status-andamento";
    }
  }
  function nextStatus(current){
    const order = ["Em andamento","Finalizado","Insucesso"];
    const i = order.indexOf(current);
    return order[(i+1) % order.length];
  }
  function uid(){ return "tmp_" + Math.random().toString(36).slice(2); }

  // Hash simples p/ detectar mudanças
  function calcHash(records){
    try{
      return (records||[]).map(r => `${r.id}|${r.tipo}|${r.status}|${r.horario}|${r.tempo}|${r.potes}`).join("§");
    }catch{ return Math.random().toString(36); }
  }

  // ===== Render =====
  function clearColumns(){
    ["08","12","16","20"].forEach(h => {
      const el = document.getElementById("col-"+h);
      if (el) el.innerHTML = "";
    });
  }

  function cardTemplate(r, {optimistic=false} = {}){
    const div = document.createElement("div");
    div.className = `disparo ${clsForStatus(r.status)}`;
    div.dataset.id = r.id || uid();
    div.dataset.status = r.status || "Em andamento";
    div.dataset.horario = r["horario"] || "08:00";
    if (optimistic) div.dataset.optimistic = "1";

    div.innerHTML = `
      <span class="badge">${r.status || "Em andamento"}</span>
      <div class="title">${r.tipo || ""}</div>
      <div class="meta">Tempo médio: <strong>${r.tempo ?? ""} min</strong> • Potes: <strong>${r.potes ?? ""}</strong></div>
    `;

    // Troca de status
    div.addEventListener("click", async () => {
      const current = div.dataset.status;
      const next = nextStatus(current);

      // Offline: atualiza só a UI (para testes locais)
      if (OFFLINE_MODE) {
        div.querySelector(".badge").textContent = next;
        div.className = `disparo ${clsForStatus(next)}`;
        div.dataset.status = next;
        return;
      }

      // Online: requer login
      if (!isAuthed){
        alert("Faça login para alterar o status.");
        return;
      }
      try{
        const id = div.dataset.id;
        const res = await fetch(url(`/api/disparos/${id}`), {
          method: "PATCH",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify({ status: next })
        });
        if (res.ok){
          div.querySelector(".badge").textContent = next;
          div.className = `disparo ${clsForStatus(next)}`;
          div.dataset.status = next;
          setTimeout(softRefresh, 600);
        }else if(res.status === 401){
          alert("Sessão expirada. Faça login novamente.");
          isAuthed = false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        }
      }catch(e){ console.error(e); }
    });

    return div;
  }

  function placeRecord(r, opts){
    const hh = (r["horario"] || "08:00").split(":")[0];
    const col = document.getElementById("col-"+hh);
    if (col) col.appendChild(cardTemplate(r, opts));
  }

  function renderSnapshot(records){
    clearColumns();
    (records||[]).forEach(r => placeRecord(r));
  }

  // ===== Data / Robustez / Desempenho =====
  const CACHE_KEY = "painel_snapshot_v1";
  const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6h
  let lastNonEmpty = [];
  let lastHash = "";
  let sse = null;
  let sseFailures = 0;
  let pollTimer = null;
  let gotFirstPaint = false;
  let firstDataArrived = false;
  let hideTimer = null;

  function hideSplashSoon(){
    const s = document.getElementById("splash");
    if (!s) return;
    s.classList.add("hide");
    setTimeout(()=>{ try{s.remove();}catch{} }, 300);
  }
  // Garante que o spinner suma rápido mesmo sem backend
  hideTimer = setTimeout(hideSplashSoon, 1000);

  // Mostra do cache imediatamente (se recente)
  (function paintFromCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return;
      const {ts, data} = JSON.parse(raw);
      if (!data || (Date.now() - ts) > CACHE_TTL_MS) return;
      lastNonEmpty = data;
      lastHash = calcHash(data);
      renderSnapshot(data);
      clearTimeout(hideTimer);
      hideSplashSoon();
      gotFirstPaint = true;
    }catch{}
  })();

  function saveCache(records){
    try{
      const payload = { ts: Date.now(), data: records };
      const job = () => localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
      (window.requestIdleCallback || setTimeout)(job, 0);
    }catch{}
  }

  function safeRender(records){
    const incomingHash = calcHash(records);
    if (incomingHash === lastHash) return;
    if ((records?.length || 0) === 0 && (lastNonEmpty?.length || 0) > 0) {
      console.warn("[UI] Snapshot vazio ignorado para manter estado estável.");
      return;
    }
    renderSnapshot(records);
    lastHash = incomingHash;
    if ((records?.length || 0) > 0) {
      lastNonEmpty = records;
      saveCache(records);
    }
    if (!gotFirstPaint){
      gotFirstPaint = true;
      clearTimeout(hideTimer);
      hideSplashSoon();
    }
  }

  // GET inicial com timeout/abort (não trava a entrada)
  async function loadInitialWithTimeout(ms=2500){
    if (OFFLINE_MODE) return;
    const ctrl = new AbortController();
    const to = setTimeout(()=>ctrl.abort("timeout"), ms);
    try{
      const resp = await fetch(url("/api/disparos"), {
        cache:"no-store", credentials:"include", signal: ctrl.signal
      });
      if (firstDataArrived) return; // SSE já entregou primeiro snapshot
      if (!resp.ok) throw new Error(resp.status);
      const data = await resp.json();
      safeRender(data);
      firstDataArrived = true;
    }catch(e){
      if (e?.name !== "AbortError") console.warn("[loadInitial]", e);
      // Mesmo se falhar, não deixamos spinner preso
      clearTimeout(hideTimer);
      hideSplashSoon();
    }finally{
      clearTimeout(to);
    }
  }

  async function softRefresh(){
    if (OFFLINE_MODE) return;
    try{
      const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
      if (!resp.ok) return;
      const data = await resp.json();
      safeRender(data);
    }catch{}
  }

  function startPolling(){
    if (OFFLINE_MODE) return;
    if (pollTimer) return;
    console.warn("[poll] iniciando fallback por polling");
    pollTimer = setInterval(async ()=>{
      try{
        const resp = await fetch(url("/api/disparos"), {cache:"no-store", credentials:"include"});
        if (!resp.ok) return;
        const data = await resp.json();
        safeRender(data);
      }catch(e){ /* silencioso */ }
    }, 8000);
  }

  function stopPolling(){
    if (pollTimer){
      clearInterval(pollTimer);
      pollTimer = null;
      console.warn("[poll] parado");
    }
  }

  function stopSSE(){
    if (sse){
      try{ sse.close(); }catch{}
      sse = null;
      console.warn("[sse] fechado");
    }
  }

  function startSSE(){
    if (OFFLINE_MODE) { console.info("[sse] desativado (offline)"); return; }
    try{
      if (sse) sse.close();
      sseFailures = 0;
      sse = new EventSource(url("/api/stream"));
      console.info("[sse] conectado");

      sse.onmessage = (evt) => {
        try{
          const payload = JSON.parse(evt.data);
          if (payload.type === "snapshot"){
            safeRender(payload.records || []);
            firstDataArrived = true;
          }
        }catch(e){ console.error("[sse] parse erro:", e); }
      };
      sse.onerror = () => {
        sseFailures++;
        console.warn("[sse] erro (contagem):", sseFailures);
        if (sseFailures >= 3){ startPolling(); }
        // Garante esconder splash mesmo se SSE não conectar
        clearTimeout(hideTimer);
        hideSplashSoon();
      };
    }catch(e){
      console.warn("[sse] falha ao iniciar, ativando polling", e);
      startPolling();
      clearTimeout(hideTimer);
      hideSplashSoon();
    }
  }

  // ===== Form Add =====
  const form = document.getElementById("formDisparo");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const tipo  = document.getElementById("tipo").value.trim();
    const tempo = Number(document.getElementById("tempo").value);
    const potes = Number(document.getElementById("potes").value);
    const horario = document.getElementById("horario").value;
    if(!tipo) return;

    const optimisticRecord = { id: uid(), tipo, tempo, potes, horario, status:"Em andamento" };
    (lastNonEmpty = lastNonEmpty || []).push(optimisticRecord);
    safeRender(lastNonEmpty);

    if (OFFLINE_MODE) { e.target.reset(); return; }

    if(!isAuthed){
      alert("Faça login para adicionar disparos.");
      // desfaz otimista se não estiver logado
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      safeRender(lastNonEmpty);
      return;
    }

    try{
      const resp = await fetch(url("/api/disparos"), {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify(optimisticRecord)
      });
      if (!resp.ok){
        if (resp.status === 401){
          alert("Sessão expirada. Faça login novamente.");
          isAuthed = false; localStorage.removeItem(AUTH_KEY); updateAuthUI(); switchTab("login");
        }else{
          throw new Error("POST falhou: " + resp.status);
        }
      } else {
        e.target.reset();
        setTimeout(softRefresh, 400);
      }
    }catch(e){
      console.error("Erro ao criar disparo:", e);
      alert("Não consegui salvar no servidor.");
      lastNonEmpty = (lastNonEmpty || []).filter(x => x !== optimisticRecord);
      safeRender(lastNonEmpty);
    }
  });

  // ===== Login / Logout =====
  const loginForm = document.getElementById("loginForm");
  const btnLogout = document.getElementById("btnLogout");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const u = (document.getElementById("loginUser").value || "").trim();
    const p = (document.getElementById("loginPass").value || "").trim();

    // Login local simples
    if (u !== "energia" || p !== "energia1") {
      alert("Usuário ou senha inválidos.");
      return;
    }
    isAuthed = true;
    localStorage.setItem(AUTH_KEY, "1");
    updateAuthUI();
    switchTab("painel");
    setTimeout(softRefresh, 150);
  });

  btnLogout.addEventListener("click", () => {
    isAuthed = false;
    localStorage.removeItem(AUTH_KEY);
    updateAuthUI();
    switchTab("login");

    const u = document.getElementById("loginUser");
    const p = document.getElementById("loginPass");
    if (p) p.value = "";
    if (u) { u.value = ""; u.focus(); }

    stopPolling();
    stopSSE();
    startSSE(); // modo leitura
    setTimeout(softRefresh, 120);

    try { fetch(url("/api/logout"), { method:"POST", credentials:"include" }); } catch {}
  });

  // ===== Start =====
  (async () => {
    switchTab("painel");
    updateAuthUI();

    // Se for arquivo local, já esconde splash (sem backend)
    if (OFFLINE_MODE) {
      clearTimeout(hideTimer);
      hideSplashSoon();
      return; // UI funcional em modo teste
    }

    // Online: começa SSE e fetch inicial com timeout
    startSSE();
    loadInitialWithTimeout(2500);
  })();
  </script>
</body>
</html>
